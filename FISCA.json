[
{
  "model": "desktop.document2",
  "pk": 169752,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "FISCA",
    "description": "",
    "uuid": "a86f6c3d-3609-4f13-ab12-271973ad5b68",
    "type": "directory",
    "connector": null,
    "data": "{}",
    "extra": "",
    "search": null,
    "last_modified": "2025-10-30T08:58:33.767",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "a8280168-7cf2-40b1-bc5d-733014ae6ba9",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 169835,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "FISCA: Criação das Tbls",
    "description": "",
    "uuid": "9fd0e0e2-059a-f7a3-230f-f55c025b838e",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 169835, \"uuid\": \"3b4ff0f3-2d07-4ebb-aa4a-aabe2c7d80db\", \"name\": \"FISCA: Cria\\u00e7\\u00e3o das Tbls\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": \"9fd0e0e2-059a-f7a3-230f-f55c025b838e\", \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"0e25a70a-bfa4-0e2b-738e-313b0f2db313\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Consulta\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": {\"row\": 941, \"column\": 0}, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": true, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"default\", \"currentQueryTab\": \"queryResults\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 3, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"-- ================================================================================\\r\\n-- PROJETO FISCA - AN\\u00c1LISE DE FISCALIZA\\u00c7\\u00d5ES DA RECEITA ESTADUAL DE SC\\r\\n-- VERS\\u00c3O COMPLETA CORRIGIDA - Todas as an\\u00e1lises com campos reais\\r\\n-- ================================================================================\\r\\n-- Objetivo: Analisar o desempenho das fiscaliza\\u00e7\\u00f5es, acompanhamentos e PAFs\\r\\n-- Per\\u00edodo: 2020 at\\u00e9 atual\\r\\n-- Foco: Dashboard de Resultados, M\\u00e9tricas de Performance e Efetividade\\r\\n-- Database: teste.fisca_*\\r\\n-- ================================================================================\\r\\n-- ESTRUTURA REAL IDENTIFICADA:\\r\\n-- 1. fis_infr_fiscal_raw = BASE PRINCIPAL (TIF + Auto de Infra\\u00e7\\u00e3o)\\r\\n-- 2. fis_not_fiscal_raw = Notifica\\u00e7\\u00f5es Fiscais (geradas a partir das infra\\u00e7\\u00f5es)\\r\\n-- 3. fis_termo_inicio_fisc_raw = Registro administrativo secund\\u00e1rio\\r\\n-- 4. fis_termo_encerram_fisc_raw = Termos de encerramento\\r\\n-- 5. Relacionamento: infr_fiscal.id_notificacao_gerada \\u2192 not_fiscal.id_documento\\r\\n-- ================================================================================\\r\\n\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\n-- ================================================================================\\r\\n-- PARTE 1: CADASTRO BASE - EMPRESAS E DADOS CADASTRAIS\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.fisca_empresas_base;\\r\\n\\r\\nCREATE TABLE teste.fisca_empresas_base AS\\r\\nSELECT DISTINCT\\r\\n    REGEXP_REPLACE(TRIM(c.nu_cnpj), '[^0-9]', '') AS cnpj,\\r\\n    c.nu_ie,\\r\\n    c.nm_razao_social,\\r\\n    c.nm_fantasia,\\r\\n    c.cd_sit_cadastral,\\r\\n    c.nm_sit_cadastral,\\r\\n    c.dt_sit_cadastral,\\r\\n    c.cd_natureza_juridica,\\r\\n    c.nm_natureza_juridica,\\r\\n    c.dt_inicio_icms,\\r\\n    c.dt_constituicao_empresa,\\r\\n    c.cd_cnae,\\r\\n    c.de_cnae,\\r\\n    c.cd_secao AS cnae_secao,\\r\\n    c.de_secao AS cnae_secao_descricao,\\r\\n    c.cd_divisao AS cnae_divisao,\\r\\n    c.de_divisao AS cnae_divisao_descricao,\\r\\n    c.cd_grupo AS cnae_grupo,\\r\\n    c.de_grupo AS cnae_grupo_descricao,\\r\\n    c.cd_reg_apuracao,\\r\\n    c.nm_reg_apuracao AS regime_tributario,\\r\\n    c.cd_tipo_contribuinte,\\r\\n    c.nm_tipo_contribuinte,\\r\\n    c.sn_simples_nacional_rfb,\\r\\n    c.cd_usefi,\\r\\n    c.nm_usefi,\\r\\n    c.cd_gerfe,\\r\\n    c.nm_gerfe,\\r\\n    c.nm_ges,\\r\\n    c.cd_munic AS cod_municipio,\\r\\n    c.nm_munic AS municipio,\\r\\n    c.cd_uf AS uf,\\r\\n    c.nm_logradouro,\\r\\n    c.nu_logradouro,\\r\\n    c.nm_bairro,\\r\\n    c.cd_cep,\\r\\n    c.nu_telefone,\\r\\n    c.nm_email,\\r\\n    c.qt_vinculos,\\r\\n    c.qt_vinculos_ativos,\\r\\n    c.qt_socios_ativos\\r\\nFROM usr_sat_ods.vw_ods_contrib c\\r\\nWHERE REGEXP_REPLACE(TRIM(c.nu_cnpj), '[^0-9]', '') IS NOT NULL\\r\\n    AND LENGTH(REGEXP_REPLACE(TRIM(c.nu_cnpj), '[^0-9]', '')) = 14;\\r\\n\\r\\n-- ================================================================================\\r\\n-- PARTE 2: CADASTRO DE AFREs (AUDITORES FISCAIS)\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.fisca_afres_cadastro;\\r\\n\\r\\nCREATE TABLE teste.fisca_afres_cadastro AS\\r\\nSELECT DISTINCT\\r\\n    CAST(aut.cd_matr_afre AS INT) AS matricula_afre,\\r\\n    aut.faf_nome AS nome_afre,\\r\\n    aut.de_cargo AS cargo\\r\\nFROM usr_sat_ods.fis_docto_fiscal_autoridades aut\\r\\nWHERE aut.cd_matr_afre IS NOT NULL\\r\\n    AND aut.faf_nome IS NOT NULL;\\r\\n\\r\\n-- ================================================================================\\r\\n-- PARTE 3: PER\\u00cdODOS ATIVOS DOS AFREs (PARA C\\u00c1LCULO DE PRODUTIVIDADE)\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.fisca_afres_periodos_ativos;\\r\\n\\r\\nCREATE TABLE teste.fisca_afres_periodos_ativos AS\\r\\nSELECT\\r\\n    ap.cd_matricula AS matricula_afre,\\r\\n    ap.nu_ano_ref AS ano,\\r\\n    ap.nu_per_ref AS periodo_aaaamm,\\r\\n    ap.qt_dias_ativa AS dias_ativo_mes,\\r\\n    CASE \\r\\n        WHEN ap.qt_dias_ativa >= 20 THEN 1 \\r\\n        ELSE 0 \\r\\n    END AS mes_completo\\r\\nFROM usr_sat_ods.fis_afre_periodo ap\\r\\nWHERE ap.nu_ano_ref >= 2020\\r\\n    AND ap.qt_dias_ativa > 0;\\r\\n\\r\\n-- ================================================================================\\r\\n-- PARTE 4: ACOMPANHAMENTOS (A\\u00c7\\u00d5ES ANTES DO PAF)\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.fisca_acompanhamentos;\\r\\n\\r\\nCREATE TABLE teste.fisca_acompanhamentos AS\\r\\nSELECT\\r\\n    a.id_documento_os AS id_acompanhamento,\\r\\n    a.nu_documento_os AS numero_os,\\r\\n    a.dt_documento_os AS data_os,\\r\\n    REGEXP_REPLACE(TRIM(a.nu_cnpj), '[^0-9]', '') AS cnpj,\\r\\n    REGEXP_REPLACE(TRIM(a.nu_cpf), '[^0-9]', '') AS cpf,\\r\\n    a.nu_ie,\\r\\n    a.nu_rge_ruc,\\r\\n    a.de_motivo_os AS motivo,\\r\\n    a.nm_estado_os AS estado_os,\\r\\n    a.nu_documento_of AS numero_of,\\r\\n    a.cd_programa,\\r\\n    a.cd_gerencia AS cod_gerencia,\\r\\n    a.cd_usuario_emitente AS matricula_emitente,\\r\\n    a.nm_usuario_emitente AS nome_emitente,\\r\\n    \\r\\n    -- Documento relacionado (se houver)\\r\\n    a.id_documento AS id_documento_relacionado,\\r\\n    a.nu_documento AS numero_documento_relacionado,\\r\\n    a.dt_documento AS data_documento_relacionado,\\r\\n    a.dt_cienc_documento AS data_ciencia_documento,\\r\\n    a.nm_estado_documento AS estado_documento,\\r\\n    a.cd_form_docum AS codigo_tipo_documento,\\r\\n    a.de_form_documento AS tipo_documento,\\r\\n    \\r\\n    -- A\\u00e7\\u00e3o Fiscal\\r\\n    a.nm_estado_acao AS estado_acao,\\r\\n    a.dt_criacao_acao AS data_criacao_acao,\\r\\n    a.nu_prazo_acao AS prazo_dias,\\r\\n    a.dt_encerra_acao AS data_encerramento_acao,\\r\\n    \\r\\n    -- Temporalidade\\r\\n    YEAR(a.dt_documento_os) AS ano_os,\\r\\n    CAST(CONCAT(CAST(YEAR(a.dt_documento_os) AS STRING), \\r\\n                LPAD(CAST(MONTH(a.dt_documento_os) AS STRING), 2, '0')) AS INT) AS periodo_aaaamm,\\r\\n    \\r\\n    -- Indicadores\\r\\n    CASE WHEN a.id_documento IS NOT NULL THEN 1 ELSE 0 END AS gerou_documento,\\r\\n    CASE WHEN a.dt_encerra_acao IS NOT NULL THEN 1 ELSE 0 END AS foi_encerrado,\\r\\n    CASE \\r\\n        WHEN a.dt_encerra_acao IS NOT NULL AND a.dt_criacao_acao IS NOT NULL \\r\\n        THEN DATEDIFF(a.dt_encerra_acao, a.dt_criacao_acao)\\r\\n        ELSE NULL \\r\\n    END AS dias_duracao_acao\\r\\nFROM usr_sat_ods.fis_acomp_raw a\\r\\nWHERE YEAR(a.dt_documento_os) >= 2020\\r\\n    AND (REGEXP_REPLACE(TRIM(a.nu_cnpj), '[^0-9]', '') IS NOT NULL \\r\\n         OR REGEXP_REPLACE(TRIM(a.nu_cpf), '[^0-9]', '') IS NOT NULL);\\r\\n\\r\\n-- ================================================================================\\r\\n-- PARTE 5 (CORRIGIDA): INFRA\\u00c7\\u00d5ES FISCAIS COM ESTADOS NORMALIZADOS\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.fisca_infracoes_base;\\r\\n\\r\\nCREATE TABLE teste.fisca_infracoes_base AS\\r\\nSELECT\\r\\n    inf.id_infr_fiscal AS id_documento,\\r\\n    inf.nu_infr_fiscal AS numero_infracao,\\r\\n    inf.dt_documento AS data_infracao,\\r\\n    \\r\\n    -- Identifica\\u00e7\\u00e3o unificada (CNPJ ou CPF)\\r\\n    REGEXP_REPLACE(TRIM(inf.nu_cnpj), '[^0-9]', '') AS cnpj,\\r\\n    REGEXP_REPLACE(TRIM(inf.nu_cpf), '[^0-9]', '') AS cpf,\\r\\n    inf.nu_ie,\\r\\n    \\r\\n    -- \\u2705 NOVO: Identificador unificado\\r\\n    COALESCE(\\r\\n        CASE WHEN LENGTH(REGEXP_REPLACE(TRIM(inf.nu_cnpj), '[^0-9]', '')) = 14 \\r\\n             THEN REGEXP_REPLACE(TRIM(inf.nu_cnpj), '[^0-9]', '')\\r\\n             ELSE NULL \\r\\n        END,\\r\\n        CASE WHEN LENGTH(REGEXP_REPLACE(TRIM(inf.nu_cpf), '[^0-9]', '')) = 11 \\r\\n             THEN REGEXP_REPLACE(TRIM(inf.nu_cpf), '[^0-9]', '')\\r\\n             ELSE NULL \\r\\n        END\\r\\n    ) AS identificador,\\r\\n    \\r\\n    CASE \\r\\n        WHEN LENGTH(REGEXP_REPLACE(TRIM(inf.nu_cnpj), '[^0-9]', '')) = 14 THEN 'PJ'\\r\\n        WHEN LENGTH(REGEXP_REPLACE(TRIM(inf.nu_cpf), '[^0-9]', '')) = 11 THEN 'PF'\\r\\n        ELSE 'SEM_ID'\\r\\n    END AS tipo_pessoa,\\r\\n    \\r\\n    -- Estado original\\r\\n    inf.nm_estado AS estado_documento,\\r\\n    \\r\\n    -- \\u2705 NOVO: Status normalizado\\r\\n    CASE \\r\\n        WHEN inf.nm_estado IN (\\r\\n            'O documento foi exclu\\u00eddo.',\\r\\n            'EXCLU\\u00cdDA',\\r\\n            'CANCELADA (N\\u00c3O CONVERTIDA EM NOTIF.)'\\r\\n        ) THEN 'CANCELADA'\\r\\n        WHEN inf.nm_estado = 'CONFIRMADA (CONVERTIDA EM NOTIF.)' THEN 'CONVERTIDA'\\r\\n        WHEN inf.nm_estado IN ('Parcelada', 'Quitada Integral') THEN 'REGULARIZADA_SEM_NF'\\r\\n        WHEN inf.nm_estado = 'DEFINITIVO' THEN 'DEFINITIVA'\\r\\n        WHEN inf.nm_estado IN ('INTIMADA', 'INICIAL', 'COMPLETA', \\r\\n                               'Documento aguardando assinatura com certificado digital.') THEN 'EM_ANDAMENTO'\\r\\n        ELSE 'OUTRO'\\r\\n    END AS status_normalizado,\\r\\n    \\r\\n    -- \\u2705 NOVO: Flags de classifica\\u00e7\\u00e3o\\r\\n    CASE \\r\\n        WHEN inf.nm_estado IN (\\r\\n            'O documento foi exclu\\u00eddo.',\\r\\n            'EXCLU\\u00cdDA',\\r\\n            'CANCELADA (N\\u00c3O CONVERTIDA EM NOTIF.)'\\r\\n        ) THEN 0\\r\\n        ELSE 1\\r\\n    END AS eh_valida,\\r\\n    \\r\\n    CASE \\r\\n        WHEN inf.nm_estado IN ('Parcelada', 'Quitada Integral') THEN 1\\r\\n        ELSE 0\\r\\n    END AS eh_regularizada_sem_nf,\\r\\n    \\r\\n    CASE \\r\\n        WHEN inf.nm_estado = 'CONFIRMADA (CONVERTIDA EM NOTIF.)' THEN 1\\r\\n        ELSE 0\\r\\n    END AS eh_confirmada,\\r\\n    \\r\\n    -- Tipo de infra\\u00e7\\u00e3o\\r\\n    inf.cd_infracao AS codigo_infracao,\\r\\n    CAST(inf.cd_infracao AS STRING) AS tipo_infracao,\\r\\n    \\r\\n    -- Valores\\r\\n    inf.vl_imposto AS valor_imposto,\\r\\n    inf.vl_multa AS valor_multa,\\r\\n    inf.vl_juros AS valor_juros,\\r\\n    inf.vl_total AS valor_total,\\r\\n    \\r\\n    -- Defesa Pr\\u00e9via\\r\\n    inf.sn_apresentou_dp AS apresentou_defesa_previa,\\r\\n    inf.dt_dp AS data_apresentacao_dp,\\r\\n    CASE WHEN inf.dt_dp IS NOT NULL THEN 1 ELSE 0 END AS pagou_na_dp,\\r\\n    \\r\\n    -- Ci\\u00eancia\\r\\n    inf.dt_ciencia AS data_ciencia,\\r\\n    inf.de_modo_ciencia AS modo_ciencia,\\r\\n    \\r\\n    -- Julgamento\\r\\n    inf.dt_manifestacao AS data_julgamento,\\r\\n    \\r\\n    -- Relacionamentos\\r\\n    inf.id_tif,\\r\\n    inf.nu_tif,\\r\\n    inf.dt_emissao_tif,\\r\\n    inf.dt_ciencia_tif,\\r\\n    inf.id_notificacao_gerada,\\r\\n    inf.nu_notificacao_gerada,\\r\\n    inf.sn_converter_notificacao,\\r\\n    inf.nu_os,\\r\\n    inf.id_os,\\r\\n    inf.nu_of,\\r\\n    inf.id_of,\\r\\n    inf.cd_usuario_emitente AS matricula_emitente,\\r\\n    \\r\\n    -- Temporalidade\\r\\n    YEAR(inf.dt_documento) AS ano_infracao,\\r\\n    CAST(CONCAT(CAST(YEAR(inf.dt_documento) AS STRING), \\r\\n                LPAD(CAST(MONTH(inf.dt_documento) AS STRING), 2, '0')) AS INT) AS periodo_aaaamm,\\r\\n    \\r\\n    -- Indicadores\\r\\n    CASE WHEN inf.dt_ciencia IS NOT NULL THEN 1 ELSE 0 END AS teve_ciencia,\\r\\n    CASE WHEN inf.dt_manifestacao IS NOT NULL THEN 1 ELSE 0 END AS foi_julgado,\\r\\n    CASE WHEN inf.dt_dp IS NOT NULL THEN 1 ELSE 0 END AS houve_pagamento_dp,\\r\\n    CASE WHEN inf.id_notificacao_gerada IS NOT NULL THEN 1 ELSE 0 END AS gerou_notificacao,\\r\\n    \\r\\n    -- Metadados\\r\\n    inf.dt_inclusao_ods,\\r\\n    inf.dt_ult_atualiz_ods,\\r\\n    inf.nu_versao_sistema\\r\\n    \\r\\nFROM usr_sat_ods.fis_infr_fiscal_raw inf\\r\\nWHERE YEAR(inf.dt_documento) >= 2020\\r\\n    AND (\\r\\n        (REGEXP_REPLACE(TRIM(inf.nu_cnpj), '[^0-9]', '') IS NOT NULL \\r\\n         AND LENGTH(REGEXP_REPLACE(TRIM(inf.nu_cnpj), '[^0-9]', '')) = 14)\\r\\n        OR \\r\\n        (REGEXP_REPLACE(TRIM(inf.nu_cpf), '[^0-9]', '') IS NOT NULL\\r\\n         AND LENGTH(REGEXP_REPLACE(TRIM(inf.nu_cpf), '[^0-9]', '')) = 11)\\r\\n    );\\r\\n\\r\\n\\r\\n-- ================================================================================\\r\\n-- PARTE 6: INFRA\\u00c7\\u00d5ES POR PER\\u00cdODO DE REFER\\u00caNCIA (DETALHAMENTO)\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.fisca_infracoes_detalhadas;\\r\\n\\r\\nCREATE TABLE teste.fisca_infracoes_detalhadas AS\\r\\nSELECT\\r\\n    pr.id_documento,\\r\\n    pr.row_num AS sequencial_infracao,\\r\\n    pr.nu_per_ref AS periodo_referencia,\\r\\n    \\r\\n    -- Valores por per\\u00edodo\\r\\n    pr.vl_bc AS valor_base_calculo,\\r\\n    pr.vl_aliquota AS aliquota,\\r\\n    pr.vl_imposto AS valor_imposto,\\r\\n    pr.vl_multa AS valor_multa,\\r\\n    pr.vl_juros AS valor_juros,\\r\\n    pr.vl_total AS valor_total,\\r\\n    \\r\\n    -- Temporalidade\\r\\n    CAST(LEFT(CAST(pr.nu_per_ref AS STRING), 4) AS INT) AS ano_periodo,\\r\\n    pr.nu_per_ref AS periodo_aaaamm,\\r\\n    pr.dt_vencimento\\r\\n    \\r\\nFROM usr_sat_ods.fis_infr_fiscal_per_ref pr\\r\\nWHERE pr.id_documento IN (\\r\\n    SELECT DISTINCT id_documento \\r\\n    FROM teste.fisca_infracoes_base\\r\\n);\\r\\n\\r\\n-- ================================================================================\\r\\n-- PARTE 7: NOTIFICA\\u00c7\\u00d5ES FISCAIS\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.fisca_notificacoes_fiscais;\\r\\n\\r\\nCREATE TABLE teste.fisca_notificacoes_fiscais AS\\r\\nSELECT\\r\\n    nf.id_documento,\\r\\n    nf.nu_notif_fiscal AS numero_nf,\\r\\n    nf.dt_documento AS data_nf,\\r\\n    \\r\\n    -- Identifica\\u00e7\\u00e3o do contribuinte\\r\\n    REGEXP_REPLACE(TRIM(nf.nu_cnpj), '[^0-9]', '') AS cnpj,\\r\\n    REGEXP_REPLACE(TRIM(nf.nu_cpf), '[^0-9]', '') AS cpf,\\r\\n    nf.nu_ie,\\r\\n    \\r\\n    -- Estado\\r\\n    nf.nm_estado AS estado_documento,\\r\\n    \\r\\n    -- Tipo de notifica\\u00e7\\u00e3o\\r\\n    nf.cd_infracao AS cd_tipo_nf,\\r\\n    CAST(nf.cd_infracao AS STRING) AS tipo_notificacao,\\r\\n    \\r\\n    -- Valores\\r\\n    nf.vl_imposto AS valor_imposto,\\r\\n    nf.vl_multa AS valor_multa,\\r\\n    nf.vl_juros AS valor_juros,\\r\\n    nf.vl_total AS valor_total,\\r\\n    \\r\\n    -- Ci\\u00eancia\\r\\n    nf.dt_ciencia AS data_ciencia,\\r\\n    nf.de_modo_ciencia AS modo_ciencia,\\r\\n    \\r\\n    -- Ordem de Servi\\u00e7o e Of\\u00edcio\\r\\n    nf.nu_os,\\r\\n    nf.id_os,\\r\\n    nf.nu_of,\\r\\n    nf.id_of,\\r\\n    \\r\\n    -- Emitente\\r\\n    nf.cd_usuario_emitente AS matricula_emitente,\\r\\n    \\r\\n    -- Infra\\u00e7\\u00e3o original\\r\\n    nf.id_infr_fiscal_original,\\r\\n    nf.nu_infr_fiscal_original,\\r\\n    \\r\\n    -- Temporalidade\\r\\n    YEAR(nf.dt_documento) AS ano_nf,\\r\\n    CAST(CONCAT(CAST(YEAR(nf.dt_documento) AS STRING), \\r\\n                LPAD(CAST(MONTH(nf.dt_documento) AS STRING), 2, '0')) AS INT) AS periodo_aaaamm,\\r\\n    \\r\\n    -- Indicadores\\r\\n    CASE WHEN nf.dt_ciencia IS NOT NULL THEN 1 ELSE 0 END AS teve_ciencia,\\r\\n    \\r\\n    -- Metadados\\r\\n    nf.dt_inclusao_ods,\\r\\n    nf.dt_ult_atualiz_ods,\\r\\n    nf.nu_versao_sistema\\r\\n    \\r\\nFROM usr_sat_ods.fis_not_fiscal_raw nf\\r\\nWHERE YEAR(nf.dt_documento) >= 2020\\r\\n    AND (REGEXP_REPLACE(TRIM(nf.nu_cnpj), '[^0-9]', '') IS NOT NULL \\r\\n         OR REGEXP_REPLACE(TRIM(nf.nu_cpf), '[^0-9]', '') IS NOT NULL);\\r\\n\\r\\n-- ================================================================================\\r\\n-- PARTE 8: TERMOS DE ENCERRAMENTO DE FISCALIZA\\u00c7\\u00c3O\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.fisca_termos_encerramento;\\r\\n\\r\\nCREATE TABLE teste.fisca_termos_encerramento AS\\r\\nSELECT\\r\\n    te.id_documento,\\r\\n    te.numero_documento,\\r\\n    te.nu_termo_encerramento,\\r\\n    te.dt_documento AS data_documento,\\r\\n    te.data_emissao,\\r\\n    REGEXP_REPLACE(TRIM(te.nu_cnpj), '[^0-9]', '') AS cnpj,\\r\\n    REGEXP_REPLACE(TRIM(te.nu_cpf), '[^0-9]', '') AS cpf,\\r\\n    te.nu_ie,\\r\\n    te.ruc,\\r\\n    te.bdo_rge_ruc,\\r\\n    te.nm_razao_social,\\r\\n    te.nm_estado AS estado_documento,\\r\\n    te.situacao,\\r\\n    te.cd_usuario_emitente AS matricula_emitente,\\r\\n    \\r\\n    -- Dados do encerramento\\r\\n    te.dt_encerramento AS data_encerramento,\\r\\n    te.os,\\r\\n    te.os_com_resultados,\\r\\n    te.tx_verificacoes AS verificacoes_realizadas,\\r\\n    te.texto_livre,\\r\\n    te.documentos_retidos,\\r\\n    \\r\\n    -- Ci\\u00eancia\\r\\n    te.dt_ciencia AS data_ciencia,\\r\\n    te.modo_ciencia,\\r\\n    te.ar_ciencia,\\r\\n    te.nm_responsavel_ciencia AS responsavel_ciencia,\\r\\n    te.nm_cargo_ciencia AS cargo_ciencia,\\r\\n    te.nu_cpf_ciencia AS cpf_ciencia,\\r\\n    te.ciencia_doe,\\r\\n    te.edital,\\r\\n    \\r\\n    -- Localiza\\u00e7\\u00e3o\\r\\n    te.cd_gereg,\\r\\n    te.tx_endereco AS endereco,\\r\\n    te.cd_programa,\\r\\n    te.nm_programa AS programa,\\r\\n    \\r\\n    -- Temporalidade\\r\\n    YEAR(te.dt_documento) AS ano_encerramento,\\r\\n    CAST(CONCAT(CAST(YEAR(te.dt_documento) AS STRING), \\r\\n                LPAD(CAST(MONTH(te.dt_documento) AS STRING), 2, '0')) AS INT) AS periodo_aaaamm,\\r\\n    \\r\\n    -- Indicadores\\r\\n    CASE WHEN te.dt_ciencia IS NOT NULL THEN 1 ELSE 0 END AS teve_ciencia,\\r\\n    CASE WHEN te.os_com_resultados = 'SIM' THEN 1 ELSE 0 END AS teve_resultados,\\r\\n    \\r\\n    te.dt_inclusao_ods,\\r\\n    te.dt_alteracao_ods,\\r\\n    te.nu_versao_sistema\\r\\nFROM usr_sat_ods.fis_termo_encerram_fisc_raw te\\r\\nWHERE YEAR(te.dt_documento) >= 2020\\r\\n    AND (REGEXP_REPLACE(TRIM(te.nu_cnpj), '[^0-9]', '') IS NOT NULL \\r\\n         OR REGEXP_REPLACE(TRIM(te.nu_cpf), '[^0-9]', '') IS NOT NULL);\\r\\n\\r\\n-- ================================================================================\\r\\n-- PARTE 9: AUTORIDADES (AFREs) POR DOCUMENTO FISCAL\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.fisca_afres_por_documento;\\r\\n\\r\\nCREATE TABLE teste.fisca_afres_por_documento AS\\r\\nWITH documentos_validos AS (\\r\\n    SELECT id_documento FROM teste.fisca_infracoes_base\\r\\n    UNION\\r\\n    SELECT id_documento FROM teste.fisca_notificacoes_fiscais\\r\\n    UNION\\r\\n    SELECT id_documento FROM teste.fisca_termos_encerramento\\r\\n)\\r\\nSELECT\\r\\n    aut.id_documento,\\r\\n    CAST(aut.cd_matr_afre AS INT) AS matricula_afre,\\r\\n    aut.faf_nome AS nome_afre,\\r\\n    aut.de_cargo AS cargo,\\r\\n    aut.vl_perc_partic AS percentual_participacao,\\r\\n    aut.sn_coordenador AS eh_coordenador\\r\\nFROM usr_sat_ods.fis_docto_fiscal_autoridades aut\\r\\nINNER JOIN documentos_validos dv\\r\\n    ON aut.id_documento = dv.id_documento;\\r\\n\\r\\n-- ================================================================================\\r\\n-- PARTE 10: TABELA DE INFRA\\u00c7\\u00d5ES (CAT\\u00c1LOGO)\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.fisca_catalogo_infracoes;\\r\\n\\r\\nCREATE TABLE teste.fisca_catalogo_infracoes AS\\r\\nSELECT\\r\\n    ti.cd_infracao AS codigo_infracao,\\r\\n    ti.de_infracao AS descricao_infracao,\\r\\n    ti.cd_tipo_infracao AS codigo_tipo_infracao,\\r\\n    ti.de_tipo_infracao AS tipo_infracao,\\r\\n    ti.nm_tributo AS nome_tributo,\\r\\n    ti.vl_multa AS valor_multa_padrao,\\r\\n    ti.sn_apres_dp AS permite_defesa_previa,\\r\\n    ti.sn_pagamento_dp AS permite_pagamento_dp,\\r\\n    ti.vl_perc_red_dp AS percentual_reducao_dp_padrao,\\r\\n    ti.vl_perc_multa_minima AS percentual_multa_minima,\\r\\n    ti.tx_historico_infracao AS historico_infracao,\\r\\n    ti.tx_fund_legal_infracao AS fundamento_legal_infracao,\\r\\n    ti.tx_fund_legal_multa AS fundamento_legal_multa,\\r\\n    ti.tx_fund_legal_atualizacao AS fundamento_legal_atualizacao,\\r\\n    ti.tx_fund_legal_juros AS fundamento_legal_juros,\\r\\n    ti.tx_motivo_representacao AS motivo_representacao,\\r\\n    ti.tx_rol_conta_corrente AS rol_conta_corrente,\\r\\n    ti.dt_inclusao_ods,\\r\\n    ti.dt_ult_atualiz_ods\\r\\nFROM usr_sat_ods.fis_tabela_infracoes ti;\\r\\n\\r\\n-- ================================================================================\\r\\n-- PARTE 11: CONSOLIDA\\u00c7\\u00c3O - FISCALIZA\\u00c7\\u00d5ES COMPLETAS (COM FILTRO DE ESTADO)\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.fisca_fiscalizacoes_consolidadas;\\r\\n\\r\\nCREATE TABLE teste.fisca_fiscalizacoes_consolidadas AS\\r\\nSELECT\\r\\n    inf.id_documento,\\r\\n    inf.cnpj,\\r\\n    inf.cpf,\\r\\n    inf.identificador,  -- \\u2705 NOVO\\r\\n    inf.tipo_pessoa,    -- \\u2705 NOVO\\r\\n    inf.nu_ie,\\r\\n    \\r\\n    -- Dados cadastrais da empresa\\r\\n    eb.nm_razao_social,\\r\\n    eb.nm_fantasia,\\r\\n    eb.regime_tributario,\\r\\n    eb.nm_tipo_contribuinte,\\r\\n    eb.cnae_secao,\\r\\n    eb.cnae_secao_descricao,\\r\\n    eb.cnae_divisao,\\r\\n    eb.cnae_divisao_descricao,\\r\\n    eb.de_cnae AS cnae_descricao,\\r\\n    eb.municipio,\\r\\n    eb.uf,\\r\\n    eb.nm_usefi AS usefi,\\r\\n    eb.nm_gerfe AS gerfe,\\r\\n    eb.nm_ges,\\r\\n    \\r\\n    -- \\u2705 NOVO: Estados e flags\\r\\n    inf.estado_documento,\\r\\n    inf.status_normalizado,\\r\\n    inf.eh_valida,\\r\\n    inf.eh_regularizada_sem_nf,\\r\\n    inf.eh_confirmada,\\r\\n    \\r\\n    -- Auto de Infra\\u00e7\\u00e3o (BASE)\\r\\n    inf.numero_infracao,\\r\\n    inf.data_infracao,\\r\\n    inf.tipo_infracao,\\r\\n    inf.valor_imposto AS valor_imposto_infracao,\\r\\n    inf.valor_multa AS valor_multa_infracao,\\r\\n    inf.valor_juros AS valor_juros_infracao,\\r\\n    inf.valor_total AS valor_total_infracao,\\r\\n    inf.apresentou_defesa_previa AS apresentou_dp_infracao,\\r\\n    inf.data_apresentacao_dp AS data_dp_infracao,\\r\\n    inf.pagou_na_dp AS pagou_dp_infracao,\\r\\n    inf.data_ciencia AS data_ciencia_infracao,\\r\\n    inf.modo_ciencia AS modo_ciencia_infracao,\\r\\n    inf.data_julgamento AS data_julgamento_infracao,\\r\\n    \\r\\n    -- Notifica\\u00e7\\u00e3o Fiscal (se houver)\\r\\n    nf.numero_nf,\\r\\n    nf.data_nf,\\r\\n    nf.tipo_notificacao,\\r\\n    nf.valor_imposto AS valor_imposto_nf,\\r\\n    nf.valor_multa AS valor_multa_nf,\\r\\n    nf.valor_juros AS valor_juros_nf,\\r\\n    nf.valor_total AS valor_total_nf,\\r\\n    nf.data_ciencia AS data_ciencia_nf,\\r\\n    \\r\\n    -- Termo de Encerramento (se houver)\\r\\n    te.numero_documento AS numero_termo_encerramento,\\r\\n    te.data_encerramento,\\r\\n    te.teve_resultados,\\r\\n    te.verificacoes_realizadas,\\r\\n    te.data_ciencia AS data_ciencia_encerramento,\\r\\n    \\r\\n    -- Temporalidade\\r\\n    inf.ano_infracao,\\r\\n    inf.periodo_aaaamm AS periodo_infracao,\\r\\n    \\r\\n    -- Indicadores de ciclo completo\\r\\n    inf.gerou_notificacao,\\r\\n    CASE WHEN te.id_documento IS NOT NULL THEN 1 ELSE 0 END AS teve_encerramento,\\r\\n    CASE WHEN nf.id_documento IS NOT NULL AND te.id_documento IS NOT NULL THEN 1 ELSE 0 END AS ciclo_completo,\\r\\n    \\r\\n    -- Tempo entre etapas (em dias)\\r\\n    CASE \\r\\n        WHEN nf.data_nf IS NOT NULL AND inf.data_infracao IS NOT NULL \\r\\n        THEN DATEDIFF(nf.data_nf, inf.data_infracao)\\r\\n        ELSE NULL \\r\\n    END AS dias_infracao_ate_nf,\\r\\n    \\r\\n    CASE \\r\\n        WHEN te.data_encerramento IS NOT NULL AND inf.data_infracao IS NOT NULL \\r\\n        THEN DATEDIFF(te.data_encerramento, inf.data_infracao)\\r\\n        ELSE NULL \\r\\n    END AS dias_infracao_ate_encerramento,\\r\\n    \\r\\n    -- Situa\\u00e7\\u00e3o final\\r\\n    CASE\\r\\n        WHEN inf.eh_valida = 0 THEN 'CANCELADA'\\r\\n        WHEN inf.eh_regularizada_sem_nf = 1 THEN 'REGULARIZADA SEM NF'\\r\\n        WHEN nf.id_documento IS NOT NULL AND te.teve_resultados = 1 THEN 'NOTIFICADO COM RESULTADOS'\\r\\n        WHEN nf.id_documento IS NOT NULL THEN 'NOTIFICADO SEM RESULTADOS'\\r\\n        WHEN te.teve_resultados = 1 THEN 'ENCERRADO COM RESULTADOS'\\r\\n        WHEN te.id_documento IS NOT NULL THEN 'ENCERRADO SEM RESULTADOS'\\r\\n        ELSE 'EM ANDAMENTO'\\r\\n    END AS situacao_final\\r\\n    \\r\\nFROM teste.fisca_infracoes_base inf\\r\\n\\r\\nLEFT JOIN teste.fisca_empresas_base eb\\r\\n    ON inf.identificador = eb.cnpj  -- \\u2705 Usar identificador para pegar PJ e PF\\r\\n\\r\\nLEFT JOIN teste.fisca_notificacoes_fiscais nf\\r\\n    ON inf.id_notificacao_gerada = nf.id_documento\\r\\n\\r\\nLEFT JOIN teste.fisca_termos_encerramento te\\r\\n    ON inf.nu_os = te.os\\r\\n\\r\\nORDER BY inf.data_infracao DESC;\\r\\n\\r\\n-- ================================================================================\\r\\n-- PARTE 12: M\\u00c9TRICAS POR AFRE (PRODUTIVIDADE INDIVIDUAL)\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.fisca_metricas_por_afre;\\r\\n\\r\\nCREATE TABLE teste.fisca_metricas_por_afre AS\\r\\nWITH\\r\\n-- Infra\\u00e7\\u00f5es por AFRE\\r\\ninfracoes_afre AS (\\r\\n    SELECT\\r\\n        a.matricula_afre,\\r\\n        a.nome_afre,\\r\\n        YEAR(inf.data_infracao) AS ano,\\r\\n        COUNT(DISTINCT inf.id_documento) AS qtd_infracoes,\\r\\n        COUNT(DISTINCT inf.cnpj) AS qtd_empresas_fiscalizadas,\\r\\n        SUM(CASE WHEN inf.data_ciencia_infracao IS NOT NULL THEN 1 ELSE 0 END) AS qtd_infracoes_com_ciencia,\\r\\n        SUM(COALESCE(inf.valor_total_infracao, 0)) AS valor_total_infracoes\\r\\n    FROM teste.fisca_afres_por_documento a\\r\\n    INNER JOIN teste.fisca_fiscalizacoes_consolidadas inf\\r\\n        ON a.id_documento = inf.id_documento\\r\\n    WHERE a.eh_coordenador = 0\\r\\n    GROUP BY a.matricula_afre, a.nome_afre, YEAR(inf.data_infracao)\\r\\n),\\r\\n-- NFs por AFRE\\r\\nnfs_afre AS (\\r\\n    SELECT\\r\\n        a.matricula_afre,\\r\\n        YEAR(fc.data_nf) AS ano,\\r\\n        COUNT(DISTINCT fc.numero_nf) AS qtd_nfs,\\r\\n        SUM(COALESCE(fc.valor_total_nf, 0)) AS valor_total_lancado\\r\\n    FROM teste.fisca_afres_por_documento a\\r\\n    INNER JOIN teste.fisca_fiscalizacoes_consolidadas fc\\r\\n        ON a.id_documento = fc.id_documento\\r\\n    WHERE a.eh_coordenador = 0\\r\\n        AND fc.gerou_notificacao = 1\\r\\n    GROUP BY a.matricula_afre, YEAR(fc.data_nf)\\r\\n),\\r\\n-- Per\\u00edodos ativos por AFRE\\r\\nperiodos_ativos AS (\\r\\n    SELECT\\r\\n        matricula_afre,\\r\\n        ano,\\r\\n        SUM(mes_completo) AS meses_completos_ativos,\\r\\n        SUM(dias_ativo_mes) AS total_dias_ativos\\r\\n    FROM teste.fisca_afres_periodos_ativos\\r\\n    WHERE ano >= 2020\\r\\n    GROUP BY matricula_afre, ano\\r\\n)\\r\\n\\r\\nSELECT\\r\\n    COALESCE(i.matricula_afre, n.matricula_afre, p.matricula_afre) AS matricula_afre,\\r\\n    i.nome_afre,\\r\\n    COALESCE(i.ano, n.ano, p.ano) AS ano,\\r\\n    \\r\\n    -- Dados de atividade\\r\\n    COALESCE(p.meses_completos_ativos, 0) AS meses_ativos,\\r\\n    COALESCE(p.total_dias_ativos, 0) AS dias_ativos,\\r\\n    \\r\\n    -- Infra\\u00e7\\u00f5es\\r\\n    COALESCE(i.qtd_infracoes, 0) AS qtd_infracoes,\\r\\n    COALESCE(i.qtd_empresas_fiscalizadas, 0) AS qtd_empresas_fiscalizadas,\\r\\n    COALESCE(i.qtd_infracoes_com_ciencia, 0) AS qtd_infracoes_com_ciencia,\\r\\n    COALESCE(i.valor_total_infracoes, 0) AS valor_total_infracoes,\\r\\n    \\r\\n    -- NFs\\r\\n    COALESCE(n.qtd_nfs, 0) AS qtd_nfs,\\r\\n    COALESCE(n.valor_total_lancado, 0) AS valor_total_lancado,\\r\\n    \\r\\n    -- M\\u00e9tricas calculadas\\r\\n    CASE \\r\\n        WHEN p.meses_completos_ativos > 0 \\r\\n        THEN ROUND(COALESCE(i.qtd_infracoes, 0) * 1.0 / p.meses_completos_ativos, 2)\\r\\n        ELSE 0 \\r\\n    END AS infracoes_por_mes,\\r\\n    \\r\\n    CASE \\r\\n        WHEN p.meses_completos_ativos > 0 \\r\\n        THEN ROUND(COALESCE(n.qtd_nfs, 0) * 1.0 / p.meses_completos_ativos, 2)\\r\\n        ELSE 0 \\r\\n    END AS nfs_por_mes,\\r\\n    \\r\\n    CASE \\r\\n        WHEN i.qtd_infracoes > 0 \\r\\n        THEN ROUND((COALESCE(n.qtd_nfs, 0) * 100.0) / i.qtd_infracoes, 2)\\r\\n        ELSE 0 \\r\\n    END AS taxa_conversao_infracao_nf,\\r\\n    \\r\\n    CASE \\r\\n        WHEN p.meses_completos_ativos > 0 \\r\\n        THEN ROUND(COALESCE(i.valor_total_infracoes, 0) / p.meses_completos_ativos, 2)\\r\\n        ELSE 0 \\r\\n    END AS valor_medio_mensal\\r\\n\\r\\nFROM infracoes_afre i\\r\\nFULL OUTER JOIN nfs_afre n\\r\\n    ON i.matricula_afre = n.matricula_afre AND i.ano = n.ano\\r\\nFULL OUTER JOIN periodos_ativos p\\r\\n    ON COALESCE(i.matricula_afre, n.matricula_afre) = p.matricula_afre \\r\\n    AND COALESCE(i.ano, n.ano) = p.ano\\r\\n\\r\\nORDER BY ano DESC, qtd_nfs DESC;\\r\\n\\r\\n-- ================================================================================\\r\\n-- PARTE 13: M\\u00c9TRICAS POR GER\\u00caNCIA (GRAF)\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.fisca_metricas_por_gerencia;\\r\\n\\r\\nCREATE TABLE teste.fisca_metricas_por_gerencia AS\\r\\nSELECT\\r\\n    fc.gerfe,\\r\\n    fc.ano_infracao AS ano,\\r\\n    \\r\\n    -- Quantidade de fiscaliza\\u00e7\\u00f5es\\r\\n    COUNT(DISTINCT fc.id_documento) AS qtd_fiscalizacoes,\\r\\n    COUNT(DISTINCT fc.cnpj) AS qtd_empresas_unicas,\\r\\n    \\r\\n    -- Infra\\u00e7\\u00f5es\\r\\n    COUNT(DISTINCT fc.numero_infracao) AS qtd_infracoes,\\r\\n    SUM(CASE WHEN fc.data_ciencia_infracao IS NOT NULL THEN 1 ELSE 0 END) AS qtd_infracoes_com_ciencia,\\r\\n    \\r\\n    -- Valores das infra\\u00e7\\u00f5es\\r\\n    SUM(COALESCE(fc.valor_total_infracao, 0)) AS valor_total_infracoes,\\r\\n    SUM(COALESCE(fc.valor_imposto_infracao, 0)) AS valor_imposto_infracoes,\\r\\n    SUM(COALESCE(fc.valor_multa_infracao, 0)) AS valor_multa_infracoes,\\r\\n    \\r\\n    -- Notifica\\u00e7\\u00f5es\\r\\n    SUM(fc.gerou_notificacao) AS qtd_nfs,\\r\\n    SUM(COALESCE(fc.valor_total_nf, 0)) AS valor_total_lancado,\\r\\n    \\r\\n    -- Encerramentos\\r\\n    SUM(fc.teve_encerramento) AS qtd_encerramentos,\\r\\n    SUM(fc.teve_resultados) AS qtd_encerramentos_com_resultado,\\r\\n    SUM(fc.ciclo_completo) AS qtd_ciclos_completos,\\r\\n    \\r\\n    -- Tempos m\\u00e9dios\\r\\n    AVG(fc.dias_infracao_ate_nf) AS media_dias_infracao_nf,\\r\\n    AVG(fc.dias_infracao_ate_encerramento) AS media_dias_infracao_encerramento,\\r\\n    \\r\\n    -- Taxas de convers\\u00e3o\\r\\n    CASE \\r\\n        WHEN COUNT(DISTINCT fc.numero_infracao) > 0 \\r\\n        THEN ROUND((SUM(fc.gerou_notificacao) * 100.0) / COUNT(DISTINCT fc.numero_infracao), 2)\\r\\n        ELSE 0 \\r\\n    END AS taxa_conversao_infracao_nf,\\r\\n    \\r\\n    -- Valores m\\u00e9dios\\r\\n    CASE \\r\\n        WHEN COUNT(DISTINCT fc.id_documento) > 0 \\r\\n        THEN ROUND(SUM(COALESCE(fc.valor_total_infracao, 0)) / COUNT(DISTINCT fc.id_documento), 2)\\r\\n        ELSE 0 \\r\\n    END AS valor_medio_infracao\\r\\n\\r\\nFROM teste.fisca_fiscalizacoes_consolidadas fc\\r\\nWHERE fc.gerfe IS NOT NULL\\r\\n  AND fc.eh_valida = 1\\r\\nGROUP BY fc.gerfe, fc.ano_infracao\\r\\nORDER BY fc.gerfe, ano DESC;\\r\\n\\r\\n-- ================================================================================\\r\\n-- PARTE 14: M\\u00c9TRICAS POR CNAE\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.fisca_metricas_por_cnae;\\r\\n\\r\\nCREATE TABLE teste.fisca_metricas_por_cnae AS\\r\\nSELECT\\r\\n    fc.cnae_secao,\\r\\n    fc.cnae_secao_descricao,\\r\\n    fc.cnae_divisao,\\r\\n    fc.cnae_divisao_descricao,\\r\\n    fc.ano_infracao AS ano,\\r\\n    \\r\\n    -- Quantidade\\r\\n    COUNT(DISTINCT fc.id_documento) AS qtd_fiscalizacoes,\\r\\n    COUNT(DISTINCT fc.cnpj) AS qtd_empresas_unicas,\\r\\n    SUM(fc.gerou_notificacao) AS qtd_nfs,\\r\\n    \\r\\n    -- Valores\\r\\n    SUM(COALESCE(fc.valor_total_infracao, 0)) AS valor_total_infracoes,\\r\\n    SUM(COALESCE(fc.valor_imposto_infracao, 0)) AS valor_imposto,\\r\\n    SUM(COALESCE(fc.valor_multa_infracao, 0)) AS valor_multa,\\r\\n    SUM(COALESCE(fc.valor_total_nf, 0)) AS valor_total_nfs,\\r\\n    \\r\\n    -- Taxas\\r\\n    CASE \\r\\n        WHEN COUNT(DISTINCT fc.id_documento) > 0 \\r\\n        THEN ROUND((SUM(fc.gerou_notificacao) * 100.0) / COUNT(DISTINCT fc.id_documento), 2)\\r\\n        ELSE 0 \\r\\n    END AS taxa_conversao_infracao_nf,\\r\\n    \\r\\n    -- Valores m\\u00e9dios\\r\\n    CASE \\r\\n        WHEN COUNT(DISTINCT fc.id_documento) > 0 \\r\\n        THEN ROUND(SUM(COALESCE(fc.valor_total_infracao, 0)) / COUNT(DISTINCT fc.id_documento), 2)\\r\\n        ELSE 0 \\r\\n    END AS valor_medio_infracao,\\r\\n    \\r\\n    CASE \\r\\n        WHEN SUM(fc.gerou_notificacao) > 0 \\r\\n        THEN ROUND(SUM(COALESCE(fc.valor_total_nf, 0)) / SUM(fc.gerou_notificacao), 2)\\r\\n        ELSE 0 \\r\\n    END AS valor_medio_nf\\r\\n\\r\\nFROM teste.fisca_fiscalizacoes_consolidadas fc\\r\\nWHERE fc.cnae_secao IS NOT NULL\\r\\n  AND fc.eh_valida = 1\\r\\nGROUP BY fc.cnae_secao, fc.cnae_secao_descricao, fc.cnae_divisao, fc.cnae_divisao_descricao, fc.ano_infracao\\r\\nORDER BY ano DESC, qtd_fiscalizacoes DESC;\\r\\n\\r\\n-- ================================================================================\\r\\n-- PARTE 15: M\\u00c9TRICAS POR MUNIC\\u00cdPIO\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.fisca_metricas_por_municipio;\\r\\n\\r\\nCREATE TABLE teste.fisca_metricas_por_municipio AS\\r\\nSELECT\\r\\n    fc.municipio,\\r\\n    fc.uf,\\r\\n    fc.ano_infracao AS ano,\\r\\n    \\r\\n    -- Quantidade\\r\\n    COUNT(DISTINCT fc.id_documento) AS qtd_fiscalizacoes,\\r\\n    COUNT(DISTINCT fc.cnpj) AS qtd_empresas_unicas,\\r\\n    SUM(fc.gerou_notificacao) AS qtd_nfs,\\r\\n    \\r\\n    -- Valores\\r\\n    SUM(COALESCE(fc.valor_total_infracao, 0)) AS valor_total_infracoes,\\r\\n    SUM(COALESCE(fc.valor_total_nf, 0)) AS valor_total_nfs,\\r\\n    \\r\\n    -- Taxas\\r\\n    CASE \\r\\n        WHEN COUNT(DISTINCT fc.id_documento) > 0 \\r\\n        THEN ROUND((SUM(fc.gerou_notificacao) * 100.0) / COUNT(DISTINCT fc.id_documento), 2)\\r\\n        ELSE 0 \\r\\n    END AS taxa_conversao_infracao_nf\\r\\n\\r\\nFROM teste.fisca_fiscalizacoes_consolidadas fc\\r\\nWHERE fc.municipio IS NOT NULL\\r\\n  AND fc.eh_valida = 1\\r\\nGROUP BY fc.municipio, fc.uf, fc.ano_infracao\\r\\nORDER BY ano DESC, qtd_fiscalizacoes DESC;\\r\\n\\r\\n-- ================================================================================\\r\\n-- PARTE 16: AN\\u00c1LISE DE INFRA\\u00c7\\u00d5ES (VERS\\u00c3O FINAL CORRIGIDA)\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.fisca_ranking_infracoes;\\r\\n\\r\\nCREATE TABLE teste.fisca_ranking_infracoes AS\\r\\nWITH infracoes_com_dados AS (\\r\\n    SELECT\\r\\n        inf.id_documento,\\r\\n        inf.periodo_referencia,\\r\\n        inf.valor_base_calculo,\\r\\n        \\r\\n        -- \\u2705 CALCULAR valor_total se estiver NULL\\r\\n        COALESCE(inf.valor_imposto, 0) AS valor_imposto,\\r\\n        COALESCE(inf.valor_multa, 0) AS valor_multa,\\r\\n        COALESCE(inf.valor_juros, 0) AS valor_juros,\\r\\n        COALESCE(\\r\\n            inf.valor_total,\\r\\n            COALESCE(inf.valor_imposto, 0) + COALESCE(inf.valor_multa, 0) + COALESCE(inf.valor_juros, 0)\\r\\n        ) AS valor_total_calculado,\\r\\n        \\r\\n        fc.ano_infracao,\\r\\n        fc.identificador,\\r\\n        fc.tipo_infracao,\\r\\n        fc.cnae_secao,\\r\\n        fc.cnae_secao_descricao,\\r\\n        fc.regime_tributario,\\r\\n        fc.municipio,\\r\\n        fc.nm_ges\\r\\n    FROM teste.fisca_infracoes_detalhadas inf\\r\\n    INNER JOIN teste.fisca_fiscalizacoes_consolidadas fc\\r\\n        ON inf.id_documento = fc.id_documento\\r\\n    WHERE fc.eh_valida = 1\\r\\n)\\r\\n\\r\\nSELECT\\r\\n    i.tipo_infracao AS codigo_infracao,\\r\\n    cat.descricao_infracao,\\r\\n    cat.tipo_infracao AS tipo_infracao_descricao,\\r\\n    i.ano_infracao AS ano,\\r\\n    \\r\\n    -- Quantidade\\r\\n    COUNT(*) AS qtd_ocorrencias,\\r\\n    COUNT(DISTINCT i.identificador) AS qtd_empresas,\\r\\n    COUNT(DISTINCT i.id_documento) AS qtd_documentos,\\r\\n    \\r\\n    -- \\u2705 Valores CALCULADOS\\r\\n    SUM(i.valor_total_calculado) AS valor_total,\\r\\n    SUM(i.valor_imposto) AS valor_imposto,\\r\\n    SUM(i.valor_multa) AS valor_multa,\\r\\n    SUM(i.valor_juros) AS valor_juros,\\r\\n    ROUND(AVG(i.valor_total_calculado), 2) AS valor_medio\\r\\n\\r\\nFROM infracoes_com_dados i\\r\\nLEFT JOIN teste.fisca_catalogo_infracoes cat\\r\\n    ON i.tipo_infracao = CAST(cat.codigo_infracao AS STRING)\\r\\nWHERE i.ano_infracao >= 2020\\r\\n    AND i.tipo_infracao IS NOT NULL\\r\\nGROUP BY \\r\\n    i.tipo_infracao,\\r\\n    cat.descricao_infracao, \\r\\n    cat.tipo_infracao,\\r\\n    i.ano_infracao\\r\\nORDER BY ano DESC, qtd_ocorrencias DESC;\\r\\n\\r\\n-- ================================================================================\\r\\n-- PARTE 17: SCORE DE EFETIVIDADE DA FISCALIZA\\u00c7\\u00c3O\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.fisca_scores_efetividade;\\r\\n\\r\\nCREATE TABLE teste.fisca_scores_efetividade AS\\r\\nWITH metricas_base AS (\\r\\n    SELECT\\r\\n        fc.id_documento,\\r\\n        fc.cnpj,\\r\\n        fc.nm_razao_social,\\r\\n        fc.gerfe,\\r\\n        fc.municipio,\\r\\n        fc.cnae_secao_descricao,\\r\\n        fc.regime_tributario,\\r\\n        fc.ano_infracao,\\r\\n        \\r\\n        -- Indicadores bin\\u00e1rios\\r\\n        fc.gerou_notificacao,\\r\\n        fc.teve_encerramento,\\r\\n        fc.ciclo_completo,\\r\\n        \\r\\n        -- Valores\\r\\n        COALESCE(fc.valor_total_infracao, 0) AS valor_total_infracao,\\r\\n        COALESCE(fc.valor_total_nf, 0) AS valor_total_nf,\\r\\n        \\r\\n        -- Tempos\\r\\n        fc.dias_infracao_ate_nf,\\r\\n        \\r\\n        -- Percentual notificado\\r\\n        CASE \\r\\n            WHEN fc.valor_total_infracao > 0 \\r\\n            THEN (fc.valor_total_nf * 100.0) / fc.valor_total_infracao\\r\\n            ELSE 0 \\r\\n        END AS perc_valor_notificado\\r\\n    FROM teste.fisca_fiscalizacoes_consolidadas fc\\r\\n)\\r\\n\\r\\nSELECT\\r\\n    m.*,\\r\\n    \\r\\n    -- Score 1: Gera\\u00e7\\u00e3o de Notifica\\u00e7\\u00e3o (0-100)\\r\\n    CASE WHEN m.gerou_notificacao = 1 THEN 100 ELSE 0 END AS score_geracao_nf,\\r\\n    \\r\\n    -- Score 2: Ciclo Completo (0-100)\\r\\n    CASE \\r\\n        WHEN m.ciclo_completo = 1 THEN 100\\r\\n        WHEN m.teve_encerramento = 1 THEN 50\\r\\n        ELSE 0 \\r\\n    END AS score_ciclo,\\r\\n    \\r\\n    -- Score 3: Valor Notificado (0-100)\\r\\n    CASE\\r\\n        WHEN m.perc_valor_notificado >= 80 THEN 100\\r\\n        WHEN m.perc_valor_notificado >= 60 THEN 80\\r\\n        WHEN m.perc_valor_notificado >= 40 THEN 60\\r\\n        WHEN m.perc_valor_notificado >= 20 THEN 40\\r\\n        WHEN m.perc_valor_notificado > 0 THEN 20\\r\\n        ELSE 0\\r\\n    END AS score_valor_notificado,\\r\\n    \\r\\n    -- Score 4: Tempestividade (0-100)\\r\\n    CASE\\r\\n        WHEN m.dias_infracao_ate_nf IS NULL THEN 0\\r\\n        WHEN m.dias_infracao_ate_nf <= 60 THEN 100\\r\\n        WHEN m.dias_infracao_ate_nf <= 120 THEN 80\\r\\n        WHEN m.dias_infracao_ate_nf <= 180 THEN 60\\r\\n        WHEN m.dias_infracao_ate_nf <= 365 THEN 40\\r\\n        ELSE 20\\r\\n    END AS score_tempestividade,\\r\\n    \\r\\n    -- Score Final (m\\u00e9dia ponderada)\\r\\n    ROUND(\\r\\n        (CASE WHEN m.gerou_notificacao = 1 THEN 100 ELSE 0 END * 0.30) +\\r\\n        (CASE \\r\\n            WHEN m.ciclo_completo = 1 THEN 100\\r\\n            WHEN m.teve_encerramento = 1 THEN 50\\r\\n            ELSE 0 \\r\\n        END * 0.20) +\\r\\n        (CASE\\r\\n            WHEN m.perc_valor_notificado >= 80 THEN 100\\r\\n            WHEN m.perc_valor_notificado >= 60 THEN 80\\r\\n            WHEN m.perc_valor_notificado >= 40 THEN 60\\r\\n            WHEN m.perc_valor_notificado >= 20 THEN 40\\r\\n            WHEN m.perc_valor_notificado > 0 THEN 20\\r\\n            ELSE 0\\r\\n        END * 0.30) +\\r\\n        (CASE\\r\\n            WHEN m.dias_infracao_ate_nf IS NULL THEN 0\\r\\n            WHEN m.dias_infracao_ate_nf <= 60 THEN 100\\r\\n            WHEN m.dias_infracao_ate_nf <= 120 THEN 80\\r\\n            WHEN m.dias_infracao_ate_nf <= 180 THEN 60\\r\\n            WHEN m.dias_infracao_ate_nf <= 365 THEN 40\\r\\n            ELSE 20\\r\\n        END * 0.20),\\r\\n    2) AS score_efetividade_final,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o\\r\\n    CASE\\r\\n        WHEN ROUND(\\r\\n            (CASE WHEN m.gerou_notificacao = 1 THEN 100 ELSE 0 END * 0.30) +\\r\\n            (CASE \\r\\n                WHEN m.ciclo_completo = 1 THEN 100\\r\\n                WHEN m.teve_encerramento = 1 THEN 50\\r\\n                ELSE 0 \\r\\n            END * 0.20) +\\r\\n            (CASE\\r\\n                WHEN m.perc_valor_notificado >= 80 THEN 100\\r\\n                WHEN m.perc_valor_notificado >= 60 THEN 80\\r\\n                WHEN m.perc_valor_notificado >= 40 THEN 60\\r\\n                WHEN m.perc_valor_notificado >= 20 THEN 40\\r\\n                WHEN m.perc_valor_notificado > 0 THEN 20\\r\\n                ELSE 0\\r\\n            END * 0.30) +\\r\\n            (CASE\\r\\n                WHEN m.dias_infracao_ate_nf IS NULL THEN 0\\r\\n                WHEN m.dias_infracao_ate_nf <= 60 THEN 100\\r\\n                WHEN m.dias_infracao_ate_nf <= 120 THEN 80\\r\\n                WHEN m.dias_infracao_ate_nf <= 180 THEN 60\\r\\n                WHEN m.dias_infracao_ate_nf <= 365 THEN 40\\r\\n                ELSE 20\\r\\n            END * 0.20),\\r\\n        2) >= 80 THEN 'MUITO EFETIVA'\\r\\n        WHEN ROUND(\\r\\n            (CASE WHEN m.gerou_notificacao = 1 THEN 100 ELSE 0 END * 0.30) +\\r\\n            (CASE \\r\\n                WHEN m.ciclo_completo = 1 THEN 100\\r\\n                WHEN m.teve_encerramento = 1 THEN 50\\r\\n                ELSE 0 \\r\\n            END * 0.20) +\\r\\n            (CASE\\r\\n                WHEN m.perc_valor_notificado >= 80 THEN 100\\r\\n                WHEN m.perc_valor_notificado >= 60 THEN 80\\r\\n                WHEN m.perc_valor_notificado >= 40 THEN 60\\r\\n                WHEN m.perc_valor_notificado >= 20 THEN 40\\r\\n                WHEN m.perc_valor_notificado > 0 THEN 20\\r\\n                ELSE 0\\r\\n            END * 0.30) +\\r\\n            (CASE\\r\\n                WHEN m.dias_infracao_ate_nf IS NULL THEN 0\\r\\n                WHEN m.dias_infracao_ate_nf <= 60 THEN 100\\r\\n                WHEN m.dias_infracao_ate_nf <= 120 THEN 80\\r\\n                WHEN m.dias_infracao_ate_nf <= 180 THEN 60\\r\\n                WHEN m.dias_infracao_ate_nf <= 365 THEN 40\\r\\n                ELSE 20\\r\\n            END * 0.20),\\r\\n        2) >= 60 THEN 'EFETIVA'\\r\\n        WHEN ROUND(\\r\\n            (CASE WHEN m.gerou_notificacao = 1 THEN 100 ELSE 0 END * 0.30) +\\r\\n            (CASE \\r\\n                WHEN m.ciclo_completo = 1 THEN 100\\r\\n                WHEN m.teve_encerramento = 1 THEN 50\\r\\n                ELSE 0 \\r\\n            END * 0.20) +\\r\\n            (CASE\\r\\n                WHEN m.perc_valor_notificado >= 80 THEN 100\\r\\n                WHEN m.perc_valor_notificado >= 60 THEN 80\\r\\n                WHEN m.perc_valor_notificado >= 40 THEN 60\\r\\n                WHEN m.perc_valor_notificado >= 20 THEN 40\\r\\n                WHEN m.perc_valor_notificado > 0 THEN 20\\r\\n                ELSE 0\\r\\n            END * 0.30) +\\r\\n            (CASE\\r\\n                WHEN m.dias_infracao_ate_nf IS NULL THEN 0\\r\\n                WHEN m.dias_infracao_ate_nf <= 60 THEN 100\\r\\n                WHEN m.dias_infracao_ate_nf <= 120 THEN 80\\r\\n                WHEN m.dias_infracao_ate_nf <= 180 THEN 60\\r\\n                WHEN m.dias_infracao_ate_nf <= 365 THEN 40\\r\\n                ELSE 20\\r\\n            END * 0.20),\\r\\n        2) >= 40 THEN 'MODERADAMENTE EFETIVA'\\r\\n        ELSE 'POUCO EFETIVA'\\r\\n    END AS classificacao_efetividade\\r\\n\\r\\nFROM metricas_base m\\r\\nORDER BY score_efetividade_final DESC;\\r\\n\\r\\n-- ================================================================================\\r\\n-- PARTE 18: DASHBOARD EXECUTIVO COM FILTROS DE ESTADO\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.fisca_dashboard_executivo;\\r\\n\\r\\nCREATE TABLE teste.fisca_dashboard_executivo AS\\r\\nWITH \\r\\nacomp_ano AS (\\r\\n    SELECT \\r\\n        ano_os AS ano,\\r\\n        COUNT(*) AS qtd_acompanhamentos,\\r\\n        COUNT(DISTINCT cnpj) AS empresas_acompanhadas\\r\\n    FROM teste.fisca_acompanhamentos\\r\\n    WHERE ano_os >= 2020\\r\\n    GROUP BY ano_os\\r\\n),\\r\\n\\r\\n-- \\u2705 ATUALIZADO: Usar eh_valida\\r\\nfisc_ano AS (\\r\\n    SELECT\\r\\n        fc.ano_infracao AS ano,\\r\\n        \\r\\n        -- === INFRA\\u00c7\\u00d5ES V\\u00c1LIDAS (base correta) ===\\r\\n        COUNT(DISTINCT CASE WHEN fc.eh_valida = 1 THEN fc.id_documento END) AS qtd_infracoes_lavradas,\\r\\n        \\r\\n        -- === INFRA\\u00c7\\u00d5ES TOTAIS (para refer\\u00eancia) ===\\r\\n        COUNT(DISTINCT fc.id_documento) AS qtd_infracoes_total,\\r\\n        \\r\\n        -- === CANCELADAS (para transpar\\u00eancia) ===\\r\\n        COUNT(DISTINCT CASE WHEN fc.eh_valida = 0 THEN fc.id_documento END) AS qtd_canceladas,\\r\\n        \\r\\n        -- === EMPRESAS ===\\r\\n        COUNT(DISTINCT CASE WHEN fc.eh_valida = 1 THEN fc.identificador END) AS empresas_fiscalizadas,\\r\\n        \\r\\n        -- === CI\\u00caNCIA (apenas v\\u00e1lidas) ===\\r\\n        SUM(CASE WHEN fc.data_ciencia_infracao IS NOT NULL AND fc.eh_valida = 1 THEN 1 ELSE 0 END) AS infracoes_com_ciencia,\\r\\n        \\r\\n        -- === VALORES DAS INFRA\\u00c7\\u00d5ES (apenas v\\u00e1lidas) ===\\r\\n        SUM(CASE WHEN fc.eh_valida = 1 THEN COALESCE(fc.valor_total_infracao, 0) ELSE 0 END) AS valor_total_infracoes,\\r\\n        SUM(CASE WHEN fc.eh_valida = 1 THEN COALESCE(fc.valor_imposto_infracao, 0) ELSE 0 END) AS valor_imposto_infracoes,\\r\\n        SUM(CASE WHEN fc.eh_valida = 1 THEN COALESCE(fc.valor_multa_infracao, 0) ELSE 0 END) AS valor_multa_infracoes,\\r\\n        SUM(CASE WHEN fc.eh_valida = 1 THEN COALESCE(fc.valor_juros_infracao, 0) ELSE 0 END) AS valor_juros_infracoes,\\r\\n        \\r\\n        -- === NOTIFICA\\u00c7\\u00d5ES FISCAIS (apenas de v\\u00e1lidas) ===\\r\\n        SUM(CASE WHEN fc.gerou_notificacao = 1 AND fc.eh_valida = 1 THEN 1 ELSE 0 END) AS qtd_nfs_emitidas,\\r\\n        SUM(CASE WHEN fc.gerou_notificacao = 1 AND fc.eh_valida = 1 THEN COALESCE(fc.valor_total_nf, 0) ELSE 0 END) AS valor_total_nfs,\\r\\n        SUM(CASE WHEN fc.gerou_notificacao = 1 AND fc.eh_valida = 1 THEN COALESCE(fc.valor_imposto_nf, 0) ELSE 0 END) AS valor_imposto_nfs,\\r\\n        SUM(CASE WHEN fc.gerou_notificacao = 1 AND fc.eh_valida = 1 THEN COALESCE(fc.valor_multa_nf, 0) ELSE 0 END) AS valor_multa_nfs,\\r\\n        SUM(CASE WHEN fc.gerou_notificacao = 1 AND fc.eh_valida = 1 THEN COALESCE(fc.valor_juros_nf, 0) ELSE 0 END) AS valor_juros_nfs,\\r\\n        \\r\\n        -- \\u2705 NOVO: Regulariza\\u00e7\\u00f5es sem NF\\r\\n        SUM(fc.eh_regularizada_sem_nf) AS qtd_regularizadas_sem_nf,\\r\\n        SUM(CASE WHEN fc.eh_regularizada_sem_nf = 1 THEN COALESCE(fc.valor_total_infracao, 0) ELSE 0 END) AS valor_regularizadas_sem_nf,\\r\\n        \\r\\n        -- === ENCERRAMENTOS (apenas v\\u00e1lidas) ===\\r\\n        SUM(CASE WHEN fc.teve_encerramento = 1 AND fc.eh_valida = 1 THEN 1 ELSE 0 END) AS qtd_encerramentos,\\r\\n        SUM(CASE WHEN fc.teve_resultados = 1 AND fc.eh_valida = 1 THEN 1 ELSE 0 END) AS qtd_encerramentos_com_resultado,\\r\\n        SUM(CASE WHEN fc.ciclo_completo = 1 AND fc.eh_valida = 1 THEN 1 ELSE 0 END) AS qtd_ciclos_completos,\\r\\n        \\r\\n        -- === TEMPOS M\\u00c9DIOS (apenas v\\u00e1lidas) ===\\r\\n        AVG(CASE WHEN fc.eh_valida = 1 THEN fc.dias_infracao_ate_nf END) AS media_dias_infracao_nf,\\r\\n        AVG(CASE WHEN fc.eh_valida = 1 THEN fc.dias_infracao_ate_encerramento END) AS media_dias_infracao_encerramento\\r\\n        \\r\\n    FROM teste.fisca_fiscalizacoes_consolidadas fc\\r\\n    WHERE fc.ano_infracao >= 2020\\r\\n    GROUP BY fc.ano_infracao\\r\\n),\\r\\n\\r\\nafres_ano AS (\\r\\n    SELECT \\r\\n        ano,\\r\\n        COUNT(DISTINCT matricula_afre) AS qtd_afres_ativos\\r\\n    FROM teste.fisca_afres_periodos_ativos\\r\\n    WHERE ano >= 2020\\r\\n        AND mes_completo = 1\\r\\n    GROUP BY ano\\r\\n)\\r\\n\\r\\nSELECT\\r\\n    fa.ano,\\r\\n    \\r\\n    -- === ACOMPANHAMENTOS ===\\r\\n    COALESCE(aa.qtd_acompanhamentos, 0) AS qtd_acompanhamentos,\\r\\n    COALESCE(aa.empresas_acompanhadas, 0) AS empresas_acompanhadas,\\r\\n    \\r\\n    -- === INFRA\\u00c7\\u00d5ES ===\\r\\n    fa.qtd_infracoes_lavradas,\\r\\n    fa.qtd_infracoes_total,\\r\\n    fa.qtd_canceladas,\\r\\n    fa.empresas_fiscalizadas,\\r\\n    fa.infracoes_com_ciencia,\\r\\n    \\r\\n    -- === VALORES DAS INFRA\\u00c7\\u00d5ES ===\\r\\n    fa.valor_total_infracoes,\\r\\n    fa.valor_imposto_infracoes,\\r\\n    fa.valor_multa_infracoes,\\r\\n    fa.valor_juros_infracoes,\\r\\n    \\r\\n    -- === NOTIFICA\\u00c7\\u00d5ES FISCAIS ===\\r\\n    fa.qtd_nfs_emitidas,\\r\\n    fa.valor_total_nfs,\\r\\n    fa.valor_imposto_nfs,\\r\\n    fa.valor_multa_nfs,\\r\\n    fa.valor_juros_nfs,\\r\\n    \\r\\n    -- \\u2705 NOVO: Regulariza\\u00e7\\u00f5es\\r\\n    fa.qtd_regularizadas_sem_nf,\\r\\n    fa.valor_regularizadas_sem_nf,\\r\\n    \\r\\n    -- === ENCERRAMENTOS ===\\r\\n    fa.qtd_encerramentos,\\r\\n    fa.qtd_encerramentos_com_resultado,\\r\\n    fa.qtd_ciclos_completos,\\r\\n    \\r\\n    -- === TEMPOS M\\u00c9DIOS ===\\r\\n    fa.media_dias_infracao_nf,\\r\\n    fa.media_dias_infracao_encerramento,\\r\\n    \\r\\n    -- === TAXAS DE CONVERS\\u00c3O ===\\r\\n    CASE \\r\\n        WHEN fa.qtd_infracoes_lavradas > 0 \\r\\n        THEN ROUND((fa.qtd_nfs_emitidas * 100.0) / fa.qtd_infracoes_lavradas, 2)\\r\\n        ELSE 0 \\r\\n    END AS taxa_conversao_infracao_nf,\\r\\n    \\r\\n    -- \\u2705 NOVO: Taxa ampliada (NFs + Regulariza\\u00e7\\u00f5es)\\r\\n    CASE \\r\\n        WHEN fa.qtd_infracoes_lavradas > 0 \\r\\n        THEN ROUND(((fa.qtd_nfs_emitidas + fa.qtd_regularizadas_sem_nf) * 100.0) / fa.qtd_infracoes_lavradas, 2)\\r\\n        ELSE 0 \\r\\n    END AS taxa_efetividade_fiscal,\\r\\n    \\r\\n    -- === VALORES M\\u00c9DIOS ===\\r\\n    CASE \\r\\n        WHEN fa.qtd_infracoes_lavradas > 0 \\r\\n        THEN ROUND(fa.valor_total_infracoes / fa.qtd_infracoes_lavradas, 2)\\r\\n        ELSE 0 \\r\\n    END AS valor_medio_infracao,\\r\\n    \\r\\n    CASE \\r\\n        WHEN fa.qtd_nfs_emitidas > 0 \\r\\n        THEN ROUND(fa.valor_total_nfs / fa.qtd_nfs_emitidas, 2)\\r\\n        ELSE 0 \\r\\n    END AS valor_medio_nf,\\r\\n    \\r\\n    -- === PRODUTIVIDADE ===\\r\\n    COALESCE(afr.qtd_afres_ativos, 0) AS qtd_afres_ativos,\\r\\n    \\r\\n    CASE \\r\\n        WHEN COALESCE(afr.qtd_afres_ativos, 0) > 0 \\r\\n        THEN ROUND(fa.qtd_infracoes_lavradas * 1.0 / afr.qtd_afres_ativos, 2)\\r\\n        ELSE 0 \\r\\n    END AS media_infracoes_por_afre,\\r\\n    \\r\\n    CASE \\r\\n        WHEN COALESCE(afr.qtd_afres_ativos, 0) > 0 \\r\\n        THEN ROUND(fa.valor_total_infracoes / afr.qtd_afres_ativos, 2)\\r\\n        ELSE 0 \\r\\n    END AS valor_medio_por_afre\\r\\n\\r\\nFROM fisc_ano fa\\r\\nLEFT JOIN acomp_ano aa ON fa.ano = aa.ano\\r\\nLEFT JOIN afres_ano afr ON fa.ano = afr.ano\\r\\n\\r\\nORDER BY fa.ano DESC;\\r\\n\\r\\n-- ================================================================================\\r\\n-- PARTE 19: M\\u00c9TRICAS POR GES (GRUPOS ESPECIALISTAS SETORIAIS)\\r\\n-- ================================================================================\\r\\n-- Objetivo: Analisar performance dos GES em rela\\u00e7\\u00e3o \\u00e0s fiscaliza\\u00e7\\u00f5es\\r\\n-- Filtro: Apenas empresas vinculadas a GES (nm_ges LIKE 'GES%')\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.fisca_metricas_por_ges;\\r\\n\\r\\nCREATE TABLE teste.fisca_metricas_por_ges AS\\r\\nSELECT\\r\\n    fc.nm_ges,\\r\\n    fc.ano_infracao AS ano,\\r\\n    \\r\\n    -- === QUANTIDADE ===\\r\\n    COUNT(DISTINCT fc.id_documento) AS qtd_fiscalizacoes,\\r\\n    COUNT(DISTINCT fc.identificador) AS qtd_empresas_unicas,\\r\\n    COUNT(DISTINCT fc.numero_infracao) AS qtd_infracoes,\\r\\n    \\r\\n    -- === CI\\u00caNCIA ===\\r\\n    SUM(CASE WHEN fc.data_ciencia_infracao IS NOT NULL THEN 1 ELSE 0 END) AS qtd_infracoes_com_ciencia,\\r\\n    \\r\\n    -- === VALORES DAS INFRA\\u00c7\\u00d5ES ===\\r\\n    SUM(COALESCE(fc.valor_total_infracao, 0)) AS valor_total_infracoes,\\r\\n    SUM(COALESCE(fc.valor_imposto_infracao, 0)) AS valor_imposto_infracoes,\\r\\n    SUM(COALESCE(fc.valor_multa_infracao, 0)) AS valor_multa_infracoes,\\r\\n    \\r\\n    -- === NOTIFICA\\u00c7\\u00d5ES FISCAIS ===\\r\\n    SUM(fc.gerou_notificacao) AS qtd_nfs,\\r\\n    SUM(COALESCE(fc.valor_total_nf, 0)) AS valor_total_lancado,\\r\\n    \\r\\n    -- === REGULARIZA\\u00c7\\u00d5ES ===\\r\\n    SUM(fc.eh_regularizada_sem_nf) AS qtd_regularizadas_sem_nf,\\r\\n    \\r\\n    -- === ENCERRAMENTOS ===\\r\\n    SUM(fc.teve_encerramento) AS qtd_encerramentos,\\r\\n    SUM(fc.teve_resultados) AS qtd_encerramentos_com_resultado,\\r\\n    SUM(fc.ciclo_completo) AS qtd_ciclos_completos,\\r\\n    \\r\\n    -- === TEMPOS M\\u00c9DIOS ===\\r\\n    AVG(fc.dias_infracao_ate_nf) AS media_dias_infracao_nf,\\r\\n    AVG(fc.dias_infracao_ate_encerramento) AS media_dias_infracao_encerramento,\\r\\n    \\r\\n    -- === TAXAS DE CONVERS\\u00c3O ===\\r\\n    CASE \\r\\n        WHEN COUNT(DISTINCT fc.numero_infracao) > 0 \\r\\n        THEN ROUND((SUM(fc.gerou_notificacao) * 100.0) / COUNT(DISTINCT fc.numero_infracao), 2)\\r\\n        ELSE 0 \\r\\n    END AS taxa_conversao_infracao_nf,\\r\\n    \\r\\n    CASE \\r\\n        WHEN COUNT(DISTINCT fc.numero_infracao) > 0 \\r\\n        THEN ROUND(((SUM(fc.gerou_notificacao) + SUM(fc.eh_regularizada_sem_nf)) * 100.0) / COUNT(DISTINCT fc.numero_infracao), 2)\\r\\n        ELSE 0 \\r\\n    END AS taxa_efetividade_fiscal,\\r\\n    \\r\\n    -- === VALORES M\\u00c9DIOS ===\\r\\n    CASE \\r\\n        WHEN COUNT(DISTINCT fc.id_documento) > 0 \\r\\n        THEN ROUND(SUM(COALESCE(fc.valor_total_infracao, 0)) / COUNT(DISTINCT fc.id_documento), 2)\\r\\n        ELSE 0 \\r\\n    END AS valor_medio_infracao,\\r\\n    \\r\\n    CASE \\r\\n        WHEN SUM(fc.gerou_notificacao) > 0 \\r\\n        THEN ROUND(SUM(COALESCE(fc.valor_total_nf, 0)) / SUM(fc.gerou_notificacao), 2)\\r\\n        ELSE 0 \\r\\n    END AS valor_medio_nf\\r\\n\\r\\nFROM teste.fisca_fiscalizacoes_consolidadas fc\\r\\nWHERE fc.nm_ges IS NOT NULL\\r\\n    AND fc.nm_ges LIKE 'GES%'  -- \\u2705 Apenas GES (exclui GRAF)\\r\\n    AND fc.eh_valida = 1  -- \\u2705 Apenas infra\\u00e7\\u00f5es v\\u00e1lidas\\r\\nGROUP BY fc.nm_ges, fc.ano_infracao\\r\\nORDER BY fc.nm_ges, ano DESC;\", \"statementsList\": [\"\\r\\n\\r\\nCREATE TABLE teste.fisca_afres_por_documento AS\\r\\nWITH documentos_validos AS (\\r\\n    SELECT id_documento FROM teste.fisca_infracoes_base\\r\\n    UNION\\r\\n    SELECT id_documento FROM teste.fisca_notificacoes_fiscais\\r\\n    UNION\\r\\n    SELECT id_documento FROM teste.fisca_termos_encerramento\\r\\n)\\r\\nSELECT\\r\\n    aut.id_documento,\\r\\n    CAST(aut.cd_matr_afre AS INT) AS matricula_afre,\\r\\n    aut.faf_nome AS nome_afre,\\r\\n    aut.de_cargo AS cargo,\\r\\n    aut.vl_perc_partic AS percentual_participacao,\\r\\n    aut.sn_coordenador AS eh_coordenador\\r\\nFROM usr_sat_ods.fis_docto_fiscal_autoridades aut\\r\\nINNER JOIN documentos_validos dv\\r\\n    ON aut.id_documento = dv.id_documento;\", \"\\r\\n\\r\\n-- ================================================================================\\r\\n-- PARTE 10: TABELA DE INFRA\\u00c7\\u00d5ES (CAT\\u00c1LOGO)\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.fisca_catalogo_infracoes;\", \"\\r\\n\\r\\nCREATE TABLE teste.fisca_catalogo_infracoes AS\\r\\nSELECT\\r\\n    ti.cd_infracao AS codigo_infracao,\\r\\n    ti.de_infracao AS descricao_infracao,\\r\\n    ti.cd_tipo_infracao AS codigo_tipo_infracao,\\r\\n    ti.de_tipo_infracao AS tipo_infracao,\\r\\n    ti.nm_tributo AS nome_tributo,\\r\\n    ti.vl_multa AS valor_multa_padrao,\\r\\n    ti.sn_apres_dp AS permite_defesa_previa,\\r\\n    ti.sn_pagamento_dp AS permite_pagamento_dp,\\r\\n    ti.vl_perc_red_dp AS percentual_reducao_dp_padrao,\\r\\n    ti.vl_perc_multa_minima AS percentual_multa_minima,\\r\\n    ti.tx_historico_infracao AS historico_infracao,\\r\\n    ti.tx_fund_legal_infracao AS fundamento_legal_infracao,\\r\\n    ti.tx_fund_legal_multa AS fundamento_legal_multa,\\r\\n    ti.tx_fund_legal_atualizacao AS fundamento_legal_atualizacao,\\r\\n    ti.tx_fund_legal_juros AS fundamento_legal_juros,\\r\\n    ti.tx_motivo_representacao AS motivo_representacao,\\r\\n    ti.tx_rol_conta_corrente AS rol_conta_corrente,\\r\\n    ti.dt_inclusao_ods,\\r\\n    ti.dt_ult_atualiz_ods\\r\\nFROM usr_sat_ods.fis_tabela_infracoes ti;\", \"\\r\\n\\r\\n-- ================================================================================\\r\\n-- PARTE 11: CONSOLIDA\\u00c7\\u00c3O - FISCALIZA\\u00c7\\u00d5ES COMPLETAS (COM FILTRO DE ESTADO)\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.fisca_fiscalizacoes_consolidadas;\", \"\\r\\n\\r\\nCREATE TABLE teste.fisca_fiscalizacoes_consolidadas AS\\r\\nSELECT\\r\\n    inf.id_documento,\\r\\n    inf.cnpj,\\r\\n    inf.cpf,\\r\\n    inf.identificador,  -- \\u2705 NOVO\\r\\n    inf.tipo_pessoa,    -- \\u2705 NOVO\\r\\n    inf.nu_ie,\\r\\n    \\r\\n    -- Dados cadastrais da empresa\\r\\n    eb.nm_razao_social,\\r\\n    eb.nm_fantasia,\\r\\n    eb.regime_tributario,\\r\\n    eb.nm_tipo_contribuinte,\\r\\n    eb.cnae_secao,\\r\\n    eb.cnae_secao_descricao,\\r\\n    eb.cnae_divisao,\\r\\n    eb.cnae_divisao_descricao,\\r\\n    eb.de_cnae AS cnae_descricao,\\r\\n    eb.municipio,\\r\\n    eb.uf,\\r\\n    eb.nm_usefi AS usefi,\\r\\n    eb.nm_gerfe AS gerfe,\\r\\n    eb.nm_ges,\\r\\n    \\r\\n    -- \\u2705 NOVO: Estados e flags\\r\\n    inf.estado_documento,\\r\\n    inf.status_normalizado,\\r\\n    inf.eh_valida,\\r\\n    inf.eh_regularizada_sem_nf,\\r\\n    inf.eh_confirmada,\\r\\n    \\r\\n    -- Auto de Infra\\u00e7\\u00e3o (BASE)\\r\\n    inf.numero_infracao,\\r\\n    inf.data_infracao,\\r\\n    inf.tipo_infracao,\\r\\n    inf.valor_imposto AS valor_imposto_infracao,\\r\\n    inf.valor_multa AS valor_multa_infracao,\\r\\n    inf.valor_juros AS valor_juros_infracao,\\r\\n    inf.valor_total AS valor_total_infracao,\\r\\n    inf.apresentou_defesa_previa AS apresentou_dp_infracao,\\r\\n    inf.data_apresentacao_dp AS data_dp_infracao,\\r\\n    inf.pagou_na_dp AS pagou_dp_infracao,\\r\\n    inf.data_ciencia AS data_ciencia_infracao,\\r\\n    inf.modo_ciencia AS modo_ciencia_infracao,\\r\\n    inf.data_julgamento AS data_julgamento_infracao,\\r\\n    \\r\\n    -- Notifica\\u00e7\\u00e3o Fiscal (se houver)\\r\\n    nf.numero_nf,\\r\\n    nf.data_nf,\\r\\n    nf.tipo_notificacao,\\r\\n    nf.valor_imposto AS valor_imposto_nf,\\r\\n    nf.valor_multa AS valor_multa_nf,\\r\\n    nf.valor_juros AS valor_juros_nf,\\r\\n    nf.valor_total AS valor_total_nf,\\r\\n    nf.data_ciencia AS data_ciencia_nf,\\r\\n    \\r\\n    -- Termo de Encerramento (se houver)\\r\\n    te.numero_documento AS numero_termo_encerramento,\\r\\n    te.data_encerramento,\\r\\n    te.teve_resultados,\\r\\n    te.verificacoes_realizadas,\\r\\n    te.data_ciencia AS data_ciencia_encerramento,\\r\\n    \\r\\n    -- Temporalidade\\r\\n    inf.ano_infracao,\\r\\n    inf.periodo_aaaamm AS periodo_infracao,\\r\\n    \\r\\n    -- Indicadores de ciclo completo\\r\\n    inf.gerou_notificacao,\\r\\n    CASE WHEN te.id_documento IS NOT NULL THEN 1 ELSE 0 END AS teve_encerramento,\\r\\n    CASE WHEN nf.id_documento IS NOT NULL AND te.id_documento IS NOT NULL THEN 1 ELSE 0 END AS ciclo_completo,\\r\\n    \\r\\n    -- Tempo entre etapas (em dias)\\r\\n    CASE \\r\\n        WHEN nf.data_nf IS NOT NULL AND inf.data_infracao IS NOT NULL \\r\\n        THEN DATEDIFF(nf.data_nf, inf.data_infracao)\\r\\n        ELSE NULL \\r\\n    END AS dias_infracao_ate_nf,\\r\\n    \\r\\n    CASE \\r\\n        WHEN te.data_encerramento IS NOT NULL AND inf.data_infracao IS NOT NULL \\r\\n        THEN DATEDIFF(te.data_encerramento, inf.data_infracao)\\r\\n        ELSE NULL \\r\\n    END AS dias_infracao_ate_encerramento,\\r\\n    \\r\\n    -- Situa\\u00e7\\u00e3o final\\r\\n    CASE\\r\\n        WHEN inf.eh_valida = 0 THEN 'CANCELADA'\\r\\n        WHEN inf.eh_regularizada_sem_nf = 1 THEN 'REGULARIZADA SEM NF'\\r\\n        WHEN nf.id_documento IS NOT NULL AND te.teve_resultados = 1 THEN 'NOTIFICADO COM RESULTADOS'\\r\\n        WHEN nf.id_documento IS NOT NULL THEN 'NOTIFICADO SEM RESULTADOS'\\r\\n        WHEN te.teve_resultados = 1 THEN 'ENCERRADO COM RESULTADOS'\\r\\n        WHEN te.id_documento IS NOT NULL THEN 'ENCERRADO SEM RESULTADOS'\\r\\n        ELSE 'EM ANDAMENTO'\\r\\n    END AS situacao_final\\r\\n    \\r\\nFROM teste.fisca_infracoes_base inf\\r\\n\\r\\nLEFT JOIN teste.fisca_empresas_base eb\\r\\n    ON inf.identificador = eb.cnpj  -- \\u2705 Usar identificador para pegar PJ e PF\\r\\n\\r\\nLEFT JOIN teste.fisca_notificacoes_fiscais nf\\r\\n    ON inf.id_notificacao_gerada = nf.id_documento\\r\\n\\r\\nLEFT JOIN teste.fisca_termos_encerramento te\\r\\n    ON inf.nu_os = te.os\\r\\n\\r\\nORDER BY inf.data_infracao DESC;\", \"\\r\\n\\r\\n-- ================================================================================\\r\\n-- PARTE 12: M\\u00c9TRICAS POR AFRE (PRODUTIVIDADE INDIVIDUAL)\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.fisca_metricas_por_afre;\", \"\\r\\n\\r\\nCREATE TABLE teste.fisca_metricas_por_afre AS\\r\\nWITH\\r\\n-- Infra\\u00e7\\u00f5es por AFRE\\r\\ninfracoes_afre AS (\\r\\n    SELECT\\r\\n        a.matricula_afre,\\r\\n        a.nome_afre,\\r\\n        YEAR(inf.data_infracao) AS ano,\\r\\n        COUNT(DISTINCT inf.id_documento) AS qtd_infracoes,\\r\\n        COUNT(DISTINCT inf.cnpj) AS qtd_empresas_fiscalizadas,\\r\\n        SUM(CASE WHEN inf.data_ciencia_infracao IS NOT NULL THEN 1 ELSE 0 END) AS qtd_infracoes_com_ciencia,\\r\\n        SUM(COALESCE(inf.valor_total_infracao, 0)) AS valor_total_infracoes\\r\\n    FROM teste.fisca_afres_por_documento a\\r\\n    INNER JOIN teste.fisca_fiscalizacoes_consolidadas inf\\r\\n        ON a.id_documento = inf.id_documento\\r\\n    WHERE a.eh_coordenador = 0\\r\\n    GROUP BY a.matricula_afre, a.nome_afre, YEAR(inf.data_infracao)\\r\\n),\\r\\n-- NFs por AFRE\\r\\nnfs_afre AS (\\r\\n    SELECT\\r\\n        a.matricula_afre,\\r\\n        YEAR(fc.data_nf) AS ano,\\r\\n        COUNT(DISTINCT fc.numero_nf) AS qtd_nfs,\\r\\n        SUM(COALESCE(fc.valor_total_nf, 0)) AS valor_total_lancado\\r\\n    FROM teste.fisca_afres_por_documento a\\r\\n    INNER JOIN teste.fisca_fiscalizacoes_consolidadas fc\\r\\n        ON a.id_documento = fc.id_documento\\r\\n    WHERE a.eh_coordenador = 0\\r\\n        AND fc.gerou_notificacao = 1\\r\\n    GROUP BY a.matricula_afre, YEAR(fc.data_nf)\\r\\n),\\r\\n-- Per\\u00edodos ativos por AFRE\\r\\nperiodos_ativos AS (\\r\\n    SELECT\\r\\n        matricula_afre,\\r\\n        ano,\\r\\n        SUM(mes_completo) AS meses_completos_ativos,\\r\\n        SUM(dias_ativo_mes) AS total_dias_ativos\\r\\n    FROM teste.fisca_afres_periodos_ativos\\r\\n    WHERE ano >= 2020\\r\\n    GROUP BY matricula_afre, ano\\r\\n)\\r\\n\\r\\nSELECT\\r\\n    COALESCE(i.matricula_afre, n.matricula_afre, p.matricula_afre) AS matricula_afre,\\r\\n    i.nome_afre,\\r\\n    COALESCE(i.ano, n.ano, p.ano) AS ano,\\r\\n    \\r\\n    -- Dados de atividade\\r\\n    COALESCE(p.meses_completos_ativos, 0) AS meses_ativos,\\r\\n    COALESCE(p.total_dias_ativos, 0) AS dias_ativos,\\r\\n    \\r\\n    -- Infra\\u00e7\\u00f5es\\r\\n    COALESCE(i.qtd_infracoes, 0) AS qtd_infracoes,\\r\\n    COALESCE(i.qtd_empresas_fiscalizadas, 0) AS qtd_empresas_fiscalizadas,\\r\\n    COALESCE(i.qtd_infracoes_com_ciencia, 0) AS qtd_infracoes_com_ciencia,\\r\\n    COALESCE(i.valor_total_infracoes, 0) AS valor_total_infracoes,\\r\\n    \\r\\n    -- NFs\\r\\n    COALESCE(n.qtd_nfs, 0) AS qtd_nfs,\\r\\n    COALESCE(n.valor_total_lancado, 0) AS valor_total_lancado,\\r\\n    \\r\\n    -- M\\u00e9tricas calculadas\\r\\n    CASE \\r\\n        WHEN p.meses_completos_ativos > 0 \\r\\n        THEN ROUND(COALESCE(i.qtd_infracoes, 0) * 1.0 / p.meses_completos_ativos, 2)\\r\\n        ELSE 0 \\r\\n    END AS infracoes_por_mes,\\r\\n    \\r\\n    CASE \\r\\n        WHEN p.meses_completos_ativos > 0 \\r\\n        THEN ROUND(COALESCE(n.qtd_nfs, 0) * 1.0 / p.meses_completos_ativos, 2)\\r\\n        ELSE 0 \\r\\n    END AS nfs_por_mes,\\r\\n    \\r\\n    CASE \\r\\n        WHEN i.qtd_infracoes > 0 \\r\\n        THEN ROUND((COALESCE(n.qtd_nfs, 0) * 100.0) / i.qtd_infracoes, 2)\\r\\n        ELSE 0 \\r\\n    END AS taxa_conversao_infracao_nf,\\r\\n    \\r\\n    CASE \\r\\n        WHEN p.meses_completos_ativos > 0 \\r\\n        THEN ROUND(COALESCE(i.valor_total_infracoes, 0) / p.meses_completos_ativos, 2)\\r\\n        ELSE 0 \\r\\n    END AS valor_medio_mensal\\r\\n\\r\\nFROM infracoes_afre i\\r\\nFULL OUTER JOIN nfs_afre n\\r\\n    ON i.matricula_afre = n.matricula_afre AND i.ano = n.ano\\r\\nFULL OUTER JOIN periodos_ativos p\\r\\n    ON COALESCE(i.matricula_afre, n.matricula_afre) = p.matricula_afre \\r\\n    AND COALESCE(i.ano, n.ano) = p.ano\\r\\n\\r\\nORDER BY ano DESC, qtd_nfs DESC;\", \"\\r\\n\\r\\n-- ================================================================================\\r\\n-- PARTE 13: M\\u00c9TRICAS POR GER\\u00caNCIA (GRAF)\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.fisca_metricas_por_gerencia;\", \"\\r\\n\\r\\nCREATE TABLE teste.fisca_metricas_por_gerencia AS\\r\\nSELECT\\r\\n    fc.gerfe,\\r\\n    fc.ano_infracao AS ano,\\r\\n    \\r\\n    -- Quantidade de fiscaliza\\u00e7\\u00f5es\\r\\n    COUNT(DISTINCT fc.id_documento) AS qtd_fiscalizacoes,\\r\\n    COUNT(DISTINCT fc.cnpj) AS qtd_empresas_unicas,\\r\\n    \\r\\n    -- Infra\\u00e7\\u00f5es\\r\\n    COUNT(DISTINCT fc.numero_infracao) AS qtd_infracoes,\\r\\n    SUM(CASE WHEN fc.data_ciencia_infracao IS NOT NULL THEN 1 ELSE 0 END) AS qtd_infracoes_com_ciencia,\\r\\n    \\r\\n    -- Valores das infra\\u00e7\\u00f5es\\r\\n    SUM(COALESCE(fc.valor_total_infracao, 0)) AS valor_total_infracoes,\\r\\n    SUM(COALESCE(fc.valor_imposto_infracao, 0)) AS valor_imposto_infracoes,\\r\\n    SUM(COALESCE(fc.valor_multa_infracao, 0)) AS valor_multa_infracoes,\\r\\n    \\r\\n    -- Notifica\\u00e7\\u00f5es\\r\\n    SUM(fc.gerou_notificacao) AS qtd_nfs,\\r\\n    SUM(COALESCE(fc.valor_total_nf, 0)) AS valor_total_lancado,\\r\\n    \\r\\n    -- Encerramentos\\r\\n    SUM(fc.teve_encerramento) AS qtd_encerramentos,\\r\\n    SUM(fc.teve_resultados) AS qtd_encerramentos_com_resultado,\\r\\n    SUM(fc.ciclo_completo) AS qtd_ciclos_completos,\\r\\n    \\r\\n    -- Tempos m\\u00e9dios\\r\\n    AVG(fc.dias_infracao_ate_nf) AS media_dias_infracao_nf,\\r\\n    AVG(fc.dias_infracao_ate_encerramento) AS media_dias_infracao_encerramento,\\r\\n    \\r\\n    -- Taxas de convers\\u00e3o\\r\\n    CASE \\r\\n        WHEN COUNT(DISTINCT fc.numero_infracao) > 0 \\r\\n        THEN ROUND((SUM(fc.gerou_notificacao) * 100.0) / COUNT(DISTINCT fc.numero_infracao), 2)\\r\\n        ELSE 0 \\r\\n    END AS taxa_conversao_infracao_nf,\\r\\n    \\r\\n    -- Valores m\\u00e9dios\\r\\n    CASE \\r\\n        WHEN COUNT(DISTINCT fc.id_documento) > 0 \\r\\n        THEN ROUND(SUM(COALESCE(fc.valor_total_infracao, 0)) / COUNT(DISTINCT fc.id_documento), 2)\\r\\n        ELSE 0 \\r\\n    END AS valor_medio_infracao\\r\\n\\r\\nFROM teste.fisca_fiscalizacoes_consolidadas fc\\r\\nWHERE fc.gerfe IS NOT NULL\\r\\n  AND fc.eh_valida = 1\\r\\nGROUP BY fc.gerfe, fc.ano_infracao\\r\\nORDER BY fc.gerfe, ano DESC;\", \"\\r\\n\\r\\n-- ================================================================================\\r\\n-- PARTE 14: M\\u00c9TRICAS POR CNAE\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.fisca_metricas_por_cnae;\", \"\\r\\n\\r\\nCREATE TABLE teste.fisca_metricas_por_cnae AS\\r\\nSELECT\\r\\n    fc.cnae_secao,\\r\\n    fc.cnae_secao_descricao,\\r\\n    fc.cnae_divisao,\\r\\n    fc.cnae_divisao_descricao,\\r\\n    fc.ano_infracao AS ano,\\r\\n    \\r\\n    -- Quantidade\\r\\n    COUNT(DISTINCT fc.id_documento) AS qtd_fiscalizacoes,\\r\\n    COUNT(DISTINCT fc.cnpj) AS qtd_empresas_unicas,\\r\\n    SUM(fc.gerou_notificacao) AS qtd_nfs,\\r\\n    \\r\\n    -- Valores\\r\\n    SUM(COALESCE(fc.valor_total_infracao, 0)) AS valor_total_infracoes,\\r\\n    SUM(COALESCE(fc.valor_imposto_infracao, 0)) AS valor_imposto,\\r\\n    SUM(COALESCE(fc.valor_multa_infracao, 0)) AS valor_multa,\\r\\n    SUM(COALESCE(fc.valor_total_nf, 0)) AS valor_total_nfs,\\r\\n    \\r\\n    -- Taxas\\r\\n    CASE \\r\\n        WHEN COUNT(DISTINCT fc.id_documento) > 0 \\r\\n        THEN ROUND((SUM(fc.gerou_notificacao) * 100.0) / COUNT(DISTINCT fc.id_documento), 2)\\r\\n        ELSE 0 \\r\\n    END AS taxa_conversao_infracao_nf,\\r\\n    \\r\\n    -- Valores m\\u00e9dios\\r\\n    CASE \\r\\n        WHEN COUNT(DISTINCT fc.id_documento) > 0 \\r\\n        THEN ROUND(SUM(COALESCE(fc.valor_total_infracao, 0)) / COUNT(DISTINCT fc.id_documento), 2)\\r\\n        ELSE 0 \\r\\n    END AS valor_medio_infracao,\\r\\n    \\r\\n    CASE \\r\\n        WHEN SUM(fc.gerou_notificacao) > 0 \\r\\n        THEN ROUND(SUM(COALESCE(fc.valor_total_nf, 0)) / SUM(fc.gerou_notificacao), 2)\\r\\n        ELSE 0 \\r\\n    END AS valor_medio_nf\\r\\n\\r\\nFROM teste.fisca_fiscalizacoes_consolidadas fc\\r\\nWHERE fc.cnae_secao IS NOT NULL\\r\\n  AND fc.eh_valida = 1\\r\\nGROUP BY fc.cnae_secao, fc.cnae_secao_descricao, fc.cnae_divisao, fc.cnae_divisao_descricao, fc.ano_infracao\\r\\nORDER BY ano DESC, qtd_fiscalizacoes DESC;\", \"\\r\\n\\r\\n-- ================================================================================\\r\\n-- PARTE 15: M\\u00c9TRICAS POR MUNIC\\u00cdPIO\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.fisca_metricas_por_municipio;\", \"\\r\\n\\r\\nCREATE TABLE teste.fisca_metricas_por_municipio AS\\r\\nSELECT\\r\\n    fc.municipio,\\r\\n    fc.uf,\\r\\n    fc.ano_infracao AS ano,\\r\\n    \\r\\n    -- Quantidade\\r\\n    COUNT(DISTINCT fc.id_documento) AS qtd_fiscalizacoes,\\r\\n    COUNT(DISTINCT fc.cnpj) AS qtd_empresas_unicas,\\r\\n    SUM(fc.gerou_notificacao) AS qtd_nfs,\\r\\n    \\r\\n    -- Valores\\r\\n    SUM(COALESCE(fc.valor_total_infracao, 0)) AS valor_total_infracoes,\\r\\n    SUM(COALESCE(fc.valor_total_nf, 0)) AS valor_total_nfs,\\r\\n    \\r\\n    -- Taxas\\r\\n    CASE \\r\\n        WHEN COUNT(DISTINCT fc.id_documento) > 0 \\r\\n        THEN ROUND((SUM(fc.gerou_notificacao) * 100.0) / COUNT(DISTINCT fc.id_documento), 2)\\r\\n        ELSE 0 \\r\\n    END AS taxa_conversao_infracao_nf\\r\\n\\r\\nFROM teste.fisca_fiscalizacoes_consolidadas fc\\r\\nWHERE fc.municipio IS NOT NULL\\r\\n  AND fc.eh_valida = 1\\r\\nGROUP BY fc.municipio, fc.uf, fc.ano_infracao\\r\\nORDER BY ano DESC, qtd_fiscalizacoes DESC;\", \"\\r\\n\\r\\n-- ================================================================================\\r\\n-- PARTE 16: AN\\u00c1LISE DE INFRA\\u00c7\\u00d5ES (VERS\\u00c3O FINAL CORRIGIDA)\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.fisca_ranking_infracoes;\", \"\\r\\n\\r\\nCREATE TABLE teste.fisca_ranking_infracoes AS\\r\\nWITH infracoes_com_dados AS (\\r\\n    SELECT\\r\\n        inf.id_documento,\\r\\n        inf.periodo_referencia,\\r\\n        inf.valor_base_calculo,\\r\\n        \\r\\n        -- \\u2705 CALCULAR valor_total se estiver NULL\\r\\n        COALESCE(inf.valor_imposto, 0) AS valor_imposto,\\r\\n        COALESCE(inf.valor_multa, 0) AS valor_multa,\\r\\n        COALESCE(inf.valor_juros, 0) AS valor_juros,\\r\\n        COALESCE(\\r\\n            inf.valor_total,\\r\\n            COALESCE(inf.valor_imposto, 0) + COALESCE(inf.valor_multa, 0) + COALESCE(inf.valor_juros, 0)\\r\\n        ) AS valor_total_calculado,\\r\\n        \\r\\n        fc.ano_infracao,\\r\\n        fc.identificador,\\r\\n        fc.tipo_infracao,\\r\\n        fc.cnae_secao,\\r\\n        fc.cnae_secao_descricao,\\r\\n        fc.regime_tributario,\\r\\n        fc.municipio,\\r\\n        fc.nm_ges\\r\\n    FROM teste.fisca_infracoes_detalhadas inf\\r\\n    INNER JOIN teste.fisca_fiscalizacoes_consolidadas fc\\r\\n        ON inf.id_documento = fc.id_documento\\r\\n    WHERE fc.eh_valida = 1\\r\\n)\\r\\n\\r\\nSELECT\\r\\n    i.tipo_infracao AS codigo_infracao,\\r\\n    cat.descricao_infracao,\\r\\n    cat.tipo_infracao AS tipo_infracao_descricao,\\r\\n    i.ano_infracao AS ano,\\r\\n    \\r\\n    -- Quantidade\\r\\n    COUNT(*) AS qtd_ocorrencias,\\r\\n    COUNT(DISTINCT i.identificador) AS qtd_empresas,\\r\\n    COUNT(DISTINCT i.id_documento) AS qtd_documentos,\\r\\n    \\r\\n    -- \\u2705 Valores CALCULADOS\\r\\n    SUM(i.valor_total_calculado) AS valor_total,\\r\\n    SUM(i.valor_imposto) AS valor_imposto,\\r\\n    SUM(i.valor_multa) AS valor_multa,\\r\\n    SUM(i.valor_juros) AS valor_juros,\\r\\n    ROUND(AVG(i.valor_total_calculado), 2) AS valor_medio\\r\\n\\r\\nFROM infracoes_com_dados i\\r\\nLEFT JOIN teste.fisca_catalogo_infracoes cat\\r\\n    ON i.tipo_infracao = CAST(cat.codigo_infracao AS STRING)\\r\\nWHERE i.ano_infracao >= 2020\\r\\n    AND i.tipo_infracao IS NOT NULL\\r\\nGROUP BY \\r\\n    i.tipo_infracao,\\r\\n    cat.descricao_infracao, \\r\\n    cat.tipo_infracao,\\r\\n    i.ano_infracao\\r\\nORDER BY ano DESC, qtd_ocorrencias DESC;\", \"\\r\\n\\r\\n-- ================================================================================\\r\\n-- PARTE 17: SCORE DE EFETIVIDADE DA FISCALIZA\\u00c7\\u00c3O\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.fisca_scores_efetividade;\", \"\\r\\n\\r\\nCREATE TABLE teste.fisca_scores_efetividade AS\\r\\nWITH metricas_base AS (\\r\\n    SELECT\\r\\n        fc.id_documento,\\r\\n        fc.cnpj,\\r\\n        fc.nm_razao_social,\\r\\n        fc.gerfe,\\r\\n        fc.municipio,\\r\\n        fc.cnae_secao_descricao,\\r\\n        fc.regime_tributario,\\r\\n        fc.ano_infracao,\\r\\n        \\r\\n        -- Indicadores bin\\u00e1rios\\r\\n        fc.gerou_notificacao,\\r\\n        fc.teve_encerramento,\\r\\n        fc.ciclo_completo,\\r\\n        \\r\\n        -- Valores\\r\\n        COALESCE(fc.valor_total_infracao, 0) AS valor_total_infracao,\\r\\n        COALESCE(fc.valor_total_nf, 0) AS valor_total_nf,\\r\\n        \\r\\n        -- Tempos\\r\\n        fc.dias_infracao_ate_nf,\\r\\n        \\r\\n        -- Percentual notificado\\r\\n        CASE \\r\\n            WHEN fc.valor_total_infracao > 0 \\r\\n            THEN (fc.valor_total_nf * 100.0) / fc.valor_total_infracao\\r\\n            ELSE 0 \\r\\n        END AS perc_valor_notificado\\r\\n    FROM teste.fisca_fiscalizacoes_consolidadas fc\\r\\n)\\r\\n\\r\\nSELECT\\r\\n    m.*,\\r\\n    \\r\\n    -- Score 1: Gera\\u00e7\\u00e3o de Notifica\\u00e7\\u00e3o (0-100)\\r\\n    CASE WHEN m.gerou_notificacao = 1 THEN 100 ELSE 0 END AS score_geracao_nf,\\r\\n    \\r\\n    -- Score 2: Ciclo Completo (0-100)\\r\\n    CASE \\r\\n        WHEN m.ciclo_completo = 1 THEN 100\\r\\n        WHEN m.teve_encerramento = 1 THEN 50\\r\\n        ELSE 0 \\r\\n    END AS score_ciclo,\\r\\n    \\r\\n    -- Score 3: Valor Notificado (0-100)\\r\\n    CASE\\r\\n        WHEN m.perc_valor_notificado >= 80 THEN 100\\r\\n        WHEN m.perc_valor_notificado >= 60 THEN 80\\r\\n        WHEN m.perc_valor_notificado >= 40 THEN 60\\r\\n        WHEN m.perc_valor_notificado >= 20 THEN 40\\r\\n        WHEN m.perc_valor_notificado > 0 THEN 20\\r\\n        ELSE 0\\r\\n    END AS score_valor_notificado,\\r\\n    \\r\\n    -- Score 4: Tempestividade (0-100)\\r\\n    CASE\\r\\n        WHEN m.dias_infracao_ate_nf IS NULL THEN 0\\r\\n        WHEN m.dias_infracao_ate_nf <= 60 THEN 100\\r\\n        WHEN m.dias_infracao_ate_nf <= 120 THEN 80\\r\\n        WHEN m.dias_infracao_ate_nf <= 180 THEN 60\\r\\n        WHEN m.dias_infracao_ate_nf <= 365 THEN 40\\r\\n        ELSE 20\\r\\n    END AS score_tempestividade,\\r\\n    \\r\\n    -- Score Final (m\\u00e9dia ponderada)\\r\\n    ROUND(\\r\\n        (CASE WHEN m.gerou_notificacao = 1 THEN 100 ELSE 0 END * 0.30) +\\r\\n        (CASE \\r\\n            WHEN m.ciclo_completo = 1 THEN 100\\r\\n            WHEN m.teve_encerramento = 1 THEN 50\\r\\n            ELSE 0 \\r\\n        END * 0.20) +\\r\\n        (CASE\\r\\n            WHEN m.perc_valor_notificado >= 80 THEN 100\\r\\n            WHEN m.perc_valor_notificado >= 60 THEN 80\\r\\n            WHEN m.perc_valor_notificado >= 40 THEN 60\\r\\n            WHEN m.perc_valor_notificado >= 20 THEN 40\\r\\n            WHEN m.perc_valor_notificado > 0 THEN 20\\r\\n            ELSE 0\\r\\n        END * 0.30) +\\r\\n        (CASE\\r\\n            WHEN m.dias_infracao_ate_nf IS NULL THEN 0\\r\\n            WHEN m.dias_infracao_ate_nf <= 60 THEN 100\\r\\n            WHEN m.dias_infracao_ate_nf <= 120 THEN 80\\r\\n            WHEN m.dias_infracao_ate_nf <= 180 THEN 60\\r\\n            WHEN m.dias_infracao_ate_nf <= 365 THEN 40\\r\\n            ELSE 20\\r\\n        END * 0.20),\\r\\n    2) AS score_efetividade_final,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o\\r\\n    CASE\\r\\n        WHEN ROUND(\\r\\n            (CASE WHEN m.gerou_notificacao = 1 THEN 100 ELSE 0 END * 0.30) +\\r\\n            (CASE \\r\\n                WHEN m.ciclo_completo = 1 THEN 100\\r\\n                WHEN m.teve_encerramento = 1 THEN 50\\r\\n                ELSE 0 \\r\\n            END * 0.20) +\\r\\n            (CASE\\r\\n                WHEN m.perc_valor_notificado >= 80 THEN 100\\r\\n                WHEN m.perc_valor_notificado >= 60 THEN 80\\r\\n                WHEN m.perc_valor_notificado >= 40 THEN 60\\r\\n                WHEN m.perc_valor_notificado >= 20 THEN 40\\r\\n                WHEN m.perc_valor_notificado > 0 THEN 20\\r\\n                ELSE 0\\r\\n            END * 0.30) +\\r\\n            (CASE\\r\\n                WHEN m.dias_infracao_ate_nf IS NULL THEN 0\\r\\n                WHEN m.dias_infracao_ate_nf <= 60 THEN 100\\r\\n                WHEN m.dias_infracao_ate_nf <= 120 THEN 80\\r\\n                WHEN m.dias_infracao_ate_nf <= 180 THEN 60\\r\\n                WHEN m.dias_infracao_ate_nf <= 365 THEN 40\\r\\n                ELSE 20\\r\\n            END * 0.20),\\r\\n        2) >= 80 THEN 'MUITO EFETIVA'\\r\\n        WHEN ROUND(\\r\\n            (CASE WHEN m.gerou_notificacao = 1 THEN 100 ELSE 0 END * 0.30) +\\r\\n            (CASE \\r\\n                WHEN m.ciclo_completo = 1 THEN 100\\r\\n                WHEN m.teve_encerramento = 1 THEN 50\\r\\n                ELSE 0 \\r\\n            END * 0.20) +\\r\\n            (CASE\\r\\n                WHEN m.perc_valor_notificado >= 80 THEN 100\\r\\n                WHEN m.perc_valor_notificado >= 60 THEN 80\\r\\n                WHEN m.perc_valor_notificado >= 40 THEN 60\\r\\n                WHEN m.perc_valor_notificado >= 20 THEN 40\\r\\n                WHEN m.perc_valor_notificado > 0 THEN 20\\r\\n                ELSE 0\\r\\n            END * 0.30) +\\r\\n            (CASE\\r\\n                WHEN m.dias_infracao_ate_nf IS NULL THEN 0\\r\\n                WHEN m.dias_infracao_ate_nf <= 60 THEN 100\\r\\n                WHEN m.dias_infracao_ate_nf <= 120 THEN 80\\r\\n                WHEN m.dias_infracao_ate_nf <= 180 THEN 60\\r\\n                WHEN m.dias_infracao_ate_nf <= 365 THEN 40\\r\\n                ELSE 20\\r\\n            END * 0.20),\\r\\n        2) >= 60 THEN 'EFETIVA'\\r\\n        WHEN ROUND(\\r\\n            (CASE WHEN m.gerou_notificacao = 1 THEN 100 ELSE 0 END * 0.30) +\\r\\n            (CASE \\r\\n                WHEN m.ciclo_completo = 1 THEN 100\\r\\n                WHEN m.teve_encerramento = 1 THEN 50\\r\\n                ELSE 0 \\r\\n            END * 0.20) +\\r\\n            (CASE\\r\\n                WHEN m.perc_valor_notificado >= 80 THEN 100\\r\\n                WHEN m.perc_valor_notificado >= 60 THEN 80\\r\\n                WHEN m.perc_valor_notificado >= 40 THEN 60\\r\\n                WHEN m.perc_valor_notificado >= 20 THEN 40\\r\\n                WHEN m.perc_valor_notificado > 0 THEN 20\\r\\n                ELSE 0\\r\\n            END * 0.30) +\\r\\n            (CASE\\r\\n                WHEN m.dias_infracao_ate_nf IS NULL THEN 0\\r\\n                WHEN m.dias_infracao_ate_nf <= 60 THEN 100\\r\\n                WHEN m.dias_infracao_ate_nf <= 120 THEN 80\\r\\n                WHEN m.dias_infracao_ate_nf <= 180 THEN 60\\r\\n                WHEN m.dias_infracao_ate_nf <= 365 THEN 40\\r\\n                ELSE 20\\r\\n            END * 0.20),\\r\\n        2) >= 40 THEN 'MODERADAMENTE EFETIVA'\\r\\n        ELSE 'POUCO EFETIVA'\\r\\n    END AS classificacao_efetividade\\r\\n\\r\\nFROM metricas_base m\\r\\nORDER BY score_efetividade_final DESC;\", \"\\r\\n\\r\\n-- ================================================================================\\r\\n-- PARTE 18: DASHBOARD EXECUTIVO COM FILTROS DE ESTADO\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.fisca_dashboard_executivo;\", \"\\r\\n\\r\\nCREATE TABLE teste.fisca_dashboard_executivo AS\\r\\nWITH \\r\\nacomp_ano AS (\\r\\n    SELECT \\r\\n        ano_os AS ano,\\r\\n        COUNT(*) AS qtd_acompanhamentos,\\r\\n        COUNT(DISTINCT cnpj) AS empresas_acompanhadas\\r\\n    FROM teste.fisca_acompanhamentos\\r\\n    WHERE ano_os >= 2020\\r\\n    GROUP BY ano_os\\r\\n),\\r\\n\\r\\n-- \\u2705 ATUALIZADO: Usar eh_valida\\r\\nfisc_ano AS (\\r\\n    SELECT\\r\\n        fc.ano_infracao AS ano,\\r\\n        \\r\\n        -- === INFRA\\u00c7\\u00d5ES V\\u00c1LIDAS (base correta) ===\\r\\n        COUNT(DISTINCT CASE WHEN fc.eh_valida = 1 THEN fc.id_documento END) AS qtd_infracoes_lavradas,\\r\\n        \\r\\n        -- === INFRA\\u00c7\\u00d5ES TOTAIS (para refer\\u00eancia) ===\\r\\n        COUNT(DISTINCT fc.id_documento) AS qtd_infracoes_total,\\r\\n        \\r\\n        -- === CANCELADAS (para transpar\\u00eancia) ===\\r\\n        COUNT(DISTINCT CASE WHEN fc.eh_valida = 0 THEN fc.id_documento END) AS qtd_canceladas,\\r\\n        \\r\\n        -- === EMPRESAS ===\\r\\n        COUNT(DISTINCT CASE WHEN fc.eh_valida = 1 THEN fc.identificador END) AS empresas_fiscalizadas,\\r\\n        \\r\\n        -- === CI\\u00caNCIA (apenas v\\u00e1lidas) ===\\r\\n        SUM(CASE WHEN fc.data_ciencia_infracao IS NOT NULL AND fc.eh_valida = 1 THEN 1 ELSE 0 END) AS infracoes_com_ciencia,\\r\\n        \\r\\n        -- === VALORES DAS INFRA\\u00c7\\u00d5ES (apenas v\\u00e1lidas) ===\\r\\n        SUM(CASE WHEN fc.eh_valida = 1 THEN COALESCE(fc.valor_total_infracao, 0) ELSE 0 END) AS valor_total_infracoes,\\r\\n        SUM(CASE WHEN fc.eh_valida = 1 THEN COALESCE(fc.valor_imposto_infracao, 0) ELSE 0 END) AS valor_imposto_infracoes,\\r\\n        SUM(CASE WHEN fc.eh_valida = 1 THEN COALESCE(fc.valor_multa_infracao, 0) ELSE 0 END) AS valor_multa_infracoes,\\r\\n        SUM(CASE WHEN fc.eh_valida = 1 THEN COALESCE(fc.valor_juros_infracao, 0) ELSE 0 END) AS valor_juros_infracoes,\\r\\n        \\r\\n        -- === NOTIFICA\\u00c7\\u00d5ES FISCAIS (apenas de v\\u00e1lidas) ===\\r\\n        SUM(CASE WHEN fc.gerou_notificacao = 1 AND fc.eh_valida = 1 THEN 1 ELSE 0 END) AS qtd_nfs_emitidas,\\r\\n        SUM(CASE WHEN fc.gerou_notificacao = 1 AND fc.eh_valida = 1 THEN COALESCE(fc.valor_total_nf, 0) ELSE 0 END) AS valor_total_nfs,\\r\\n        SUM(CASE WHEN fc.gerou_notificacao = 1 AND fc.eh_valida = 1 THEN COALESCE(fc.valor_imposto_nf, 0) ELSE 0 END) AS valor_imposto_nfs,\\r\\n        SUM(CASE WHEN fc.gerou_notificacao = 1 AND fc.eh_valida = 1 THEN COALESCE(fc.valor_multa_nf, 0) ELSE 0 END) AS valor_multa_nfs,\\r\\n        SUM(CASE WHEN fc.gerou_notificacao = 1 AND fc.eh_valida = 1 THEN COALESCE(fc.valor_juros_nf, 0) ELSE 0 END) AS valor_juros_nfs,\\r\\n        \\r\\n        -- \\u2705 NOVO: Regulariza\\u00e7\\u00f5es sem NF\\r\\n        SUM(fc.eh_regularizada_sem_nf) AS qtd_regularizadas_sem_nf,\\r\\n        SUM(CASE WHEN fc.eh_regularizada_sem_nf = 1 THEN COALESCE(fc.valor_total_infracao, 0) ELSE 0 END) AS valor_regularizadas_sem_nf,\\r\\n        \\r\\n        -- === ENCERRAMENTOS (apenas v\\u00e1lidas) ===\\r\\n        SUM(CASE WHEN fc.teve_encerramento = 1 AND fc.eh_valida = 1 THEN 1 ELSE 0 END) AS qtd_encerramentos,\\r\\n        SUM(CASE WHEN fc.teve_resultados = 1 AND fc.eh_valida = 1 THEN 1 ELSE 0 END) AS qtd_encerramentos_com_resultado,\\r\\n        SUM(CASE WHEN fc.ciclo_completo = 1 AND fc.eh_valida = 1 THEN 1 ELSE 0 END) AS qtd_ciclos_completos,\\r\\n        \\r\\n        -- === TEMPOS M\\u00c9DIOS (apenas v\\u00e1lidas) ===\\r\\n        AVG(CASE WHEN fc.eh_valida = 1 THEN fc.dias_infracao_ate_nf END) AS media_dias_infracao_nf,\\r\\n        AVG(CASE WHEN fc.eh_valida = 1 THEN fc.dias_infracao_ate_encerramento END) AS media_dias_infracao_encerramento\\r\\n        \\r\\n    FROM teste.fisca_fiscalizacoes_consolidadas fc\\r\\n    WHERE fc.ano_infracao >= 2020\\r\\n    GROUP BY fc.ano_infracao\\r\\n),\\r\\n\\r\\nafres_ano AS (\\r\\n    SELECT \\r\\n        ano,\\r\\n        COUNT(DISTINCT matricula_afre) AS qtd_afres_ativos\\r\\n    FROM teste.fisca_afres_periodos_ativos\\r\\n    WHERE ano >= 2020\\r\\n        AND mes_completo = 1\\r\\n    GROUP BY ano\\r\\n)\\r\\n\\r\\nSELECT\\r\\n    fa.ano,\\r\\n    \\r\\n    -- === ACOMPANHAMENTOS ===\\r\\n    COALESCE(aa.qtd_acompanhamentos, 0) AS qtd_acompanhamentos,\\r\\n    COALESCE(aa.empresas_acompanhadas, 0) AS empresas_acompanhadas,\\r\\n    \\r\\n    -- === INFRA\\u00c7\\u00d5ES ===\\r\\n    fa.qtd_infracoes_lavradas,\\r\\n    fa.qtd_infracoes_total,\\r\\n    fa.qtd_canceladas,\\r\\n    fa.empresas_fiscalizadas,\\r\\n    fa.infracoes_com_ciencia,\\r\\n    \\r\\n    -- === VALORES DAS INFRA\\u00c7\\u00d5ES ===\\r\\n    fa.valor_total_infracoes,\\r\\n    fa.valor_imposto_infracoes,\\r\\n    fa.valor_multa_infracoes,\\r\\n    fa.valor_juros_infracoes,\\r\\n    \\r\\n    -- === NOTIFICA\\u00c7\\u00d5ES FISCAIS ===\\r\\n    fa.qtd_nfs_emitidas,\\r\\n    fa.valor_total_nfs,\\r\\n    fa.valor_imposto_nfs,\\r\\n    fa.valor_multa_nfs,\\r\\n    fa.valor_juros_nfs,\\r\\n    \\r\\n    -- \\u2705 NOVO: Regulariza\\u00e7\\u00f5es\\r\\n    fa.qtd_regularizadas_sem_nf,\\r\\n    fa.valor_regularizadas_sem_nf,\\r\\n    \\r\\n    -- === ENCERRAMENTOS ===\\r\\n    fa.qtd_encerramentos,\\r\\n    fa.qtd_encerramentos_com_resultado,\\r\\n    fa.qtd_ciclos_completos,\\r\\n    \\r\\n    -- === TEMPOS M\\u00c9DIOS ===\\r\\n    fa.media_dias_infracao_nf,\\r\\n    fa.media_dias_infracao_encerramento,\\r\\n    \\r\\n    -- === TAXAS DE CONVERS\\u00c3O ===\\r\\n    CASE \\r\\n        WHEN fa.qtd_infracoes_lavradas > 0 \\r\\n        THEN ROUND((fa.qtd_nfs_emitidas * 100.0) / fa.qtd_infracoes_lavradas, 2)\\r\\n        ELSE 0 \\r\\n    END AS taxa_conversao_infracao_nf,\\r\\n    \\r\\n    -- \\u2705 NOVO: Taxa ampliada (NFs + Regulariza\\u00e7\\u00f5es)\\r\\n    CASE \\r\\n        WHEN fa.qtd_infracoes_lavradas > 0 \\r\\n        THEN ROUND(((fa.qtd_nfs_emitidas + fa.qtd_regularizadas_sem_nf) * 100.0) / fa.qtd_infracoes_lavradas, 2)\\r\\n        ELSE 0 \\r\\n    END AS taxa_efetividade_fiscal,\\r\\n    \\r\\n    -- === VALORES M\\u00c9DIOS ===\\r\\n    CASE \\r\\n        WHEN fa.qtd_infracoes_lavradas > 0 \\r\\n        THEN ROUND(fa.valor_total_infracoes / fa.qtd_infracoes_lavradas, 2)\\r\\n        ELSE 0 \\r\\n    END AS valor_medio_infracao,\\r\\n    \\r\\n    CASE \\r\\n        WHEN fa.qtd_nfs_emitidas > 0 \\r\\n        THEN ROUND(fa.valor_total_nfs / fa.qtd_nfs_emitidas, 2)\\r\\n        ELSE 0 \\r\\n    END AS valor_medio_nf,\\r\\n    \\r\\n    -- === PRODUTIVIDADE ===\\r\\n    COALESCE(afr.qtd_afres_ativos, 0) AS qtd_afres_ativos,\\r\\n    \\r\\n    CASE \\r\\n        WHEN COALESCE(afr.qtd_afres_ativos, 0) > 0 \\r\\n        THEN ROUND(fa.qtd_infracoes_lavradas * 1.0 / afr.qtd_afres_ativos, 2)\\r\\n        ELSE 0 \\r\\n    END AS media_infracoes_por_afre,\\r\\n    \\r\\n    CASE \\r\\n        WHEN COALESCE(afr.qtd_afres_ativos, 0) > 0 \\r\\n        THEN ROUND(fa.valor_total_infracoes / afr.qtd_afres_ativos, 2)\\r\\n        ELSE 0 \\r\\n    END AS valor_medio_por_afre\\r\\n\\r\\nFROM fisc_ano fa\\r\\nLEFT JOIN acomp_ano aa ON fa.ano = aa.ano\\r\\nLEFT JOIN afres_ano afr ON fa.ano = afr.ano\\r\\n\\r\\nORDER BY fa.ano DESC;\", \"\\r\\n\\r\\n-- ================================================================================\\r\\n-- PARTE 19: M\\u00c9TRICAS POR GES (GRUPOS ESPECIALISTAS SETORIAIS)\\r\\n-- ================================================================================\\r\\n-- Objetivo: Analisar performance dos GES em rela\\u00e7\\u00e3o \\u00e0s fiscaliza\\u00e7\\u00f5es\\r\\n-- Filtro: Apenas empresas vinculadas a GES (nm_ges LIKE 'GES%')\\r\\n-- ================================================================================\\r\\n\\r\\nDROP TABLE IF EXISTS teste.fisca_metricas_por_ges;\", \"\\r\\n\\r\\nCREATE TABLE teste.fisca_metricas_por_ges AS\\r\\nSELECT\\r\\n    fc.nm_ges,\\r\\n    fc.ano_infracao AS ano,\\r\\n    \\r\\n    -- === QUANTIDADE ===\\r\\n    COUNT(DISTINCT fc.id_documento) AS qtd_fiscalizacoes,\\r\\n    COUNT(DISTINCT fc.identificador) AS qtd_empresas_unicas,\\r\\n    COUNT(DISTINCT fc.numero_infracao) AS qtd_infracoes,\\r\\n    \\r\\n    -- === CI\\u00caNCIA ===\\r\\n    SUM(CASE WHEN fc.data_ciencia_infracao IS NOT NULL THEN 1 ELSE 0 END) AS qtd_infracoes_com_ciencia,\\r\\n    \\r\\n    -- === VALORES DAS INFRA\\u00c7\\u00d5ES ===\\r\\n    SUM(COALESCE(fc.valor_total_infracao, 0)) AS valor_total_infracoes,\\r\\n    SUM(COALESCE(fc.valor_imposto_infracao, 0)) AS valor_imposto_infracoes,\\r\\n    SUM(COALESCE(fc.valor_multa_infracao, 0)) AS valor_multa_infracoes,\\r\\n    \\r\\n    -- === NOTIFICA\\u00c7\\u00d5ES FISCAIS ===\\r\\n    SUM(fc.gerou_notificacao) AS qtd_nfs,\\r\\n    SUM(COALESCE(fc.valor_total_nf, 0)) AS valor_total_lancado,\\r\\n    \\r\\n    -- === REGULARIZA\\u00c7\\u00d5ES ===\\r\\n    SUM(fc.eh_regularizada_sem_nf) AS qtd_regularizadas_sem_nf,\\r\\n    \\r\\n    -- === ENCERRAMENTOS ===\\r\\n    SUM(fc.teve_encerramento) AS qtd_encerramentos,\\r\\n    SUM(fc.teve_resultados) AS qtd_encerramentos_com_resultado,\\r\\n    SUM(fc.ciclo_completo) AS qtd_ciclos_completos,\\r\\n    \\r\\n    -- === TEMPOS M\\u00c9DIOS ===\\r\\n    AVG(fc.dias_infracao_ate_nf) AS media_dias_infracao_nf,\\r\\n    AVG(fc.dias_infracao_ate_encerramento) AS media_dias_infracao_encerramento,\\r\\n    \\r\\n    -- === TAXAS DE CONVERS\\u00c3O ===\\r\\n    CASE \\r\\n        WHEN COUNT(DISTINCT fc.numero_infracao) > 0 \\r\\n        THEN ROUND((SUM(fc.gerou_notificacao) * 100.0) / COUNT(DISTINCT fc.numero_infracao), 2)\\r\\n        ELSE 0 \\r\\n    END AS taxa_conversao_infracao_nf,\\r\\n    \\r\\n    CASE \\r\\n        WHEN COUNT(DISTINCT fc.numero_infracao) > 0 \\r\\n        THEN ROUND(((SUM(fc.gerou_notificacao) + SUM(fc.eh_regularizada_sem_nf)) * 100.0) / COUNT(DISTINCT fc.numero_infracao), 2)\\r\\n        ELSE 0 \\r\\n    END AS taxa_efetividade_fiscal,\\r\\n    \\r\\n    -- === VALORES M\\u00c9DIOS ===\\r\\n    CASE \\r\\n        WHEN COUNT(DISTINCT fc.id_documento) > 0 \\r\\n        THEN ROUND(SUM(COALESCE(fc.valor_total_infracao, 0)) / COUNT(DISTINCT fc.id_documento), 2)\\r\\n        ELSE 0 \\r\\n    END AS valor_medio_infracao,\\r\\n    \\r\\n    CASE \\r\\n        WHEN SUM(fc.gerou_notificacao) > 0 \\r\\n        THEN ROUND(SUM(COALESCE(fc.valor_total_nf, 0)) / SUM(fc.gerou_notificacao), 2)\\r\\n        ELSE 0 \\r\\n    END AS valor_medio_nf\\r\\n\\r\\nFROM teste.fisca_fiscalizacoes_consolidadas fc\\r\\nWHERE fc.nm_ges IS NOT NULL\\r\\n    AND fc.nm_ges LIKE 'GES%'  -- \\u2705 Apenas GES (exclui GRAF)\\r\\n    AND fc.eh_valida = 1  -- \\u2705 Apenas infra\\u00e7\\u00f5es v\\u00e1lidas\\r\\nGROUP BY fc.nm_ges, fc.ano_infracao\\r\\nORDER BY fc.nm_ges, ano DESC;\"], \"aceSize\": 100, \"status\": \"available\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Exemplo: SELECT * FROM tablename ou pressione CTRL + espa\\u00e7o\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"\\r\\n\\r\\nCREATE TABLE teste.fisca_metricas_por_cnae AS\\r\\nSELECT\\r\\n    fc.cnae_secao,\\r\\n    fc.cnae_secao_descricao,\\r\\n    fc.cnae_divisao,\\r\\n    fc.cnae_divisao_descricao,\\r\\n    fc.ano_infracao AS ano,\\r\\n    \\r\\n    -- Quantidade\\r\\n    COUNT(DISTINCT fc.id_documento) AS qtd_fiscalizacoes,\\r\\n    COUNT(DISTINCT fc.cnpj) AS qtd_empresas_unicas,\\r\\n    SUM(fc.gerou_notificacao) AS qtd_nfs,\\r\\n    \\r\\n    -- Valores\\r\\n    SUM(COALESCE(fc.valor_total_infracao, 0)) AS valor_total_infracoes,\\r\\n    SUM(COALESCE(fc.valor_imposto_infracao, 0)) AS valor_imposto,\\r\\n    SUM(COALESCE(fc.valor_multa_infracao, 0)) AS valor_multa,\\r\\n    SUM(COALESCE(fc.valor_total_nf, 0)) AS valor_total_nfs,\\r\\n    \\r\\n    -- Taxas\\r\\n    CASE \\r\\n        WHEN COUNT(DISTINCT fc.id_documento) > 0 \\r\\n        THEN ROUND((SUM(fc.gerou_notificacao) * 100.0) / COUNT(DISTINCT fc.id_documento), 2)\\r\\n        ELSE 0 \\r\\n    END AS taxa_conversao_infracao_nf,\\r\\n    \\r\\n    -- Valores m\\u00e9dios\\r\\n    CASE \\r\\n        WHEN COUNT(DISTINCT fc.id_documento) > 0 \\r\\n        THEN ROUND(SUM(COALESCE(fc.valor_total_infracao, 0)) / COUNT(DISTINCT fc.id_documento), 2)\\r\\n        ELSE 0 \\r\\n    END AS valor_medio_infracao,\\r\\n    \\r\\n    CASE \\r\\n        WHEN SUM(fc.gerou_notificacao) > 0 \\r\\n        THEN ROUND(SUM(COALESCE(fc.valor_total_nf, 0)) / SUM(fc.gerou_notificacao), 2)\\r\\n        ELSE 0 \\r\\n    END AS valor_medio_nf\\r\\n\\r\\nFROM teste.fisca_fiscalizacoes_consolidadas fc\\r\\nWHERE fc.cnae_secao IS NOT NULL\\r\\n  AND fc.eh_valida = 1\\r\\nGROUP BY fc.cnae_secao, fc.cnae_secao_descricao, fc.cnae_divisao, fc.cnae_divisao_descricao, fc.ano_infracao\\r\\nORDER BY ano DESC, qtd_fiscalizacoes DESC;\", \"result\": {\"id\": \"26b7b0eb-8dfc-bf2e-6104-2767a962ca81\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"Rlc7S9DzRAiu1l82G6CqEQ==\", \"guid\": \"PEtoxYh4TE0AAAAASwjHfw==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"db4277807f648443:b5290286c15e6dae\", \"session_id\": 22265, \"session_type\": \"impala\", \"statement_id\": 1, \"has_more_statements\": false, \"statements_count\": 2, \"previous_statement_hash\": \"0198f866016c2060a89d3e473fb83972116a4c3504b11e014dbdec90\", \"start\": {\"row\": 2, \"column\": 0}, \"end\": {\"row\": 60, \"column\": 39}, \"statement\": \"CREATE TABLE teste.fisca_ranking_infracoes AS\\nWITH infracoes_com_dados AS (\\n    SELECT\\n        inf.id_documento,\\n        inf.periodo_referencia,\\n        inf.valor_base_calculo,\\n        \\n        -- \\u2705 CALCULAR valor_total se estiver NULL\\n        COALESCE(inf.valor_imposto, 0) AS valor_imposto,\\n        COALESCE(inf.valor_multa, 0) AS valor_multa,\\n        COALESCE(inf.valor_juros, 0) AS valor_juros,\\n        COALESCE(\\n            inf.valor_total,\\n            COALESCE(inf.valor_imposto, 0) + COALESCE(inf.valor_multa, 0) + COALESCE(inf.valor_juros, 0)\\n        ) AS valor_total_calculado,\\n        \\n        fc.ano_infracao,\\n        fc.identificador,\\n        fc.tipo_infracao,\\n        fc.cnae_secao,\\n        fc.cnae_secao_descricao,\\n        fc.regime_tributario,\\n        fc.municipio,\\n        fc.nm_ges\\n    FROM teste.fisca_infracoes_detalhadas inf\\n    INNER JOIN teste.fisca_fiscalizacoes_consolidadas fc\\n        ON inf.id_documento = fc.id_documento\\n    WHERE fc.eh_valida = 1\\n)\\n\\nSELECT\\n    i.tipo_infracao AS codigo_infracao,\\n    cat.descricao_infracao,\\n    cat.tipo_infracao AS tipo_infracao_descricao,\\n    i.ano_infracao AS ano,\\n    \\n    -- Quantidade\\n    COUNT(*) AS qtd_ocorrencias,\\n    COUNT(DISTINCT i.identificador) AS qtd_empresas,\\n    COUNT(DISTINCT i.id_documento) AS qtd_documentos,\\n    \\n    -- \\u2705 Valores CALCULADOS\\n    SUM(i.valor_total_calculado) AS valor_total,\\n    SUM(i.valor_imposto) AS valor_imposto,\\n    SUM(i.valor_multa) AS valor_multa,\\n    SUM(i.valor_juros) AS valor_juros,\\n    ROUND(AVG(i.valor_total_calculado), 2) AS valor_medio\\n\\nFROM infracoes_com_dados i\\nLEFT JOIN teste.fisca_catalogo_infracoes cat\\n    ON i.tipo_infracao = CAST(cat.codigo_infracao AS STRING)\\nWHERE i.ano_infracao >= 2020\\n    AND i.tipo_infracao IS NOT NULL\\nGROUP BY \\n    i.tipo_infracao,\\n    cat.descricao_infracao, \\n    cat.tipo_infracao,\\n    i.ano_infracao\\nORDER BY ano DESC, qtd_ocorrencias DESC\"}, \"meta\": [], \"rows\": \"1\", \"hasMore\": false, \"statement_id\": 1, \"statement_range\": {\"start\": {\"row\": 2, \"column\": 0}, \"end\": {\"row\": 60, \"column\": 39}}, \"statements_count\": 2, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": 1, \"filteredMeta\": [{\"type\": \"int\", \"name\": \"\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 0}, {\"name\": \"summary\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 1}], \"fetchedOnce\": false, \"startTime\": \"2025-11-02T14:17:57.929Z\", \"endTime\": \"2025-11-02T14:17:59.281Z\", \"executionTime\": 1352, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 12, \"hasSomeResults\": true}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": 31336, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": \"summary\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": false, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": \"summary\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": 31431, \"getLogsTimeout\": 31528, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1762093077569, \"lastAceSelectionRowOffset\": 878, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"lastExecutedStatements\": \"DROP TABLE IF EXISTS teste.fisca_ranking_infracoes;\\r\\n\\r\\nCREATE TABLE teste.fisca_ranking_infracoes AS\\r\\nWITH infracoes_com_dados AS (\\r\\n    SELECT\\r\\n        inf.id_documento,\\r\\n        inf.periodo_referencia,\\r\\n        inf.valor_base_calculo,\\r\\n        \\r\\n        -- \\u2705 CALCULAR valor_total se estiver NULL\\r\\n        COALESCE(inf.valor_imposto, 0) AS valor_imposto,\\r\\n        COALESCE(inf.valor_multa, 0) AS valor_multa,\\r\\n        COALESCE(inf.valor_juros, 0) AS valor_juros,\\r\\n        COALESCE(\\r\\n            inf.valor_total,\\r\\n            COALESCE(inf.valor_imposto, 0) + COALESCE(inf.valor_multa, 0) + COALESCE(inf.valor_juros, 0)\\r\\n        ) AS valor_total_calculado,\\r\\n        \\r\\n        fc.ano_infracao,\\r\\n        fc.identificador,\\r\\n        fc.tipo_infracao,\\r\\n        fc.cnae_secao,\\r\\n        fc.cnae_secao_descricao,\\r\\n        fc.regime_tributario,\\r\\n        fc.municipio,\\r\\n        fc.nm_ges\\r\\n    FROM teste.fisca_infracoes_detalhadas inf\\r\\n    INNER JOIN teste.fisca_fiscalizacoes_consolidadas fc\\r\\n        ON inf.id_documento = fc.id_documento\\r\\n    WHERE fc.eh_valida = 1\\r\\n)\\r\\n\\r\\nSELECT\\r\\n    i.tipo_infracao AS codigo_infracao,\\r\\n    cat.descricao_infracao,\\r\\n    cat.tipo_infracao AS tipo_infracao_descricao,\\r\\n    i.ano_infracao AS ano,\\r\\n    \\r\\n    -- Quantidade\\r\\n    COUNT(*) AS qtd_ocorrencias,\\r\\n    COUNT(DISTINCT i.identificador) AS qtd_empresas,\\r\\n    COUNT(DISTINCT i.id_documento) AS qtd_documentos,\\r\\n    \\r\\n    -- \\u2705 Valores CALCULADOS\\r\\n    SUM(i.valor_total_calculado) AS valor_total,\\r\\n    SUM(i.valor_imposto) AS valor_imposto,\\r\\n    SUM(i.valor_multa) AS valor_multa,\\r\\n    SUM(i.valor_juros) AS valor_juros,\\r\\n    ROUND(AVG(i.valor_total_calculado), 2) AS valor_medio\\r\\n\\r\\nFROM infracoes_com_dados i\\r\\nLEFT JOIN teste.fisca_catalogo_infracoes cat\\r\\n    ON i.tipo_infracao = CAST(cat.codigo_infracao AS STRING)\\r\\nWHERE i.ano_infracao >= 2020\\r\\n    AND i.tipo_infracao IS NOT NULL\\r\\nGROUP BY \\r\\n    i.tipo_infracao,\\r\\n    cat.descricao_infracao, \\r\\n    cat.tipo_infracao,\\r\\n    i.ano_infracao\\r\\nORDER BY ano DESC, qtd_ocorrencias DESC;\", \"lastExecutedSelectionRange\": {\"start\": {\"row\": 878, \"column\": 0}, \"end\": {\"row\": 938, \"column\": 40}}, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"aceAutoExpand\": false, \"lastCheckStatusRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"query_status\\\": {\\\"status\\\": \\\"available\\\"}}\", \"responseJSON\": {\"status\": 0, \"query_status\": {\"status\": \"available\"}}, \"status\": 200, \"statusText\": \"OK\"}, \"lastGetLogsRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"logs\\\": \\\"Query 4d4c7888c5684b3c:7fc7084b00000000 100% Complete (3 out of 3)\\\\nIgnoring ORDER BY clause without LIMIT or OFFSET: ORDER BY ano DESC, qtd_ocorrencias DESC.\\\\nAn ORDER BY appearing in a view, subquery, union operand, or an insert/ctas statement has no effect on the query result unless a LIMIT and/or OFFSET is used in conjunction with the ORDER BY.\\\", \\\"progress\\\": 100, \\\"jobs\\\": [{\\\"name\\\": \\\"4d4c7888c5684b3c:7fc7084b00000000\\\", \\\"url\\\": \\\"/hue/jobbrowser#!id=4d4c7888c5684b3c:7fc7084b00000000\\\", \\\"started\\\": true, \\\"finished\\\": false, \\\"percentJob\\\": 100}], \\\"isFullLogs\\\": false}\", \"responseJSON\": {\"status\": 0, \"logs\": \"Query 4d4c7888c5684b3c:7fc7084b00000000 100% Complete (3 out of 3)\\nIgnoring ORDER BY clause without LIMIT or OFFSET: ORDER BY ano DESC, qtd_ocorrencias DESC.\\nAn ORDER BY appearing in a view, subquery, union operand, or an insert/ctas statement has no effect on the query result unless a LIMIT and/or OFFSET is used in conjunction with the ORDER BY.\", \"progress\": 100, \"jobs\": [{\"name\": \"4d4c7888c5684b3c:7fc7084b00000000\", \"url\": \"/hue/jobbrowser#!id=4d4c7888c5684b3c:7fc7084b00000000\", \"started\": true, \"finished\": false, \"percentJob\": 100}], \"isFullLogs\": false}, \"status\": 200, \"statusText\": \"OK\"}}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 18914, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 177, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": true, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false}",
    "extra": "",
    "search": "-- ================================================================================\r\n-- PROJETO FISCA - ANÁLISE DE FISCALIZAÇÕES DA RECEITA ESTADUAL DE SC\r\n-- VERSÃO COMPLETA CORRIGIDA - Todas as análises com campos reais\r\n-- ================================================================================\r\n-- Objetivo: Analisar o desempenho das fiscalizações, acompanhamentos e PAFs\r\n-- Período: 2020 até atual\r\n-- Foco: Dashboard de Resultados, Métricas de Performance e Efetividade\r\n-- Database: teste.fisca_*\r\n-- ================================================================================\r\n-- ESTRUTURA REAL IDENTIFICADA:\r\n-- 1. fis_infr_fiscal_raw = BASE PRINCIPAL (TIF + Auto de Infração)\r\n-- 2. fis_not_fiscal_raw = Notificações Fiscais (geradas a partir das infrações)\r\n-- 3. fis_termo_inicio_fisc_raw = Registro administrativo secundário\r\n-- 4. fis_termo_encerram_fisc_raw = Termos de encerramento\r\n-- 5. Relacionamento: infr_fiscal.id_notificacao_gerada → not_fiscal.id_documento\r\n-- ================================================================================\r\n\r\nSET REQUEST_POOL = 'medium';\r\n\r\n-- ================================================================================\r\n-- PARTE 1: CADASTRO BASE - EMPRESAS E DADOS CADASTRAIS\r\n-- ================================================================================\r\n\r\nDROP TABLE IF EXISTS teste.fisca_empresas_base;\r\n\r\nCREATE TABLE teste.fisca_empresas_base AS\r\nSELECT DISTINCT\r\n    REGEXP_REPLACE(TRIM(c.nu_cnpj), '[^0-9]', '') AS cnpj,\r\n    c.nu_ie,\r\n    c.nm_razao_social,\r\n    c.nm_fantasia,\r\n    c.cd_sit_cadastral,\r\n    c.nm_sit_cadastral,\r\n    c.dt_sit_cadastral,\r\n    c.cd_natureza_juridica,\r\n    c.nm_natureza_juridica,\r\n    c.dt_inicio_icms,\r\n    c.dt_constituicao_empresa,\r\n    c.cd_cnae,\r\n    c.de_cnae,\r\n    c.cd_secao AS cnae_secao,\r\n    c.de_secao AS cnae_secao_descricao,\r\n    c.cd_divisao AS cnae_divisao,\r\n    c.de_divisao AS cnae_divisao_descricao,\r\n    c.cd_grupo AS cnae_grupo,\r\n    c.de_grupo AS cnae_",
    "last_modified": "2025-11-02T11:25:18.669",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "a86f6c3d-3609-4f13-ab12-271973ad5b68",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 170052,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "FISCA: Analises",
    "description": "",
    "uuid": "24458e66-afe6-82de-2370-2195d1806204",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 170052, \"uuid\": \"24458e66-afe6-82de-2370-2195d1806204\", \"name\": \"FISCA: Analises\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": null, \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"aea23954-73ea-051b-2153-baa4c338708a\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Consulta\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": {\"row\": 1166, \"column\": 0}, \"errors\": [{\"message\": \"ParseException: Syntax error in line 1095:undefined:\\n...==========================\\n                            ^\\nEncountered: EOF\\nExpected: ALTER, COMMENT, COMPUTE, COPY, CREATE, DELETE, DESCRIBE, DROP, EXPLAIN, GRANT, INSERT, INVALIDATE, LOAD, REFRESH, REVOKE, SELECT, SET, SHOW, TRUNCATE, UNSET, UPDATE, UPSERT, USE, VALUES, WITH\\n\\n\\nCAUSED BY: Exception: Syntax error\\n\", \"help\": null, \"line\": 1094}], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": false, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"default\", \"currentQueryTab\": \"queryHistory\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 1, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"-- ============================================================================\\r\\n-- SISTEMA DE CONSULTAS ANAL\\u00cdTICAS - PROJETO FISCA\\r\\n-- An\\u00e1lise Completa de Fiscaliza\\u00e7\\u00f5es da Receita Estadual de SC\\r\\n-- Database: teste.fisca_*\\r\\n-- VERS\\u00c3O CORRIGIDA - Tipos TINYINT ajustados\\r\\n-- ============================================================================\\r\\n\\r\\nSET REQUEST_POOL = 'medium';\\r\\nSET MEM_LIMIT = 8G;\\r\\n\\r\\n-- ============================================================================\\r\\n-- SE\\u00c7\\u00c3O 1: ESTAT\\u00cdSTICAS GERAIS DO PROJETO (VIS\\u00c3O EXECUTIVA)\\r\\n-- ============================================================================\\r\\n\\r\\n-- 1.1. PANORAMA GERAL DO PROJETO FISCA\\r\\n-- Objetivo: Vis\\u00e3o executiva completa das fiscaliza\\u00e7\\u00f5es\\r\\nSELECT\\r\\n    '1.1. PANORAMA GERAL FISCA' AS consulta,\\r\\n    \\r\\n    -- Per\\u00edodo de An\\u00e1lise\\r\\n    MIN(ano_infracao) AS ano_inicial,\\r\\n    MAX(ano_infracao) AS ano_final,\\r\\n    \\r\\n    -- M\\u00e9tricas de Volume - Infra\\u00e7\\u00f5es (BASE)\\r\\n    COUNT(DISTINCT id_documento) AS total_infracoes_lavradas,\\r\\n    COUNT(DISTINCT cnpj) AS total_empresas_fiscalizadas,\\r\\n    COUNT(DISTINCT numero_infracao) AS total_numeros_infracao,\\r\\n    \\r\\n    -- Notifica\\u00e7\\u00f5es Fiscais\\r\\n    SUM(gerou_notificacao) AS total_nfs_emitidas,\\r\\n    COUNT(DISTINCT CASE WHEN gerou_notificacao = 1 THEN cnpj END) AS empresas_notificadas,\\r\\n    \\r\\n    -- Encerramentos\\r\\n    SUM(teve_encerramento) AS total_encerramentos,\\r\\n    SUM(teve_resultados) AS encerramentos_com_resultado,\\r\\n    SUM(ciclo_completo) AS total_ciclos_completos,\\r\\n    \\r\\n    -- M\\u00e9tricas Financeiras - Infra\\u00e7\\u00f5es\\r\\n    ROUND(SUM(valor_total_infracao) / 1000000000, 2) AS valor_total_infracoes_bilhoes,\\r\\n    ROUND(SUM(valor_imposto_infracao) / 1000000000, 2) AS valor_imposto_bilhoes,\\r\\n    ROUND(SUM(valor_multa_infracao) / 1000000000, 2) AS valor_multa_bilhoes,\\r\\n    \\r\\n    -- M\\u00e9tricas Financeiras - NFs\\r\\n    ROUND(SUM(valor_total_nf) / 1000000000, 2) AS valor_total_nfs_bilhoes,\\r\\n    \\r\\n    -- Taxas de Convers\\u00e3o\\r\\n    ROUND(SUM(gerou_notificacao) * 100.0 / COUNT(DISTINCT id_documento), 2) AS taxa_conversao_infracao_nf,\\r\\n    ROUND(SUM(ciclo_completo) * 100.0 / COUNT(DISTINCT id_documento), 2) AS taxa_ciclo_completo,\\r\\n    \\r\\n    -- Valores M\\u00e9dios\\r\\n    ROUND(AVG(valor_total_infracao), 2) AS valor_medio_infracao,\\r\\n    ROUND(AVG(CASE WHEN gerou_notificacao = 1 THEN valor_total_nf END), 2) AS valor_medio_nf,\\r\\n    \\r\\n    -- Tempos M\\u00e9dios\\r\\n    ROUND(AVG(dias_infracao_ate_nf), 0) AS media_dias_infracao_nf,\\r\\n    ROUND(AVG(dias_infracao_ate_encerramento), 0) AS media_dias_infracao_encerramento,\\r\\n    \\r\\n    -- Timestamp\\r\\n    CURRENT_TIMESTAMP() AS data_consulta\\r\\n    \\r\\nFROM teste.fisca_fiscalizacoes_consolidadas;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- 1.2. EVOLU\\u00c7\\u00c3O ANUAL COMPLETA\\r\\n-- Objetivo: Acompanhar tend\\u00eancias ano a ano\\r\\nSELECT\\r\\n    '1.2. EVOLU\\u00c7\\u00c3O ANUAL DETALHADA' AS consulta,\\r\\n    \\r\\n    ano_infracao AS ano,\\r\\n    \\r\\n    -- === INFRA\\u00c7\\u00d5ES ===\\r\\n    COUNT(DISTINCT id_documento) AS qtd_infracoes,\\r\\n    COUNT(DISTINCT cnpj) AS empresas_fiscalizadas,\\r\\n    ROUND(SUM(valor_total_infracao) / 1000000, 2) AS valor_infracoes_milhoes,\\r\\n    ROUND(AVG(valor_total_infracao), 2) AS valor_medio_infracao,\\r\\n    \\r\\n    -- === NOTIFICA\\u00c7\\u00d5ES ===\\r\\n    SUM(gerou_notificacao) AS qtd_nfs,\\r\\n    ROUND(SUM(valor_total_nf) / 1000000, 2) AS valor_nfs_milhoes,\\r\\n    ROUND(AVG(CASE WHEN gerou_notificacao = 1 THEN valor_total_nf END), 2) AS valor_medio_nf,\\r\\n    \\r\\n    -- === TAXAS ===\\r\\n    ROUND(SUM(gerou_notificacao) * 100.0 / COUNT(DISTINCT id_documento), 2) AS taxa_conversao_pct,\\r\\n    \\r\\n    -- === CI\\u00caNCIA ===\\r\\n    SUM(CASE WHEN data_ciencia_infracao IS NOT NULL THEN 1 END) AS infracoes_com_ciencia,\\r\\n    ROUND(SUM(CASE WHEN data_ciencia_infracao IS NOT NULL THEN 1 END) * 100.0 / \\r\\n          COUNT(DISTINCT id_documento), 2) AS taxa_ciencia_pct,\\r\\n    \\r\\n    -- === DEFESA PR\\u00c9VIA (CORRIGIDO: s\\u00f3 conta se IS NOT NULL)\\r\\n    SUM(CASE WHEN apresentou_dp_infracao IS NOT NULL THEN 1 END) AS qtd_defesas_previas,\\r\\n    SUM(pagou_dp_infracao) AS qtd_pagamentos_dp,\\r\\n    \\r\\n    -- === TEMPOS ===\\r\\n    ROUND(AVG(dias_infracao_ate_nf), 0) AS media_dias_ate_nf,\\r\\n    ROUND(AVG(dias_infracao_ate_encerramento), 0) AS media_dias_ate_encerramento,\\r\\n    \\r\\n    -- === ENCERRAMENTOS ===\\r\\n    SUM(teve_encerramento) AS qtd_encerramentos,\\r\\n    SUM(teve_resultados) AS encerramentos_com_resultado,\\r\\n    SUM(ciclo_completo) AS ciclos_completos,\\r\\n    \\r\\n    -- === AFREs (do dashboard executivo) ===\\r\\n    de.qtd_afres_ativos AS afres_ativos,\\r\\n    \\r\\n    -- === PRODUTIVIDADE ===\\r\\n    ROUND(COUNT(DISTINCT id_documento) * 1.0 / \\r\\n      NULLIF(de.qtd_afres_ativos, 0), 2) AS infracoes_por_afre\\r\\n    \\r\\nFROM teste.fisca_fiscalizacoes_consolidadas fc\\r\\nLEFT JOIN teste.fisca_dashboard_executivo de\\r\\n    ON fc.ano_infracao = de.ano\\r\\nGROUP BY ano_infracao, de.qtd_afres_ativos\\r\\nORDER BY ano_infracao DESC;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- 1.3. DISTRIBUI\\u00c7\\u00c3O POR REGIME TRIBUT\\u00c1RIO\\r\\n-- Objetivo: Perfil tribut\\u00e1rio das empresas fiscalizadas\\r\\nSELECT\\r\\n    '1.3. DISTRIBUI\\u00c7\\u00c3O POR REGIME TRIBUT\\u00c1RIO' AS consulta,\\r\\n    \\r\\n    regime_tributario,\\r\\n    COUNT(DISTINCT id_documento) AS qtd_fiscalizacoes,\\r\\n    COUNT(DISTINCT cnpj) AS qtd_empresas,\\r\\n    ROUND(COUNT(DISTINCT cnpj) * 100.0 / SUM(COUNT(DISTINCT cnpj)) OVER(), 2) AS percentual,\\r\\n    \\r\\n    -- Valores\\r\\n    ROUND(SUM(valor_total_infracao) / 1000000, 2) AS total_infracoes_milhoes,\\r\\n    ROUND(AVG(valor_total_infracao), 2) AS media_infracao,\\r\\n    ROUND(SUM(valor_total_nf) / 1000000, 2) AS total_nfs_milhoes,\\r\\n    \\r\\n    -- Taxas\\r\\n    ROUND(SUM(gerou_notificacao) * 100.0 / COUNT(DISTINCT id_documento), 2) AS taxa_conversao_pct,\\r\\n    \\r\\n    -- Efetividade\\r\\n    ROUND(AVG(CASE WHEN gerou_notificacao = 1 THEN dias_infracao_ate_nf END), 0) AS media_dias_ate_nf\\r\\n    \\r\\nFROM teste.fisca_fiscalizacoes_consolidadas\\r\\nWHERE regime_tributario IS NOT NULL\\r\\nGROUP BY regime_tributario\\r\\nORDER BY qtd_empresas DESC;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- 1.4. TOP 30 SETORES (CNAE) FISCALIZADOS\\r\\n-- Objetivo: Identificar setores mais fiscalizados\\r\\nSELECT\\r\\n    '1.4. TOP 30 SETORES FISCALIZADOS' AS consulta,\\r\\n    \\r\\n    cnae_secao,\\r\\n    cnae_secao_descricao,\\r\\n    cnae_divisao,\\r\\n    cnae_divisao_descricao,\\r\\n    \\r\\n    COUNT(DISTINCT id_documento) AS qtd_fiscalizacoes,\\r\\n    COUNT(DISTINCT cnpj) AS qtd_empresas,\\r\\n    ROUND(COUNT(DISTINCT cnpj) * 100.0 / SUM(COUNT(DISTINCT cnpj)) OVER(), 2) AS percentual,\\r\\n    \\r\\n    -- Valores\\r\\n    ROUND(SUM(valor_total_infracao) / 1000000, 2) AS total_infracoes_milhoes,\\r\\n    ROUND(AVG(valor_total_infracao), 2) AS media_infracao,\\r\\n    ROUND(SUM(valor_total_nf) / 1000000, 2) AS total_nfs_milhoes,\\r\\n    \\r\\n    -- Notifica\\u00e7\\u00f5es\\r\\n    SUM(gerou_notificacao) AS qtd_nfs,\\r\\n    ROUND(SUM(gerou_notificacao) * 100.0 / COUNT(DISTINCT id_documento), 2) AS taxa_conversao_pct,\\r\\n    \\r\\n    -- Efetividade M\\u00e9dia\\r\\n    ROUND(AVG(CASE \\r\\n        WHEN gerou_notificacao = 1 THEN \\r\\n            (CASE WHEN dias_infracao_ate_nf <= 60 THEN 100\\r\\n                  WHEN dias_infracao_ate_nf <= 120 THEN 80\\r\\n                  WHEN dias_infracao_ate_nf <= 180 THEN 60\\r\\n                  ELSE 40 END)\\r\\n        ELSE 0 \\r\\n    END), 0) AS score_tempestividade_medio\\r\\n    \\r\\nFROM teste.fisca_fiscalizacoes_consolidadas\\r\\nWHERE cnae_secao IS NOT NULL\\r\\nGROUP BY cnae_secao, cnae_secao_descricao, cnae_divisao, cnae_divisao_descricao\\r\\nORDER BY total_infracoes_milhoes DESC\\r\\nLIMIT 30;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- 1.5. DISTRIBUI\\u00c7\\u00c3O GEOGR\\u00c1FICA (TOP 20 MUNIC\\u00cdPIOS)\\r\\n-- Objetivo: Concentra\\u00e7\\u00e3o geogr\\u00e1fica das fiscaliza\\u00e7\\u00f5es\\r\\nSELECT\\r\\n    '1.5. TOP 20 MUNIC\\u00cdPIOS' AS consulta,\\r\\n    \\r\\n    municipio,\\r\\n    uf,\\r\\n    COUNT(DISTINCT id_documento) AS qtd_fiscalizacoes,\\r\\n    COUNT(DISTINCT cnpj) AS qtd_empresas,\\r\\n    \\r\\n    -- Valores\\r\\n    ROUND(SUM(valor_total_infracao) / 1000000, 2) AS total_infracoes_milhoes,\\r\\n    ROUND(SUM(valor_total_nf) / 1000000, 2) AS total_nfs_milhoes,\\r\\n    \\r\\n    -- Notifica\\u00e7\\u00f5es\\r\\n    SUM(gerou_notificacao) AS qtd_nfs,\\r\\n    ROUND(SUM(gerou_notificacao) * 100.0 / COUNT(DISTINCT id_documento), 2) AS taxa_conversao_pct,\\r\\n    \\r\\n    -- Ciclos Completos\\r\\n    SUM(ciclo_completo) AS ciclos_completos,\\r\\n    ROUND(SUM(ciclo_completo) * 100.0 / COUNT(DISTINCT id_documento), 2) AS taxa_ciclo_completo_pct\\r\\n    \\r\\nFROM teste.fisca_fiscalizacoes_consolidadas\\r\\nWHERE municipio IS NOT NULL\\r\\nGROUP BY municipio, uf\\r\\nORDER BY qtd_fiscalizacoes DESC\\r\\nLIMIT 20;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- 1.6. AN\\u00c1LISE POR GER\\u00caNCIA (GRAF)\\r\\n-- Objetivo: Performance por ger\\u00eancia regional\\r\\nSELECT\\r\\n    '1.6. PERFORMANCE POR GER\\u00caNCIA' AS consulta,\\r\\n    \\r\\n    gerfe AS gerencia,\\r\\n    COUNT(DISTINCT id_documento) AS qtd_fiscalizacoes,\\r\\n    COUNT(DISTINCT cnpj) AS qtd_empresas,\\r\\n    \\r\\n    -- Valores\\r\\n    ROUND(SUM(valor_total_infracao) / 1000000, 2) AS total_infracoes_milhoes,\\r\\n    ROUND(SUM(valor_total_nf) / 1000000, 2) AS total_nfs_milhoes,\\r\\n    \\r\\n    -- Performance\\r\\n    SUM(gerou_notificacao) AS qtd_nfs,\\r\\n    ROUND(SUM(gerou_notificacao) * 100.0 / COUNT(DISTINCT id_documento), 2) AS taxa_conversao_pct,\\r\\n    SUM(ciclo_completo) AS ciclos_completos,\\r\\n    \\r\\n    -- Tempos\\r\\n    ROUND(AVG(dias_infracao_ate_nf), 0) AS media_dias_ate_nf,\\r\\n    \\r\\n    -- Efetividade\\r\\n    ROUND(AVG(CASE \\r\\n        WHEN gerou_notificacao = 1 THEN \\r\\n            ((CASE WHEN dias_infracao_ate_nf <= 60 THEN 100\\r\\n                   WHEN dias_infracao_ate_nf <= 120 THEN 80\\r\\n                   WHEN dias_infracao_ate_nf <= 180 THEN 60\\r\\n                   ELSE 40 END) * 0.4) +\\r\\n            ((CASE WHEN valor_total_nf >= valor_total_infracao * 0.8 THEN 100\\r\\n                   WHEN valor_total_nf >= valor_total_infracao * 0.6 THEN 80\\r\\n                   WHEN valor_total_nf >= valor_total_infracao * 0.4 THEN 60\\r\\n                   ELSE 40 END) * 0.6)\\r\\n        ELSE 0 \\r\\n    END), 0) AS score_efetividade_medio\\r\\n    \\r\\nFROM teste.fisca_fiscalizacoes_consolidadas\\r\\nWHERE gerfe IS NOT NULL\\r\\nGROUP BY gerfe\\r\\nORDER BY total_infracoes_milhoes DESC;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- ============================================================================\\r\\n-- SE\\u00c7\\u00c3O 2: AN\\u00c1LISES DE PERFORMANCE E EFETIVIDADE\\r\\n-- ============================================================================\\r\\n\\r\\n-- 2.1. TOP 100 FISCALIZA\\u00c7\\u00d5ES POR SCORE DE EFETIVIDADE\\r\\n-- Objetivo: Identificar fiscaliza\\u00e7\\u00f5es mais efetivas\\r\\nSELECT\\r\\n    '2.1. TOP 100 FISCALIZA\\u00c7\\u00d5ES MAIS EFETIVAS' AS consulta,\\r\\n    \\r\\n    ROW_NUMBER() OVER (ORDER BY score_efetividade_final DESC) AS ranking,\\r\\n    \\r\\n    se.cnpj,\\r\\n    se.nm_razao_social,\\r\\n    se.municipio,\\r\\n    se.regime_tributario,\\r\\n    se.cnae_secao_descricao,\\r\\n    se.ano_infracao,\\r\\n    \\r\\n    -- Valores\\r\\n    ROUND(se.valor_total_infracao / 1000, 2) AS valor_infracao_milhares,\\r\\n    ROUND(se.valor_total_nf / 1000, 2) AS valor_nf_milhares,\\r\\n    \\r\\n    -- Indicadores\\r\\n    se.gerou_notificacao,\\r\\n    se.ciclo_completo,\\r\\n    se.dias_infracao_ate_nf,\\r\\n    \\r\\n    -- Scores\\r\\n    se.score_geracao_nf,\\r\\n    se.score_ciclo,\\r\\n    se.score_valor_notificado,\\r\\n    se.score_tempestividade,\\r\\n    ROUND(se.score_efetividade_final, 2) AS score_final,\\r\\n    se.classificacao_efetividade\\r\\n    \\r\\nFROM teste.fisca_scores_efetividade se\\r\\nORDER BY se.score_efetividade_final DESC\\r\\nLIMIT 100;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- 2.2. DISTRIBUI\\u00c7\\u00c3O POR CLASSIFICA\\u00c7\\u00c3O DE EFETIVIDADE\\r\\n-- Objetivo: Entender distribui\\u00e7\\u00e3o de qualidade das fiscaliza\\u00e7\\u00f5es\\r\\nSELECT\\r\\n    '2.2. DISTRIBUI\\u00c7\\u00c3O POR EFETIVIDADE' AS consulta,\\r\\n    \\r\\n    classificacao_efetividade,\\r\\n    COUNT(*) AS qtd_fiscalizacoes,\\r\\n    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) AS percentual,\\r\\n    \\r\\n    -- Valores\\r\\n    ROUND(SUM(valor_total_infracao) / 1000000, 2) AS total_infracoes_milhoes,\\r\\n    ROUND(AVG(valor_total_infracao), 2) AS media_infracao,\\r\\n    ROUND(SUM(valor_total_nf) / 1000000, 2) AS total_nfs_milhoes,\\r\\n    \\r\\n    -- Scores M\\u00e9dios\\r\\n    ROUND(AVG(score_geracao_nf), 1) AS media_score_geracao_nf,\\r\\n    ROUND(AVG(score_ciclo), 1) AS media_score_ciclo,\\r\\n    ROUND(AVG(score_valor_notificado), 1) AS media_score_valor,\\r\\n    ROUND(AVG(score_tempestividade), 1) AS media_score_tempo,\\r\\n    ROUND(AVG(score_efetividade_final), 1) AS media_score_final,\\r\\n    \\r\\n    -- Tempos\\r\\n    ROUND(AVG(dias_infracao_ate_nf), 0) AS media_dias_ate_nf\\r\\n    \\r\\nFROM teste.fisca_scores_efetividade\\r\\nGROUP BY classificacao_efetividade\\r\\nORDER BY \\r\\n    CASE classificacao_efetividade\\r\\n        WHEN 'MUITO EFETIVA' THEN 1\\r\\n        WHEN 'EFETIVA' THEN 2\\r\\n        WHEN 'MODERADAMENTE EFETIVA' THEN 3\\r\\n        WHEN 'POUCO EFETIVA' THEN 4\\r\\n    END;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- 2.3. AN\\u00c1LISE DE TEMPESTIVIDADE\\r\\n-- Objetivo: Avaliar velocidade das fiscaliza\\u00e7\\u00f5es\\r\\nSELECT\\r\\n    '2.3. AN\\u00c1LISE DE TEMPESTIVIDADE' AS consulta,\\r\\n    \\r\\n    CASE\\r\\n        WHEN dias_infracao_ate_nf IS NULL THEN 'SEM NOTIFICA\\u00c7\\u00c3O'\\r\\n        WHEN dias_infracao_ate_nf <= 60 THEN '0-60 DIAS (\\u00d3TIMO)'\\r\\n        WHEN dias_infracao_ate_nf <= 120 THEN '61-120 DIAS (BOM)'\\r\\n        WHEN dias_infracao_ate_nf <= 180 THEN '121-180 DIAS (REGULAR)'\\r\\n        WHEN dias_infracao_ate_nf <= 365 THEN '181-365 DIAS (LENTO)'\\r\\n        ELSE '> 365 DIAS (MUITO LENTO)'\\r\\n    END AS faixa_tempo,\\r\\n    \\r\\n    COUNT(*) AS qtd_fiscalizacoes,\\r\\n    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) AS percentual,\\r\\n    \\r\\n    -- Valores\\r\\n    ROUND(SUM(valor_total_infracao) / 1000000, 2) AS total_infracoes_milhoes,\\r\\n    ROUND(SUM(valor_total_nf) / 1000000, 2) AS total_nfs_milhoes,\\r\\n    \\r\\n    -- M\\u00e9dias\\r\\n    ROUND(AVG(valor_total_infracao), 2) AS media_valor_infracao,\\r\\n    ROUND(AVG(dias_infracao_ate_nf), 0) AS media_dias,\\r\\n    \\r\\n    -- Score M\\u00e9dio\\r\\n    ROUND(AVG(score_efetividade_final), 1) AS score_efetividade_medio\\r\\n    \\r\\nFROM teste.fisca_scores_efetividade\\r\\nGROUP BY faixa_tempo\\r\\nORDER BY MIN(COALESCE(dias_infracao_ate_nf, 999999));\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- 2.4. AN\\u00c1LISE DE CONVERS\\u00c3O (INFRA\\u00c7\\u00c3O \\u2192 NF)\\r\\n-- Objetivo: Entender taxa de convers\\u00e3o por faixa de valor\\r\\nSELECT\\r\\n    '2.4. TAXA DE CONVERS\\u00c3O POR FAIXA DE VALOR' AS consulta,\\r\\n    \\r\\n    CASE\\r\\n        WHEN valor_total_infracao >= 1000000 THEN '\\u2265 R$ 1 MI (ALTO)'\\r\\n        WHEN valor_total_infracao >= 500000 THEN 'R$ 500K - 1 MI (M\\u00c9DIO-ALTO)'\\r\\n        WHEN valor_total_infracao >= 100000 THEN 'R$ 100K - 500K (M\\u00c9DIO)'\\r\\n        WHEN valor_total_infracao >= 50000 THEN 'R$ 50K - 100K (BAIXO)'\\r\\n        ELSE '< R$ 50K (MUITO BAIXO)'\\r\\n    END AS faixa_valor,\\r\\n    \\r\\n    COUNT(*) AS qtd_infracoes,\\r\\n    SUM(gerou_notificacao) AS qtd_nfs,\\r\\n    ROUND(SUM(gerou_notificacao) * 100.0 / COUNT(*), 2) AS taxa_conversao_pct,\\r\\n    \\r\\n    -- Valores\\r\\n    ROUND(SUM(valor_total_infracao) / 1000000, 2) AS total_infracoes_milhoes,\\r\\n    ROUND(SUM(valor_total_nf) / 1000000, 2) AS total_nfs_milhoes,\\r\\n    \\r\\n    -- Percentual notificado\\r\\n    ROUND(SUM(valor_total_nf) * 100.0 / NULLIF(SUM(valor_total_infracao), 0), 2) AS perc_valor_notificado,\\r\\n    \\r\\n    -- Tempos\\r\\n    ROUND(AVG(CASE WHEN gerou_notificacao = 1 THEN dias_infracao_ate_nf END), 0) AS media_dias_ate_nf,\\r\\n    \\r\\n    -- Score\\r\\n    ROUND(AVG(score_efetividade_final), 1) AS score_efetividade_medio\\r\\n    \\r\\nFROM teste.fisca_scores_efetividade\\r\\nGROUP BY faixa_valor\\r\\nORDER BY MIN(valor_total_infracao) DESC;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- ============================================================================\\r\\n-- SE\\u00c7\\u00c3O 3: AN\\u00c1LISES POR AFRE (PRODUTIVIDADE INDIVIDUAL)\\r\\n-- ============================================================================\\r\\n\\r\\n-- 3.1. TOP 50 AFREs POR PRODUTIVIDADE (ANO MAIS RECENTE)\\r\\n-- Objetivo: Ranking de performance individual\\r\\nWITH ano_recente AS (\\r\\n    SELECT MAX(ano) AS ano FROM teste.fisca_metricas_por_afre\\r\\n)\\r\\nSELECT\\r\\n    '3.1. TOP 50 AFREs - PRODUTIVIDADE' AS consulta,\\r\\n    \\r\\n    ROW_NUMBER() OVER (ORDER BY m.qtd_nfs DESC, m.valor_total_lancado DESC) AS ranking,\\r\\n    \\r\\n    m.matricula_afre,\\r\\n    m.nome_afre,\\r\\n    m.meses_ativos,\\r\\n    m.dias_ativos,\\r\\n    \\r\\n    -- Infra\\u00e7\\u00f5es\\r\\n    m.qtd_infracoes,\\r\\n    m.qtd_empresas_fiscalizadas,\\r\\n    ROUND(m.valor_total_infracoes / 1000, 2) AS valor_infracoes_milhares,\\r\\n    \\r\\n    -- Notifica\\u00e7\\u00f5es\\r\\n    m.qtd_nfs,\\r\\n    ROUND(m.valor_total_lancado / 1000, 2) AS valor_lancado_milhares,\\r\\n    \\r\\n    -- M\\u00e9tricas de Produtividade\\r\\n    ROUND(m.infracoes_por_mes, 2) AS infracoes_por_mes,\\r\\n    ROUND(m.nfs_por_mes, 2) AS nfs_por_mes,\\r\\n    ROUND(m.valor_medio_mensal / 1000, 2) AS valor_medio_mensal_milhares,\\r\\n    \\r\\n    -- Taxa de Convers\\u00e3o\\r\\n    ROUND(m.taxa_conversao_infracao_nf, 2) AS taxa_conversao_pct\\r\\n    \\r\\nFROM teste.fisca_metricas_por_afre m, ano_recente ar\\r\\nWHERE m.ano = ar.ano\\r\\n    AND m.meses_ativos >= 6  -- Pelo menos 6 meses ativos\\r\\nORDER BY m.qtd_nfs DESC, m.valor_total_lancado DESC\\r\\nLIMIT 50;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- 3.2. EVOLU\\u00c7\\u00c3O DE PRODUTIVIDADE DOS AFREs\\r\\n-- Objetivo: Acompanhar evolu\\u00e7\\u00e3o ao longo dos anos\\r\\nSELECT\\r\\n    '3.2. EVOLU\\u00c7\\u00c3O PRODUTIVIDADE AFREs' AS consulta,\\r\\n    \\r\\n    ano,\\r\\n    COUNT(DISTINCT matricula_afre) AS qtd_afres_ativos,\\r\\n    \\r\\n    -- Totais\\r\\n    SUM(qtd_infracoes) AS total_infracoes,\\r\\n    SUM(qtd_nfs) AS total_nfs,\\r\\n    ROUND(SUM(valor_total_infracoes) / 1000000, 2) AS total_infracoes_milhoes,\\r\\n    ROUND(SUM(valor_total_lancado) / 1000000, 2) AS total_lancado_milhoes,\\r\\n    \\r\\n    -- M\\u00e9dias por AFRE\\r\\n    ROUND(AVG(qtd_infracoes), 1) AS media_infracoes_por_afre,\\r\\n    ROUND(AVG(qtd_nfs), 1) AS media_nfs_por_afre,\\r\\n    ROUND(AVG(infracoes_por_mes), 2) AS media_infracoes_mes,\\r\\n    ROUND(AVG(nfs_por_mes), 2) AS media_nfs_mes,\\r\\n    \\r\\n    -- Taxa de Convers\\u00e3o M\\u00e9dia\\r\\n    ROUND(AVG(taxa_conversao_infracao_nf), 2) AS taxa_conversao_media_pct,\\r\\n    \\r\\n    -- Valores M\\u00e9dios\\r\\n    ROUND(AVG(valor_total_infracoes), 2) AS valor_medio_infracoes_por_afre,\\r\\n    ROUND(AVG(valor_medio_mensal), 2) AS valor_medio_mensal_por_afre\\r\\n    \\r\\nFROM teste.fisca_metricas_por_afre\\r\\nWHERE meses_ativos >= 6\\r\\nGROUP BY ano\\r\\nORDER BY ano DESC;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- 3.3. DISTRIBUI\\u00c7\\u00c3O DE PRODUTIVIDADE\\r\\n-- Objetivo: Identificar padr\\u00f5es de distribui\\u00e7\\u00e3o\\r\\nWITH ano_recente AS (\\r\\n    SELECT MAX(ano) AS ano FROM teste.fisca_metricas_por_afre\\r\\n)\\r\\nSELECT\\r\\n    '3.3. DISTRIBUI\\u00c7\\u00c3O DE PRODUTIVIDADE AFREs' AS consulta,\\r\\n    \\r\\n    CASE\\r\\n        WHEN nfs_por_mes >= 3.0 THEN 'MUITO ALTA (\\u22653 NFs/m\\u00eas)'\\r\\n        WHEN nfs_por_mes >= 2.0 THEN 'ALTA (2-3 NFs/m\\u00eas)'\\r\\n        WHEN nfs_por_mes >= 1.0 THEN 'M\\u00c9DIA (1-2 NFs/m\\u00eas)'\\r\\n        WHEN nfs_por_mes >= 0.5 THEN 'BAIXA (0,5-1 NF/m\\u00eas)'\\r\\n        ELSE 'MUITO BAIXA (<0,5 NF/m\\u00eas)'\\r\\n    END AS faixa_produtividade,\\r\\n    \\r\\n    COUNT(*) AS qtd_afres,\\r\\n    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) AS percentual,\\r\\n    \\r\\n    -- Totais\\r\\n    SUM(qtd_infracoes) AS total_infracoes,\\r\\n    SUM(qtd_nfs) AS total_nfs,\\r\\n    ROUND(SUM(valor_total_lancado) / 1000000, 2) AS total_lancado_milhoes,\\r\\n    \\r\\n    -- M\\u00e9dias\\r\\n    ROUND(AVG(infracoes_por_mes), 2) AS media_infracoes_mes,\\r\\n    ROUND(AVG(nfs_por_mes), 2) AS media_nfs_mes,\\r\\n    ROUND(AVG(taxa_conversao_infracao_nf), 2) AS taxa_conversao_media_pct\\r\\n    \\r\\nFROM teste.fisca_metricas_por_afre m, ano_recente ar\\r\\nWHERE m.ano = ar.ano\\r\\n    AND m.meses_ativos >= 6\\r\\nGROUP BY faixa_produtividade\\r\\nORDER BY MIN(nfs_por_mes) DESC;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- ============================================================================\\r\\n-- SE\\u00c7\\u00c3O 4: AN\\u00c1LISES DE TIPOS DE INFRA\\u00c7\\u00d5ES\\r\\n-- ============================================================================\\r\\n\\r\\n-- 4.1. TOP 30 INFRA\\u00c7\\u00d5ES MAIS COMUNS\\r\\n-- Objetivo: Identificar infra\\u00e7\\u00f5es mais frequentes\\r\\nSELECT\\r\\n    '4.1. TOP 30 INFRA\\u00c7\\u00d5ES MAIS COMUNS' AS consulta,\\r\\n    \\r\\n    ri.codigo_infracao,\\r\\n    ri.descricao_infracao,\\r\\n    ri.tipo_infracao,\\r\\n    \\r\\n    -- \\u00daltimos 3 anos combinados\\r\\n    SUM(ri.qtd_ocorrencias) AS total_ocorrencias,\\r\\n    SUM(ri.qtd_empresas) AS total_empresas,\\r\\n    SUM(ri.qtd_documentos) AS total_documentos,\\r\\n    \\r\\n    -- Valores\\r\\n    ROUND(SUM(ri.valor_total) / 1000000, 2) AS total_milhoes,\\r\\n    ROUND(AVG(ri.valor_medio), 2) AS valor_medio,\\r\\n    \\r\\n    -- Por ano\\r\\n    MAX(CASE WHEN ri.ano = YEAR(CURRENT_DATE()) THEN ri.qtd_ocorrencias ELSE 0 END) AS qtd_ano_atual,\\r\\n    MAX(CASE WHEN ri.ano = YEAR(CURRENT_DATE()) - 1 THEN ri.qtd_ocorrencias ELSE 0 END) AS qtd_ano_anterior,\\r\\n    MAX(CASE WHEN ri.ano = YEAR(CURRENT_DATE()) - 2 THEN ri.qtd_ocorrencias ELSE 0 END) AS qtd_ano_retrasado,\\r\\n    \\r\\n    -- Tend\\u00eancia\\r\\n    CASE \\r\\n        WHEN MAX(CASE WHEN ri.ano = YEAR(CURRENT_DATE()) - 1 THEN ri.qtd_ocorrencias END) > 0 \\r\\n        THEN ROUND((MAX(CASE WHEN ri.ano = YEAR(CURRENT_DATE()) THEN ri.qtd_ocorrencias ELSE 0 END) - \\r\\n                    MAX(CASE WHEN ri.ano = YEAR(CURRENT_DATE()) - 1 THEN ri.qtd_ocorrencias ELSE 0 END)) * 100.0 / \\r\\n                   MAX(CASE WHEN ri.ano = YEAR(CURRENT_DATE()) - 1 THEN ri.qtd_ocorrencias END), 1)\\r\\n        ELSE NULL \\r\\n    END AS variacao_pct_ano_anterior\\r\\n    \\r\\nFROM teste.fisca_ranking_infracoes ri\\r\\nWHERE ri.ano >= YEAR(CURRENT_DATE()) - 2\\r\\nGROUP BY ri.codigo_infracao, ri.descricao_infracao, ri.tipo_infracao\\r\\nHAVING SUM(ri.qtd_ocorrencias) > 0\\r\\nORDER BY SUM(ri.qtd_ocorrencias) DESC\\r\\nLIMIT 30;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- 4.2. INFRA\\u00c7\\u00d5ES COM MAIOR VALOR M\\u00c9DIO\\r\\n-- Objetivo: Identificar infra\\u00e7\\u00f5es de maior impacto financeiro\\r\\nSELECT\\r\\n    '4.2. INFRA\\u00c7\\u00d5ES COM MAIOR VALOR M\\u00c9DIO' AS consulta,\\r\\n    \\r\\n    ri.codigo_infracao,\\r\\n    ri.descricao_infracao,\\r\\n    ri.tipo_infracao,\\r\\n    \\r\\n    SUM(ri.qtd_ocorrencias) AS total_ocorrencias,\\r\\n    SUM(ri.qtd_empresas) AS total_empresas,\\r\\n    \\r\\n    -- Valores\\r\\n    ROUND(SUM(ri.valor_total) / 1000000, 2) AS total_milhoes,\\r\\n    ROUND(SUM(ri.valor_imposto) / 1000000, 2) AS imposto_milhoes,\\r\\n    ROUND(SUM(ri.valor_multa) / 1000000, 2) AS multa_milhoes,\\r\\n    ROUND(AVG(ri.valor_medio), 2) AS valor_medio,\\r\\n    ROUND(MAX(ri.valor_medio), 2) AS valor_maximo\\r\\n    \\r\\nFROM teste.fisca_ranking_infracoes ri\\r\\nWHERE ri.ano >= YEAR(CURRENT_DATE()) - 2\\r\\nGROUP BY ri.codigo_infracao, ri.descricao_infracao, ri.tipo_infracao\\r\\nHAVING SUM(ri.qtd_ocorrencias) >= 10  -- M\\u00ednimo 10 ocorr\\u00eancias\\r\\nORDER BY AVG(ri.valor_medio) DESC\\r\\nLIMIT 30;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- ============================================================================\\r\\n-- SE\\u00c7\\u00c3O 5: AN\\u00c1LISES COMPLETAS - DOSSI\\u00caS DETALHADOS\\r\\n-- ============================================================================\\r\\n\\r\\n-- 5.1. DOSSI\\u00ca COMPLETO DE EMPRESA\\r\\n-- Substitua 'CNPJ_AQUI' pelo CNPJ desejado\\r\\nSELECT\\r\\n    '5.1. DOSSI\\u00ca COMPLETO EMPRESA' AS consulta,\\r\\n    \\r\\n    -- Identifica\\u00e7\\u00e3o\\r\\n    fc.cnpj,\\r\\n    fc.nm_razao_social,\\r\\n    fc.nm_fantasia,\\r\\n    fc.municipio,\\r\\n    fc.uf,\\r\\n    fc.regime_tributario,\\r\\n    fc.nm_tipo_contribuinte,\\r\\n    fc.cnae_secao_descricao,\\r\\n    fc.cnae_divisao_descricao,\\r\\n    fc.cnae_descricao,\\r\\n    fc.gerfe,\\r\\n    fc.usefi,\\r\\n    \\r\\n    -- Fiscaliza\\u00e7\\u00e3o\\r\\n    fc.numero_infracao,\\r\\n    fc.data_infracao,\\r\\n    fc.tipo_infracao,\\r\\n    fc.ano_infracao,\\r\\n    \\r\\n    -- Valores Infra\\u00e7\\u00e3o\\r\\n    ROUND(fc.valor_total_infracao / 1000, 2) AS valor_infracao_milhares,\\r\\n    ROUND(fc.valor_imposto_infracao / 1000, 2) AS imposto_milhares,\\r\\n    ROUND(fc.valor_multa_infracao / 1000, 2) AS multa_milhares,\\r\\n    ROUND(fc.valor_juros_infracao / 1000, 2) AS juros_milhares,\\r\\n    \\r\\n    -- Notifica\\u00e7\\u00e3o\\r\\n    fc.numero_nf,\\r\\n    fc.data_nf,\\r\\n    fc.tipo_notificacao,\\r\\n    ROUND(fc.valor_total_nf / 1000, 2) AS valor_nf_milhares,\\r\\n    \\r\\n    -- Ci\\u00eancia\\r\\n    fc.data_ciencia_infracao,\\r\\n    fc.modo_ciencia_infracao,\\r\\n    fc.data_ciencia_nf,\\r\\n    \\r\\n    -- Defesa Pr\\u00e9via\\r\\n    fc.apresentou_dp_infracao,\\r\\n    fc.data_dp_infracao,\\r\\n    fc.pagou_dp_infracao,\\r\\n    \\r\\n    -- Encerramento\\r\\n    fc.numero_termo_encerramento,\\r\\n    fc.data_encerramento,\\r\\n    fc.teve_resultados,\\r\\n    fc.verificacoes_realizadas,\\r\\n    \\r\\n    -- Situa\\u00e7\\u00e3o\\r\\n    fc.situacao_final,\\r\\n    fc.gerou_notificacao,\\r\\n    fc.ciclo_completo,\\r\\n    \\r\\n    -- Tempos\\r\\n    fc.dias_infracao_ate_nf,\\r\\n    fc.dias_infracao_ate_encerramento,\\r\\n    \\r\\n    -- Score de Efetividade\\r\\n    se.score_efetividade_final,\\r\\n    se.classificacao_efetividade,\\r\\n    se.score_geracao_nf,\\r\\n    se.score_ciclo,\\r\\n    se.score_valor_notificado,\\r\\n    se.score_tempestividade\\r\\n    \\r\\nFROM teste.fisca_fiscalizacoes_consolidadas fc\\r\\nLEFT JOIN teste.fisca_scores_efetividade se\\r\\n    ON fc.id_documento = se.id_documento\\r\\nWHERE fc.cnpj = 'CNPJ_AQUI'  -- << MODIFICAR CNPJ AQUI\\r\\nORDER BY fc.data_infracao DESC;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- 5.2. AFREs QUE PARTICIPARAM DA FISCALIZA\\u00c7\\u00c3O\\r\\n-- Lista todos os auditores envolvidos\\r\\nSELECT\\r\\n    '5.2. AFREs DA FISCALIZA\\u00c7\\u00c3O' AS consulta,\\r\\n    \\r\\n    apd.matricula_afre,\\r\\n    apd.nome_afre,\\r\\n    apd.cargo,\\r\\n    apd.percentual_participacao,\\r\\n    apd.eh_coordenador,\\r\\n    \\r\\n    -- M\\u00e9tricas do AFRE (ano da fiscaliza\\u00e7\\u00e3o)\\r\\n    ma.qtd_infracoes AS total_infracoes_afre_ano,\\r\\n    ma.qtd_nfs AS total_nfs_afre_ano,\\r\\n    ROUND(ma.valor_total_lancado / 1000, 2) AS total_lancado_afre_milhares,\\r\\n    ROUND(ma.infracoes_por_mes, 2) AS produtividade_infracoes_mes,\\r\\n    ROUND(ma.nfs_por_mes, 2) AS produtividade_nfs_mes,\\r\\n    ROUND(ma.taxa_conversao_infracao_nf, 2) AS taxa_conversao_afre_pct\\r\\n    \\r\\nFROM teste.fisca_afres_por_documento apd\\r\\nINNER JOIN teste.fisca_fiscalizacoes_consolidadas fc\\r\\n    ON apd.id_documento = fc.id_documento\\r\\nLEFT JOIN teste.fisca_metricas_por_afre ma\\r\\n    ON apd.matricula_afre = ma.matricula_afre\\r\\n    AND fc.ano_infracao = ma.ano\\r\\nWHERE fc.cnpj = 'CNPJ_AQUI'  -- << MODIFICAR CNPJ AQUI\\r\\nORDER BY apd.percentual_participacao DESC;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- 5.3. HIST\\u00d3RICO COMPLETO DA EMPRESA\\r\\n-- Todas as fiscaliza\\u00e7\\u00f5es da empresa\\r\\nSELECT\\r\\n    '5.3. HIST\\u00d3RICO DE FISCALIZA\\u00c7\\u00d5ES DA EMPRESA' AS consulta,\\r\\n    \\r\\n    fc.data_infracao,\\r\\n    fc.numero_infracao,\\r\\n    fc.ano_infracao,\\r\\n    fc.tipo_infracao,\\r\\n    \\r\\n    -- Valores\\r\\n    ROUND(fc.valor_total_infracao / 1000, 2) AS valor_infracao_milhares,\\r\\n    ROUND(fc.valor_total_nf / 1000, 2) AS valor_nf_milhares,\\r\\n    \\r\\n    -- Situa\\u00e7\\u00e3o\\r\\n    fc.situacao_final,\\r\\n    fc.gerou_notificacao,\\r\\n    fc.ciclo_completo,\\r\\n    fc.dias_infracao_ate_nf,\\r\\n    \\r\\n    -- Notifica\\u00e7\\u00e3o\\r\\n    fc.numero_nf,\\r\\n    fc.data_nf,\\r\\n    \\r\\n    -- Score\\r\\n    ROUND(se.score_efetividade_final, 1) AS score_efetividade,\\r\\n    se.classificacao_efetividade\\r\\n    \\r\\nFROM teste.fisca_fiscalizacoes_consolidadas fc\\r\\nLEFT JOIN teste.fisca_scores_efetividade se\\r\\n    ON fc.id_documento = se.id_documento\\r\\nWHERE fc.cnpj = 'CNPJ_AQUI'  -- << MODIFICAR CNPJ AQUI\\r\\nORDER BY fc.data_infracao DESC;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- 5.4. EMPRESAS SIMILARES (MESMO CNAE E MUNIC\\u00cdPIO)\\r\\n-- Compara\\u00e7\\u00e3o com empresas do mesmo perfil\\r\\nSELECT\\r\\n    '5.4. EMPRESAS SIMILARES NO MESMO SETOR/REGI\\u00c3O' AS consulta,\\r\\n    \\r\\n    fc2.cnpj,\\r\\n    fc2.nm_razao_social,\\r\\n    fc2.municipio,\\r\\n    fc2.regime_tributario,\\r\\n    \\r\\n    COUNT(DISTINCT fc2.id_documento) AS qtd_fiscalizacoes,\\r\\n    SUM(fc2.gerou_notificacao) AS qtd_nfs,\\r\\n    \\r\\n    -- Valores Totais\\r\\n    ROUND(SUM(fc2.valor_total_infracao) / 1000, 2) AS total_infracoes_milhares,\\r\\n    ROUND(SUM(fc2.valor_total_nf) / 1000, 2) AS total_nfs_milhares,\\r\\n    \\r\\n    -- M\\u00e9dias\\r\\n    ROUND(AVG(fc2.valor_total_infracao), 2) AS media_infracao,\\r\\n    ROUND(AVG(fc2.dias_infracao_ate_nf), 0) AS media_dias_ate_nf,\\r\\n    \\r\\n    -- Taxa de Convers\\u00e3o\\r\\n    ROUND(SUM(fc2.gerou_notificacao) * 100.0 / COUNT(DISTINCT fc2.id_documento), 2) AS taxa_conversao_pct,\\r\\n    \\r\\n    -- Score M\\u00e9dio\\r\\n    ROUND(AVG(se2.score_efetividade_final), 1) AS score_medio_efetividade\\r\\n    \\r\\nFROM teste.fisca_fiscalizacoes_consolidadas fc1\\r\\nINNER JOIN teste.fisca_fiscalizacoes_consolidadas fc2\\r\\n    ON fc1.cnae_divisao = fc2.cnae_divisao\\r\\n    AND fc1.municipio = fc2.municipio\\r\\n    AND fc1.cnpj != fc2.cnpj\\r\\nLEFT JOIN teste.fisca_scores_efetividade se2\\r\\n    ON fc2.id_documento = se2.id_documento\\r\\nWHERE fc1.cnpj = 'CNPJ_AQUI'  -- << MODIFICAR CNPJ AQUI\\r\\nGROUP BY fc2.cnpj, fc2.nm_razao_social, fc2.municipio, fc2.regime_tributario\\r\\nORDER BY SUM(fc2.valor_total_nf) DESC\\r\\nLIMIT 20;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- ============================================================================\\r\\n-- SE\\u00c7\\u00c3O 6: AN\\u00c1LISES AVAN\\u00c7ADAS - PADR\\u00d5ES E TEND\\u00caNCIAS\\r\\n-- ============================================================================\\r\\n\\r\\n-- 6.1. EMPRESAS COM M\\u00daLTIPLAS FISCALIZA\\u00c7\\u00d5ES\\r\\n-- Objetivo: Identificar reincid\\u00eancias\\r\\nSELECT\\r\\n    '6.1. EMPRESAS COM M\\u00daLTIPLAS FISCALIZA\\u00c7\\u00d5ES' AS consulta,\\r\\n    \\r\\n    fc.cnpj,\\r\\n    fc.nm_razao_social,\\r\\n    fc.municipio,\\r\\n    fc.regime_tributario,\\r\\n    fc.cnae_secao_descricao,\\r\\n    \\r\\n    COUNT(DISTINCT fc.id_documento) AS qtd_fiscalizacoes,\\r\\n    COUNT(DISTINCT fc.ano_infracao) AS qtd_anos_fiscalizados,\\r\\n    \\r\\n    -- Primeira e \\u00faltima fiscaliza\\u00e7\\u00e3o\\r\\n    MIN(fc.data_infracao) AS primeira_fiscalizacao,\\r\\n    MAX(fc.data_infracao) AS ultima_fiscalizacao,\\r\\n    \\r\\n    -- Valores Totais\\r\\n    ROUND(SUM(fc.valor_total_infracao) / 1000, 2) AS total_infracoes_milhares,\\r\\n    ROUND(SUM(fc.valor_total_nf) / 1000, 2) AS total_nfs_milhares,\\r\\n    \\r\\n    -- Performance\\r\\n    SUM(fc.gerou_notificacao) AS qtd_nfs,\\r\\n    ROUND(SUM(fc.gerou_notificacao) * 100.0 / COUNT(DISTINCT fc.id_documento), 2) AS taxa_conversao_pct,\\r\\n    \\r\\n    -- Tipos de infra\\u00e7\\u00f5es distintas\\r\\n    COUNT(DISTINCT fc.tipo_infracao) AS tipos_infracoes_distintas,\\r\\n    \\r\\n    -- Score m\\u00e9dio\\r\\n    ROUND(AVG(se.score_efetividade_final), 1) AS score_medio_efetividade\\r\\n    \\r\\nFROM teste.fisca_fiscalizacoes_consolidadas fc\\r\\nLEFT JOIN teste.fisca_scores_efetividade se\\r\\n    ON fc.id_documento = se.id_documento\\r\\nGROUP BY fc.cnpj, fc.nm_razao_social, fc.municipio, fc.regime_tributario, fc.cnae_secao_descricao\\r\\nHAVING COUNT(DISTINCT fc.id_documento) >= 3  -- Pelo menos 3 fiscaliza\\u00e7\\u00f5es\\r\\nORDER BY COUNT(DISTINCT fc.id_documento) DESC, SUM(fc.valor_total_nf) DESC\\r\\nLIMIT 50;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- 6.2. AN\\u00c1LISE DE SAZONALIDADE\\r\\n-- Objetivo: Identificar padr\\u00f5es mensais de fiscaliza\\u00e7\\u00e3o\\r\\nSELECT\\r\\n    '6.2. AN\\u00c1LISE DE SAZONALIDADE' AS consulta,\\r\\n    \\r\\n    MONTH(data_infracao) AS mes,\\r\\n    CASE MONTH(data_infracao)\\r\\n        WHEN 1 THEN 'Janeiro'\\r\\n        WHEN 2 THEN 'Fevereiro'\\r\\n        WHEN 3 THEN 'Mar\\u00e7o'\\r\\n        WHEN 4 THEN 'Abril'\\r\\n        WHEN 5 THEN 'Maio'\\r\\n        WHEN 6 THEN 'Junho'\\r\\n        WHEN 7 THEN 'Julho'\\r\\n        WHEN 8 THEN 'Agosto'\\r\\n        WHEN 9 THEN 'Setembro'\\r\\n        WHEN 10 THEN 'Outubro'\\r\\n        WHEN 11 THEN 'Novembro'\\r\\n        WHEN 12 THEN 'Dezembro'\\r\\n    END AS nome_mes,\\r\\n    \\r\\n    COUNT(DISTINCT id_documento) AS qtd_fiscalizacoes,\\r\\n    COUNT(DISTINCT cnpj) AS qtd_empresas,\\r\\n    \\r\\n    -- Valores\\r\\n    ROUND(SUM(valor_total_infracao) / 1000000, 2) AS total_infracoes_milhoes,\\r\\n    ROUND(AVG(valor_total_infracao), 2) AS media_valor_infracao,\\r\\n    \\r\\n    -- Notifica\\u00e7\\u00f5es\\r\\n    SUM(gerou_notificacao) AS qtd_nfs,\\r\\n    ROUND(SUM(gerou_notificacao) * 100.0 / COUNT(DISTINCT id_documento), 2) AS taxa_conversao_pct,\\r\\n    \\r\\n    -- Tempo m\\u00e9dio\\r\\n    ROUND(AVG(dias_infracao_ate_nf), 0) AS media_dias_ate_nf\\r\\n    \\r\\nFROM teste.fisca_fiscalizacoes_consolidadas\\r\\nWHERE ano_infracao >= YEAR(CURRENT_DATE()) - 3\\r\\nGROUP BY MONTH(data_infracao)\\r\\nORDER BY mes;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- 6.3. EVOLU\\u00c7\\u00c3O MENSAL DOS \\u00daLTIMOS 24 MESES\\r\\n-- Objetivo: Tend\\u00eancia recente detalhada\\r\\nSELECT\\r\\n    '6.3. EVOLU\\u00c7\\u00c3O MENSAL \\u00daLTIMOS 24 MESES' AS consulta,\\r\\n    \\r\\n    YEAR(data_infracao) AS ano,\\r\\n    MONTH(data_infracao) AS mes,\\r\\n    CONCAT(CAST(YEAR(data_infracao) AS STRING), '-', \\r\\n           LPAD(CAST(MONTH(data_infracao) AS STRING), 2, '0')) AS ano_mes,\\r\\n    \\r\\n    COUNT(DISTINCT id_documento) AS qtd_fiscalizacoes,\\r\\n    COUNT(DISTINCT cnpj) AS qtd_empresas,\\r\\n    SUM(gerou_notificacao) AS qtd_nfs,\\r\\n    \\r\\n    -- Valores\\r\\n    ROUND(SUM(valor_total_infracao) / 1000000, 2) AS total_infracoes_milhoes,\\r\\n    ROUND(SUM(valor_total_nf) / 1000000, 2) AS total_nfs_milhoes,\\r\\n    \\r\\n    -- Taxas\\r\\n    ROUND(SUM(gerou_notificacao) * 100.0 / COUNT(DISTINCT id_documento), 2) AS taxa_conversao_pct,\\r\\n    \\r\\n    -- Tempos\\r\\n    ROUND(AVG(dias_infracao_ate_nf), 0) AS media_dias_ate_nf,\\r\\n    \\r\\n    -- Acumulado do ano\\r\\n    ROUND(SUM(SUM(valor_total_nf)) OVER (\\r\\n        PARTITION BY YEAR(data_infracao) \\r\\n        ORDER BY MONTH(data_infracao)\\r\\n        ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW\\r\\n    ) / 1000000, 2) AS acumulado_ano_milhoes\\r\\n    \\r\\nFROM teste.fisca_fiscalizacoes_consolidadas\\r\\nWHERE data_infracao >= ADD_MONTHS(CURRENT_DATE(), -24)\\r\\nGROUP BY YEAR(data_infracao), MONTH(data_infracao)\\r\\nORDER BY ano DESC, mes DESC;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- 6.4. AN\\u00c1LISE DE CORRELA\\u00c7\\u00c3O: SETOR vs EFETIVIDADE\\r\\n-- Objetivo: Identificar setores com melhor/pior efetividade\\r\\nSELECT\\r\\n    '6.4. EFETIVIDADE POR SETOR' AS consulta,\\r\\n    \\r\\n    fc.cnae_secao,\\r\\n    fc.cnae_secao_descricao,\\r\\n    \\r\\n    COUNT(DISTINCT fc.id_documento) AS qtd_fiscalizacoes,\\r\\n    COUNT(DISTINCT fc.cnpj) AS qtd_empresas,\\r\\n    \\r\\n    -- Valores\\r\\n    ROUND(SUM(fc.valor_total_infracao) / 1000000, 2) AS total_infracoes_milhoes,\\r\\n    ROUND(SUM(fc.valor_total_nf) / 1000000, 2) AS total_nfs_milhoes,\\r\\n    \\r\\n    -- Performance\\r\\n    ROUND(SUM(fc.gerou_notificacao) * 100.0 / COUNT(DISTINCT fc.id_documento), 2) AS taxa_conversao_pct,\\r\\n    ROUND(SUM(fc.ciclo_completo) * 100.0 / COUNT(DISTINCT fc.id_documento), 2) AS taxa_ciclo_completo_pct,\\r\\n    \\r\\n    -- Tempos\\r\\n    ROUND(AVG(fc.dias_infracao_ate_nf), 0) AS media_dias_ate_nf,\\r\\n    \\r\\n    -- Scores de Efetividade\\r\\n    ROUND(AVG(se.score_efetividade_final), 1) AS score_medio_efetividade,\\r\\n    ROUND(AVG(se.score_tempestividade), 1) AS score_medio_tempestividade,\\r\\n    ROUND(AVG(se.score_valor_notificado), 1) AS score_medio_valor,\\r\\n    \\r\\n    -- Distribui\\u00e7\\u00e3o de classifica\\u00e7\\u00e3o\\r\\n    COUNT(CASE WHEN se.classificacao_efetividade = 'MUITO EFETIVA' THEN 1 END) AS qtd_muito_efetiva,\\r\\n    COUNT(CASE WHEN se.classificacao_efetividade = 'EFETIVA' THEN 1 END) AS qtd_efetiva,\\r\\n    COUNT(CASE WHEN se.classificacao_efetividade = 'MODERADAMENTE EFETIVA' THEN 1 END) AS qtd_moderada,\\r\\n    COUNT(CASE WHEN se.classificacao_efetividade = 'POUCO EFETIVA' THEN 1 END) AS qtd_pouco_efetiva\\r\\n    \\r\\nFROM teste.fisca_fiscalizacoes_consolidadas fc\\r\\nLEFT JOIN teste.fisca_scores_efetividade se\\r\\n    ON fc.id_documento = se.id_documento\\r\\nWHERE fc.cnae_secao IS NOT NULL\\r\\n    AND fc.ano_infracao >= YEAR(CURRENT_DATE()) - 3\\r\\nGROUP BY fc.cnae_secao, fc.cnae_secao_descricao\\r\\nHAVING COUNT(DISTINCT fc.id_documento) >= 20  -- M\\u00ednimo 20 fiscaliza\\u00e7\\u00f5es\\r\\nORDER BY AVG(se.score_efetividade_final) DESC;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- ============================================================================\\r\\n-- SE\\u00c7\\u00c3O 7: ALERTAS E PRIORIDADES\\r\\n-- ============================================================================\\r\\n\\r\\n-- 7.1. FISCALIZA\\u00c7\\u00d5ES EM ANDAMENTO - SITUA\\u00c7\\u00c3O CR\\u00cdTICA\\r\\n-- Objetivo: Identificar casos que precisam de aten\\u00e7\\u00e3o\\r\\nSELECT\\r\\n    '7.1. FISCALIZA\\u00c7\\u00d5ES CR\\u00cdTICAS EM ANDAMENTO' AS consulta,\\r\\n    \\r\\n    ROW_NUMBER() OVER (ORDER BY \\r\\n        CASE \\r\\n            WHEN fc.data_infracao < ADD_MONTHS(CURRENT_DATE(), -12) THEN 1\\r\\n            WHEN fc.valor_total_infracao >= 500000 AND fc.gerou_notificacao = 0 THEN 2\\r\\n            WHEN fc.data_infracao < ADD_MONTHS(CURRENT_DATE(), -6) THEN 3\\r\\n            ELSE 4\\r\\n        END,\\r\\n        fc.valor_total_infracao DESC\\r\\n    ) AS prioridade,\\r\\n    \\r\\n    fc.cnpj,\\r\\n    fc.nm_razao_social,\\r\\n    fc.municipio,\\r\\n    fc.gerfe,\\r\\n    \\r\\n    -- Fiscaliza\\u00e7\\u00e3o\\r\\n    fc.numero_infracao,\\r\\n    fc.data_infracao,\\r\\n    DATEDIFF(CURRENT_DATE(), fc.data_infracao) AS dias_desde_infracao,\\r\\n    \\r\\n    -- Valores\\r\\n    ROUND(fc.valor_total_infracao / 1000, 2) AS valor_infracao_milhares,\\r\\n    \\r\\n    -- Situa\\u00e7\\u00e3o\\r\\n    fc.situacao_final,\\r\\n    fc.gerou_notificacao,\\r\\n    \\r\\n    -- Alerta\\r\\n    CASE \\r\\n        WHEN fc.data_infracao < ADD_MONTHS(CURRENT_DATE(), -12) \\r\\n        THEN 'CR\\u00cdTICO: > 12 MESES SEM NOTIFICA\\u00c7\\u00c3O'\\r\\n        \\r\\n        WHEN fc.valor_total_infracao >= 500000 AND fc.gerou_notificacao = 0 \\r\\n        THEN 'CR\\u00cdTICO: ALTO VALOR SEM NOTIFICA\\u00c7\\u00c3O'\\r\\n        \\r\\n        WHEN fc.data_infracao < ADD_MONTHS(CURRENT_DATE(), -6) \\r\\n        THEN 'ALTO: > 6 MESES SEM NOTIFICA\\u00c7\\u00c3O'\\r\\n        \\r\\n        WHEN fc.data_infracao < ADD_MONTHS(CURRENT_DATE(), -3) \\r\\n        THEN 'M\\u00c9DIO: > 3 MESES SEM NOTIFICA\\u00c7\\u00c3O'\\r\\n        \\r\\n        ELSE 'MONITORAMENTO: < 3 MESES'\\r\\n    END AS tipo_alerta,\\r\\n    \\r\\n    -- A\\u00e7\\u00e3o Sugerida\\r\\n    CASE \\r\\n        WHEN fc.data_infracao < ADD_MONTHS(CURRENT_DATE(), -12) \\r\\n        THEN 'URGENTE: Verificar motivo da demora e priorizar emiss\\u00e3o'\\r\\n        \\r\\n        WHEN fc.valor_total_infracao >= 500000 AND fc.gerou_notificacao = 0 \\r\\n        THEN 'URGENTE: Priorizar por alto impacto financeiro'\\r\\n        \\r\\n        WHEN fc.data_infracao < ADD_MONTHS(CURRENT_DATE(), -6) \\r\\n        THEN 'Acelerar processo de notifica\\u00e7\\u00e3o'\\r\\n        \\r\\n        ELSE 'Acompanhar evolu\\u00e7\\u00e3o normal'\\r\\n    END AS acao_sugerida\\r\\n    \\r\\nFROM teste.fisca_fiscalizacoes_consolidadas fc\\r\\nWHERE fc.gerou_notificacao = 0\\r\\n    AND fc.data_infracao >= ADD_MONTHS(CURRENT_DATE(), -24)\\r\\nORDER BY prioridade, fc.valor_total_infracao DESC\\r\\nLIMIT 100;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- 7.2. EMPRESAS COM PADR\\u00c3O DE ALTO RISCO\\r\\n-- Objetivo: Identificar contribuintes problem\\u00e1ticos\\r\\nSELECT\\r\\n    '7.2. EMPRESAS COM PADR\\u00c3O DE ALTO RISCO' AS consulta,\\r\\n    \\r\\n    fc.cnpj,\\r\\n    fc.nm_razao_social,\\r\\n    fc.municipio,\\r\\n    fc.regime_tributario,\\r\\n    fc.cnae_secao_descricao,\\r\\n    \\r\\n    COUNT(DISTINCT fc.id_documento) AS qtd_fiscalizacoes,\\r\\n    COUNT(DISTINCT fc.ano_infracao) AS qtd_anos_distintos,\\r\\n    \\r\\n    -- Valores\\r\\n    ROUND(SUM(fc.valor_total_infracao) / 1000, 2) AS total_infracoes_milhares,\\r\\n    ROUND(AVG(fc.valor_total_infracao), 2) AS media_por_fiscalizacao,\\r\\n    \\r\\n    -- Performance\\r\\n    ROUND(SUM(fc.gerou_notificacao) * 100.0 / COUNT(DISTINCT fc.id_documento), 2) AS taxa_conversao_pct,\\r\\n    \\r\\n    -- Tipos de infra\\u00e7\\u00f5es\\r\\n    COUNT(DISTINCT fc.tipo_infracao) AS tipos_infracoes_distintas,\\r\\n    \\r\\n    -- Temporalidade\\r\\n    MIN(fc.data_infracao) AS primeira_fiscalizacao,\\r\\n    MAX(fc.data_infracao) AS ultima_fiscalizacao,\\r\\n    DATEDIFF(MAX(fc.data_infracao), MIN(fc.data_infracao)) AS dias_entre_primeira_ultima,\\r\\n    \\r\\n    -- Score de Risco\\r\\n    CASE \\r\\n        WHEN COUNT(DISTINCT fc.id_documento) >= 5 AND \\r\\n             SUM(fc.valor_total_infracao) >= 1000000 AND\\r\\n             COUNT(DISTINCT fc.ano_infracao) >= 3 \\r\\n        THEN 'RISCO CR\\u00cdTICO'\\r\\n        \\r\\n        WHEN COUNT(DISTINCT fc.id_documento) >= 3 AND \\r\\n             SUM(fc.valor_total_infracao) >= 500000 \\r\\n        THEN 'RISCO ALTO'\\r\\n        \\r\\n        WHEN COUNT(DISTINCT fc.id_documento) >= 3 OR \\r\\n             SUM(fc.valor_total_infracao) >= 300000 \\r\\n        THEN 'RISCO MODERADO'\\r\\n        \\r\\n        ELSE 'RISCO BAIXO'\\r\\n    END AS classificacao_risco,\\r\\n    \\r\\n    -- Recomenda\\u00e7\\u00e3o\\r\\n    CASE \\r\\n        WHEN COUNT(DISTINCT fc.id_documento) >= 5 \\r\\n        THEN 'Indicar para Grupo Especial de Fiscaliza\\u00e7\\u00e3o'\\r\\n        \\r\\n        WHEN COUNT(DISTINCT fc.ano_infracao) >= 3 \\r\\n        THEN 'Acompanhamento Cont\\u00ednuo Obrigat\\u00f3rio'\\r\\n        \\r\\n        WHEN SUM(fc.valor_total_infracao) >= 1000000 \\r\\n        THEN 'Priorizar Fechamento dos Casos Pendentes'\\r\\n        \\r\\n        ELSE 'Monitoramento Regular'\\r\\n    END AS recomendacao\\r\\n    \\r\\nFROM teste.fisca_fiscalizacoes_consolidadas fc\\r\\nWHERE fc.ano_infracao >= YEAR(CURRENT_DATE()) - 5\\r\\nGROUP BY fc.cnpj, fc.nm_razao_social, fc.municipio, fc.regime_tributario, fc.cnae_secao_descricao\\r\\nHAVING COUNT(DISTINCT fc.id_documento) >= 3\\r\\n    OR SUM(fc.valor_total_infracao) >= 300000\\r\\nORDER BY \\r\\n    CASE \\r\\n        WHEN COUNT(DISTINCT fc.id_documento) >= 5 AND SUM(fc.valor_total_infracao) >= 1000000 THEN 1\\r\\n        WHEN COUNT(DISTINCT fc.id_documento) >= 3 AND SUM(fc.valor_total_infracao) >= 500000 THEN 2\\r\\n        ELSE 3\\r\\n    END,\\r\\n    SUM(fc.valor_total_infracao) DESC\\r\\nLIMIT 50;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- ============================================================================\\r\\n-- SE\\u00c7\\u00c3O 8: DASHBOARD COMPARATIVO - BENCHMARKS\\r\\n-- ============================================================================\\r\\n\\r\\n-- 8.1. COMPARATIVO DE GER\\u00caNCIAS (RANKING)\\r\\n-- Objetivo: Benchmark entre ger\\u00eancias regionais\\r\\nWITH ranking_gerencias AS (\\r\\n    SELECT\\r\\n        gerfe,\\r\\n        ano_infracao,\\r\\n        COUNT(DISTINCT id_documento) AS qtd_fiscalizacoes,\\r\\n        SUM(gerou_notificacao) AS qtd_nfs,\\r\\n        ROUND(SUM(valor_total_nf) / 1000000, 2) AS total_lancado_milhoes,\\r\\n        ROUND(SUM(gerou_notificacao) * 100.0 / COUNT(DISTINCT id_documento), 2) AS taxa_conversao,\\r\\n        ROUND(AVG(dias_infracao_ate_nf), 0) AS media_dias\\r\\n    FROM teste.fisca_fiscalizacoes_consolidadas\\r\\n    WHERE gerfe IS NOT NULL\\r\\n        AND ano_infracao >= YEAR(CURRENT_DATE()) - 2\\r\\n    GROUP BY gerfe, ano_infracao\\r\\n),\\r\\nstats_gerais AS (\\r\\n    SELECT\\r\\n        ano_infracao,\\r\\n        AVG(taxa_conversao) AS media_geral_taxa,\\r\\n        AVG(media_dias) AS media_geral_dias,\\r\\n        AVG(total_lancado_milhoes) AS media_geral_valor\\r\\n    FROM ranking_gerencias\\r\\n    GROUP BY ano_infracao\\r\\n)\\r\\nSELECT\\r\\n    '8.1. RANKING E BENCHMARK DE GER\\u00caNCIAS' AS consulta,\\r\\n    \\r\\n    rg.gerfe,\\r\\n    rg.ano_infracao,\\r\\n    \\r\\n    -- Volumes\\r\\n    rg.qtd_fiscalizacoes,\\r\\n    rg.qtd_nfs,\\r\\n    rg.total_lancado_milhoes,\\r\\n    \\r\\n    -- Performance\\r\\n    rg.taxa_conversao AS taxa_conversao_pct,\\r\\n    ROUND(rg.taxa_conversao - sg.media_geral_taxa, 2) AS diferenca_vs_media_taxa,\\r\\n    \\r\\n    rg.media_dias,\\r\\n    ROUND(rg.media_dias - sg.media_geral_dias, 0) AS diferenca_vs_media_dias,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o\\r\\n    ROW_NUMBER() OVER (PARTITION BY rg.ano_infracao ORDER BY rg.total_lancado_milhoes DESC) AS ranking_valor,\\r\\n    ROW_NUMBER() OVER (PARTITION BY rg.ano_infracao ORDER BY rg.taxa_conversao DESC) AS ranking_conversao,\\r\\n    ROW_NUMBER() OVER (PARTITION BY rg.ano_infracao ORDER BY rg.media_dias ASC) AS ranking_tempestividade,\\r\\n    \\r\\n    -- M\\u00e9dias Gerais (para compara\\u00e7\\u00e3o)\\r\\n    sg.media_geral_taxa AS media_taxa_todas_gerencias,\\r\\n    sg.media_geral_dias AS media_dias_todas_gerencias,\\r\\n    sg.media_geral_valor AS media_valor_todas_gerencias\\r\\n    \\r\\nFROM ranking_gerencias rg\\r\\nINNER JOIN stats_gerais sg ON rg.ano_infracao = sg.ano_infracao\\r\\nORDER BY rg.ano_infracao DESC, rg.total_lancado_milhoes DESC;\", \"statementsList\": [\"\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- ============================================================================\\r\\n-- SE\\u00c7\\u00c3O 4: AN\\u00c1LISES DE TIPOS DE INFRA\\u00c7\\u00d5ES\\r\\n-- ============================================================================\\r\\n\\r\\n-- 4.1. TOP 30 INFRA\\u00c7\\u00d5ES MAIS COMUNS\\r\\n-- Objetivo: Identificar infra\\u00e7\\u00f5es mais frequentes\\r\\nSELECT\\r\\n    '4.1. TOP 30 INFRA\\u00c7\\u00d5ES MAIS COMUNS' AS consulta,\\r\\n    \\r\\n    ri.codigo_infracao,\\r\\n    ri.descricao_infracao,\\r\\n    ri.tipo_infracao,\\r\\n    \\r\\n    -- \\u00daltimos 3 anos combinados\\r\\n    SUM(ri.qtd_ocorrencias) AS total_ocorrencias,\\r\\n    SUM(ri.qtd_empresas) AS total_empresas,\\r\\n    SUM(ri.qtd_documentos) AS total_documentos,\\r\\n    \\r\\n    -- Valores\\r\\n    ROUND(SUM(ri.valor_total) / 1000000, 2) AS total_milhoes,\\r\\n    ROUND(AVG(ri.valor_medio), 2) AS valor_medio,\\r\\n    \\r\\n    -- Por ano\\r\\n    MAX(CASE WHEN ri.ano = YEAR(CURRENT_DATE()) THEN ri.qtd_ocorrencias ELSE 0 END) AS qtd_ano_atual,\\r\\n    MAX(CASE WHEN ri.ano = YEAR(CURRENT_DATE()) - 1 THEN ri.qtd_ocorrencias ELSE 0 END) AS qtd_ano_anterior,\\r\\n    MAX(CASE WHEN ri.ano = YEAR(CURRENT_DATE()) - 2 THEN ri.qtd_ocorrencias ELSE 0 END) AS qtd_ano_retrasado,\\r\\n    \\r\\n    -- Tend\\u00eancia\\r\\n    CASE \\r\\n        WHEN MAX(CASE WHEN ri.ano = YEAR(CURRENT_DATE()) - 1 THEN ri.qtd_ocorrencias END) > 0 \\r\\n        THEN ROUND((MAX(CASE WHEN ri.ano = YEAR(CURRENT_DATE()) THEN ri.qtd_ocorrencias ELSE 0 END) - \\r\\n                    MAX(CASE WHEN ri.ano = YEAR(CURRENT_DATE()) - 1 THEN ri.qtd_ocorrencias ELSE 0 END)) * 100.0 / \\r\\n                   MAX(CASE WHEN ri.ano = YEAR(CURRENT_DATE()) - 1 THEN ri.qtd_ocorrencias END), 1)\\r\\n        ELSE NULL \\r\\n    END AS variacao_pct_ano_anterior\\r\\n    \\r\\nFROM teste.fisca_ranking_infracoes ri\\r\\nWHERE ri.ano >= YEAR(CURRENT_DATE()) - 2\\r\\nGROUP BY ri.codigo_infracao, ri.descricao_infracao, ri.tipo_infracao\\r\\nHAVING SUM(ri.qtd_ocorrencias) > 0\\r\\nORDER BY SUM(ri.qtd_ocorrencias) DESC\\r\\nLIMIT 30;\", \"\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- 4.2. INFRA\\u00c7\\u00d5ES COM MAIOR VALOR M\\u00c9DIO\\r\\n-- Objetivo: Identificar infra\\u00e7\\u00f5es de maior impacto financeiro\\r\\nSELECT\\r\\n    '4.2. INFRA\\u00c7\\u00d5ES COM MAIOR VALOR M\\u00c9DIO' AS consulta,\\r\\n    \\r\\n    ri.codigo_infracao,\\r\\n    ri.descricao_infracao,\\r\\n    ri.tipo_infracao,\\r\\n    \\r\\n    SUM(ri.qtd_ocorrencias) AS total_ocorrencias,\\r\\n    SUM(ri.qtd_empresas) AS total_empresas,\\r\\n    \\r\\n    -- Valores\\r\\n    ROUND(SUM(ri.valor_total) / 1000000, 2) AS total_milhoes,\\r\\n    ROUND(SUM(ri.valor_imposto) / 1000000, 2) AS imposto_milhoes,\\r\\n    ROUND(SUM(ri.valor_multa) / 1000000, 2) AS multa_milhoes,\\r\\n    ROUND(AVG(ri.valor_medio), 2) AS valor_medio,\\r\\n    ROUND(MAX(ri.valor_medio), 2) AS valor_maximo\\r\\n    \\r\\nFROM teste.fisca_ranking_infracoes ri\\r\\nWHERE ri.ano >= YEAR(CURRENT_DATE()) - 2\\r\\nGROUP BY ri.codigo_infracao, ri.descricao_infracao, ri.tipo_infracao\\r\\nHAVING SUM(ri.qtd_ocorrencias) >= 10  -- M\\u00ednimo 10 ocorr\\u00eancias\\r\\nORDER BY AVG(ri.valor_medio) DESC\\r\\nLIMIT 30;\", \"\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- ============================================================================\\r\\n-- SE\\u00c7\\u00c3O 5: AN\\u00c1LISES COMPLETAS - DOSSI\\u00caS DETALHADOS\\r\\n-- ============================================================================\\r\\n\\r\\n-- 5.1. DOSSI\\u00ca COMPLETO DE EMPRESA\\r\\n-- Substitua 'CNPJ_AQUI' pelo CNPJ desejado\\r\\nSELECT\\r\\n    '5.1. DOSSI\\u00ca COMPLETO EMPRESA' AS consulta,\\r\\n    \\r\\n    -- Identifica\\u00e7\\u00e3o\\r\\n    fc.cnpj,\\r\\n    fc.nm_razao_social,\\r\\n    fc.nm_fantasia,\\r\\n    fc.municipio,\\r\\n    fc.uf,\\r\\n    fc.regime_tributario,\\r\\n    fc.nm_tipo_contribuinte,\\r\\n    fc.cnae_secao_descricao,\\r\\n    fc.cnae_divisao_descricao,\\r\\n    fc.cnae_descricao,\\r\\n    fc.gerfe,\\r\\n    fc.usefi,\\r\\n    \\r\\n    -- Fiscaliza\\u00e7\\u00e3o\\r\\n    fc.numero_infracao,\\r\\n    fc.data_infracao,\\r\\n    fc.tipo_infracao,\\r\\n    fc.ano_infracao,\\r\\n    \\r\\n    -- Valores Infra\\u00e7\\u00e3o\\r\\n    ROUND(fc.valor_total_infracao / 1000, 2) AS valor_infracao_milhares,\\r\\n    ROUND(fc.valor_imposto_infracao / 1000, 2) AS imposto_milhares,\\r\\n    ROUND(fc.valor_multa_infracao / 1000, 2) AS multa_milhares,\\r\\n    ROUND(fc.valor_juros_infracao / 1000, 2) AS juros_milhares,\\r\\n    \\r\\n    -- Notifica\\u00e7\\u00e3o\\r\\n    fc.numero_nf,\\r\\n    fc.data_nf,\\r\\n    fc.tipo_notificacao,\\r\\n    ROUND(fc.valor_total_nf / 1000, 2) AS valor_nf_milhares,\\r\\n    \\r\\n    -- Ci\\u00eancia\\r\\n    fc.data_ciencia_infracao,\\r\\n    fc.modo_ciencia_infracao,\\r\\n    fc.data_ciencia_nf,\\r\\n    \\r\\n    -- Defesa Pr\\u00e9via\\r\\n    fc.apresentou_dp_infracao,\\r\\n    fc.data_dp_infracao,\\r\\n    fc.pagou_dp_infracao,\\r\\n    \\r\\n    -- Encerramento\\r\\n    fc.numero_termo_encerramento,\\r\\n    fc.data_encerramento,\\r\\n    fc.teve_resultados,\\r\\n    fc.verificacoes_realizadas,\\r\\n    \\r\\n    -- Situa\\u00e7\\u00e3o\\r\\n    fc.situacao_final,\\r\\n    fc.gerou_notificacao,\\r\\n    fc.ciclo_completo,\\r\\n    \\r\\n    -- Tempos\\r\\n    fc.dias_infracao_ate_nf,\\r\\n    fc.dias_infracao_ate_encerramento,\\r\\n    \\r\\n    -- Score de Efetividade\\r\\n    se.score_efetividade_final,\\r\\n    se.classificacao_efetividade,\\r\\n    se.score_geracao_nf,\\r\\n    se.score_ciclo,\\r\\n    se.score_valor_notificado,\\r\\n    se.score_tempestividade\\r\\n    \\r\\nFROM teste.fisca_fiscalizacoes_consolidadas fc\\r\\nLEFT JOIN teste.fisca_scores_efetividade se\\r\\n    ON fc.id_documento = se.id_documento\\r\\nWHERE fc.cnpj = 'CNPJ_AQUI'  -- << MODIFICAR CNPJ AQUI\\r\\nORDER BY fc.data_infracao DESC;\", \"\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- 5.2. AFREs QUE PARTICIPARAM DA FISCALIZA\\u00c7\\u00c3O\\r\\n-- Lista todos os auditores envolvidos\\r\\nSELECT\\r\\n    '5.2. AFREs DA FISCALIZA\\u00c7\\u00c3O' AS consulta,\\r\\n    \\r\\n    apd.matricula_afre,\\r\\n    apd.nome_afre,\\r\\n    apd.cargo,\\r\\n    apd.percentual_participacao,\\r\\n    apd.eh_coordenador,\\r\\n    \\r\\n    -- M\\u00e9tricas do AFRE (ano da fiscaliza\\u00e7\\u00e3o)\\r\\n    ma.qtd_infracoes AS total_infracoes_afre_ano,\\r\\n    ma.qtd_nfs AS total_nfs_afre_ano,\\r\\n    ROUND(ma.valor_total_lancado / 1000, 2) AS total_lancado_afre_milhares,\\r\\n    ROUND(ma.infracoes_por_mes, 2) AS produtividade_infracoes_mes,\\r\\n    ROUND(ma.nfs_por_mes, 2) AS produtividade_nfs_mes,\\r\\n    ROUND(ma.taxa_conversao_infracao_nf, 2) AS taxa_conversao_afre_pct\\r\\n    \\r\\nFROM teste.fisca_afres_por_documento apd\\r\\nINNER JOIN teste.fisca_fiscalizacoes_consolidadas fc\\r\\n    ON apd.id_documento = fc.id_documento\\r\\nLEFT JOIN teste.fisca_metricas_por_afre ma\\r\\n    ON apd.matricula_afre = ma.matricula_afre\\r\\n    AND fc.ano_infracao = ma.ano\\r\\nWHERE fc.cnpj = 'CNPJ_AQUI'  -- << MODIFICAR CNPJ AQUI\\r\\nORDER BY apd.percentual_participacao DESC;\", \"\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- 5.3. HIST\\u00d3RICO COMPLETO DA EMPRESA\\r\\n-- Todas as fiscaliza\\u00e7\\u00f5es da empresa\\r\\nSELECT\\r\\n    '5.3. HIST\\u00d3RICO DE FISCALIZA\\u00c7\\u00d5ES DA EMPRESA' AS consulta,\\r\\n    \\r\\n    fc.data_infracao,\\r\\n    fc.numero_infracao,\\r\\n    fc.ano_infracao,\\r\\n    fc.tipo_infracao,\\r\\n    \\r\\n    -- Valores\\r\\n    ROUND(fc.valor_total_infracao / 1000, 2) AS valor_infracao_milhares,\\r\\n    ROUND(fc.valor_total_nf / 1000, 2) AS valor_nf_milhares,\\r\\n    \\r\\n    -- Situa\\u00e7\\u00e3o\\r\\n    fc.situacao_final,\\r\\n    fc.gerou_notificacao,\\r\\n    fc.ciclo_completo,\\r\\n    fc.dias_infracao_ate_nf,\\r\\n    \\r\\n    -- Notifica\\u00e7\\u00e3o\\r\\n    fc.numero_nf,\\r\\n    fc.data_nf,\\r\\n    \\r\\n    -- Score\\r\\n    ROUND(se.score_efetividade_final, 1) AS score_efetividade,\\r\\n    se.classificacao_efetividade\\r\\n    \\r\\nFROM teste.fisca_fiscalizacoes_consolidadas fc\\r\\nLEFT JOIN teste.fisca_scores_efetividade se\\r\\n    ON fc.id_documento = se.id_documento\\r\\nWHERE fc.cnpj = 'CNPJ_AQUI'  -- << MODIFICAR CNPJ AQUI\\r\\nORDER BY fc.data_infracao DESC;\", \"\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- 5.4. EMPRESAS SIMILARES (MESMO CNAE E MUNIC\\u00cdPIO)\\r\\n-- Compara\\u00e7\\u00e3o com empresas do mesmo perfil\\r\\nSELECT\\r\\n    '5.4. EMPRESAS SIMILARES NO MESMO SETOR/REGI\\u00c3O' AS consulta,\\r\\n    \\r\\n    fc2.cnpj,\\r\\n    fc2.nm_razao_social,\\r\\n    fc2.municipio,\\r\\n    fc2.regime_tributario,\\r\\n    \\r\\n    COUNT(DISTINCT fc2.id_documento) AS qtd_fiscalizacoes,\\r\\n    SUM(fc2.gerou_notificacao) AS qtd_nfs,\\r\\n    \\r\\n    -- Valores Totais\\r\\n    ROUND(SUM(fc2.valor_total_infracao) / 1000, 2) AS total_infracoes_milhares,\\r\\n    ROUND(SUM(fc2.valor_total_nf) / 1000, 2) AS total_nfs_milhares,\\r\\n    \\r\\n    -- M\\u00e9dias\\r\\n    ROUND(AVG(fc2.valor_total_infracao), 2) AS media_infracao,\\r\\n    ROUND(AVG(fc2.dias_infracao_ate_nf), 0) AS media_dias_ate_nf,\\r\\n    \\r\\n    -- Taxa de Convers\\u00e3o\\r\\n    ROUND(SUM(fc2.gerou_notificacao) * 100.0 / COUNT(DISTINCT fc2.id_documento), 2) AS taxa_conversao_pct,\\r\\n    \\r\\n    -- Score M\\u00e9dio\\r\\n    ROUND(AVG(se2.score_efetividade_final), 1) AS score_medio_efetividade\\r\\n    \\r\\nFROM teste.fisca_fiscalizacoes_consolidadas fc1\\r\\nINNER JOIN teste.fisca_fiscalizacoes_consolidadas fc2\\r\\n    ON fc1.cnae_divisao = fc2.cnae_divisao\\r\\n    AND fc1.municipio = fc2.municipio\\r\\n    AND fc1.cnpj != fc2.cnpj\\r\\nLEFT JOIN teste.fisca_scores_efetividade se2\\r\\n    ON fc2.id_documento = se2.id_documento\\r\\nWHERE fc1.cnpj = 'CNPJ_AQUI'  -- << MODIFICAR CNPJ AQUI\\r\\nGROUP BY fc2.cnpj, fc2.nm_razao_social, fc2.municipio, fc2.regime_tributario\\r\\nORDER BY SUM(fc2.valor_total_nf) DESC\\r\\nLIMIT 20;\", \"\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- ============================================================================\\r\\n-- SE\\u00c7\\u00c3O 6: AN\\u00c1LISES AVAN\\u00c7ADAS - PADR\\u00d5ES E TEND\\u00caNCIAS\\r\\n-- ============================================================================\\r\\n\\r\\n-- 6.1. EMPRESAS COM M\\u00daLTIPLAS FISCALIZA\\u00c7\\u00d5ES\\r\\n-- Objetivo: Identificar reincid\\u00eancias\\r\\nSELECT\\r\\n    '6.1. EMPRESAS COM M\\u00daLTIPLAS FISCALIZA\\u00c7\\u00d5ES' AS consulta,\\r\\n    \\r\\n    fc.cnpj,\\r\\n    fc.nm_razao_social,\\r\\n    fc.municipio,\\r\\n    fc.regime_tributario,\\r\\n    fc.cnae_secao_descricao,\\r\\n    \\r\\n    COUNT(DISTINCT fc.id_documento) AS qtd_fiscalizacoes,\\r\\n    COUNT(DISTINCT fc.ano_infracao) AS qtd_anos_fiscalizados,\\r\\n    \\r\\n    -- Primeira e \\u00faltima fiscaliza\\u00e7\\u00e3o\\r\\n    MIN(fc.data_infracao) AS primeira_fiscalizacao,\\r\\n    MAX(fc.data_infracao) AS ultima_fiscalizacao,\\r\\n    \\r\\n    -- Valores Totais\\r\\n    ROUND(SUM(fc.valor_total_infracao) / 1000, 2) AS total_infracoes_milhares,\\r\\n    ROUND(SUM(fc.valor_total_nf) / 1000, 2) AS total_nfs_milhares,\\r\\n    \\r\\n    -- Performance\\r\\n    SUM(fc.gerou_notificacao) AS qtd_nfs,\\r\\n    ROUND(SUM(fc.gerou_notificacao) * 100.0 / COUNT(DISTINCT fc.id_documento), 2) AS taxa_conversao_pct,\\r\\n    \\r\\n    -- Tipos de infra\\u00e7\\u00f5es distintas\\r\\n    COUNT(DISTINCT fc.tipo_infracao) AS tipos_infracoes_distintas,\\r\\n    \\r\\n    -- Score m\\u00e9dio\\r\\n    ROUND(AVG(se.score_efetividade_final), 1) AS score_medio_efetividade\\r\\n    \\r\\nFROM teste.fisca_fiscalizacoes_consolidadas fc\\r\\nLEFT JOIN teste.fisca_scores_efetividade se\\r\\n    ON fc.id_documento = se.id_documento\\r\\nGROUP BY fc.cnpj, fc.nm_razao_social, fc.municipio, fc.regime_tributario, fc.cnae_secao_descricao\\r\\nHAVING COUNT(DISTINCT fc.id_documento) >= 3  -- Pelo menos 3 fiscaliza\\u00e7\\u00f5es\\r\\nORDER BY COUNT(DISTINCT fc.id_documento) DESC, SUM(fc.valor_total_nf) DESC\\r\\nLIMIT 50;\", \"\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- 6.2. AN\\u00c1LISE DE SAZONALIDADE\\r\\n-- Objetivo: Identificar padr\\u00f5es mensais de fiscaliza\\u00e7\\u00e3o\\r\\nSELECT\\r\\n    '6.2. AN\\u00c1LISE DE SAZONALIDADE' AS consulta,\\r\\n    \\r\\n    MONTH(data_infracao) AS mes,\\r\\n    CASE MONTH(data_infracao)\\r\\n        WHEN 1 THEN 'Janeiro'\\r\\n        WHEN 2 THEN 'Fevereiro'\\r\\n        WHEN 3 THEN 'Mar\\u00e7o'\\r\\n        WHEN 4 THEN 'Abril'\\r\\n        WHEN 5 THEN 'Maio'\\r\\n        WHEN 6 THEN 'Junho'\\r\\n        WHEN 7 THEN 'Julho'\\r\\n        WHEN 8 THEN 'Agosto'\\r\\n        WHEN 9 THEN 'Setembro'\\r\\n        WHEN 10 THEN 'Outubro'\\r\\n        WHEN 11 THEN 'Novembro'\\r\\n        WHEN 12 THEN 'Dezembro'\\r\\n    END AS nome_mes,\\r\\n    \\r\\n    COUNT(DISTINCT id_documento) AS qtd_fiscalizacoes,\\r\\n    COUNT(DISTINCT cnpj) AS qtd_empresas,\\r\\n    \\r\\n    -- Valores\\r\\n    ROUND(SUM(valor_total_infracao) / 1000000, 2) AS total_infracoes_milhoes,\\r\\n    ROUND(AVG(valor_total_infracao), 2) AS media_valor_infracao,\\r\\n    \\r\\n    -- Notifica\\u00e7\\u00f5es\\r\\n    SUM(gerou_notificacao) AS qtd_nfs,\\r\\n    ROUND(SUM(gerou_notificacao) * 100.0 / COUNT(DISTINCT id_documento), 2) AS taxa_conversao_pct,\\r\\n    \\r\\n    -- Tempo m\\u00e9dio\\r\\n    ROUND(AVG(dias_infracao_ate_nf), 0) AS media_dias_ate_nf\\r\\n    \\r\\nFROM teste.fisca_fiscalizacoes_consolidadas\\r\\nWHERE ano_infracao >= YEAR(CURRENT_DATE()) - 3\\r\\nGROUP BY MONTH(data_infracao)\\r\\nORDER BY mes;\", \"\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- 6.3. EVOLU\\u00c7\\u00c3O MENSAL DOS \\u00daLTIMOS 24 MESES\\r\\n-- Objetivo: Tend\\u00eancia recente detalhada\\r\\nSELECT\\r\\n    '6.3. EVOLU\\u00c7\\u00c3O MENSAL \\u00daLTIMOS 24 MESES' AS consulta,\\r\\n    \\r\\n    YEAR(data_infracao) AS ano,\\r\\n    MONTH(data_infracao) AS mes,\\r\\n    CONCAT(CAST(YEAR(data_infracao) AS STRING), '-', \\r\\n           LPAD(CAST(MONTH(data_infracao) AS STRING), 2, '0')) AS ano_mes,\\r\\n    \\r\\n    COUNT(DISTINCT id_documento) AS qtd_fiscalizacoes,\\r\\n    COUNT(DISTINCT cnpj) AS qtd_empresas,\\r\\n    SUM(gerou_notificacao) AS qtd_nfs,\\r\\n    \\r\\n    -- Valores\\r\\n    ROUND(SUM(valor_total_infracao) / 1000000, 2) AS total_infracoes_milhoes,\\r\\n    ROUND(SUM(valor_total_nf) / 1000000, 2) AS total_nfs_milhoes,\\r\\n    \\r\\n    -- Taxas\\r\\n    ROUND(SUM(gerou_notificacao) * 100.0 / COUNT(DISTINCT id_documento), 2) AS taxa_conversao_pct,\\r\\n    \\r\\n    -- Tempos\\r\\n    ROUND(AVG(dias_infracao_ate_nf), 0) AS media_dias_ate_nf,\\r\\n    \\r\\n    -- Acumulado do ano\\r\\n    ROUND(SUM(SUM(valor_total_nf)) OVER (\\r\\n        PARTITION BY YEAR(data_infracao) \\r\\n        ORDER BY MONTH(data_infracao)\\r\\n        ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW\\r\\n    ) / 1000000, 2) AS acumulado_ano_milhoes\\r\\n    \\r\\nFROM teste.fisca_fiscalizacoes_consolidadas\\r\\nWHERE data_infracao >= ADD_MONTHS(CURRENT_DATE(), -24)\\r\\nGROUP BY YEAR(data_infracao), MONTH(data_infracao)\\r\\nORDER BY ano DESC, mes DESC;\", \"\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- 6.4. AN\\u00c1LISE DE CORRELA\\u00c7\\u00c3O: SETOR vs EFETIVIDADE\\r\\n-- Objetivo: Identificar setores com melhor/pior efetividade\\r\\nSELECT\\r\\n    '6.4. EFETIVIDADE POR SETOR' AS consulta,\\r\\n    \\r\\n    fc.cnae_secao,\\r\\n    fc.cnae_secao_descricao,\\r\\n    \\r\\n    COUNT(DISTINCT fc.id_documento) AS qtd_fiscalizacoes,\\r\\n    COUNT(DISTINCT fc.cnpj) AS qtd_empresas,\\r\\n    \\r\\n    -- Valores\\r\\n    ROUND(SUM(fc.valor_total_infracao) / 1000000, 2) AS total_infracoes_milhoes,\\r\\n    ROUND(SUM(fc.valor_total_nf) / 1000000, 2) AS total_nfs_milhoes,\\r\\n    \\r\\n    -- Performance\\r\\n    ROUND(SUM(fc.gerou_notificacao) * 100.0 / COUNT(DISTINCT fc.id_documento), 2) AS taxa_conversao_pct,\\r\\n    ROUND(SUM(fc.ciclo_completo) * 100.0 / COUNT(DISTINCT fc.id_documento), 2) AS taxa_ciclo_completo_pct,\\r\\n    \\r\\n    -- Tempos\\r\\n    ROUND(AVG(fc.dias_infracao_ate_nf), 0) AS media_dias_ate_nf,\\r\\n    \\r\\n    -- Scores de Efetividade\\r\\n    ROUND(AVG(se.score_efetividade_final), 1) AS score_medio_efetividade,\\r\\n    ROUND(AVG(se.score_tempestividade), 1) AS score_medio_tempestividade,\\r\\n    ROUND(AVG(se.score_valor_notificado), 1) AS score_medio_valor,\\r\\n    \\r\\n    -- Distribui\\u00e7\\u00e3o de classifica\\u00e7\\u00e3o\\r\\n    COUNT(CASE WHEN se.classificacao_efetividade = 'MUITO EFETIVA' THEN 1 END) AS qtd_muito_efetiva,\\r\\n    COUNT(CASE WHEN se.classificacao_efetividade = 'EFETIVA' THEN 1 END) AS qtd_efetiva,\\r\\n    COUNT(CASE WHEN se.classificacao_efetividade = 'MODERADAMENTE EFETIVA' THEN 1 END) AS qtd_moderada,\\r\\n    COUNT(CASE WHEN se.classificacao_efetividade = 'POUCO EFETIVA' THEN 1 END) AS qtd_pouco_efetiva\\r\\n    \\r\\nFROM teste.fisca_fiscalizacoes_consolidadas fc\\r\\nLEFT JOIN teste.fisca_scores_efetividade se\\r\\n    ON fc.id_documento = se.id_documento\\r\\nWHERE fc.cnae_secao IS NOT NULL\\r\\n    AND fc.ano_infracao >= YEAR(CURRENT_DATE()) - 3\\r\\nGROUP BY fc.cnae_secao, fc.cnae_secao_descricao\\r\\nHAVING COUNT(DISTINCT fc.id_documento) >= 20  -- M\\u00ednimo 20 fiscaliza\\u00e7\\u00f5es\\r\\nORDER BY AVG(se.score_efetividade_final) DESC;\", \"\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- ============================================================================\\r\\n-- SE\\u00c7\\u00c3O 7: ALERTAS E PRIORIDADES\\r\\n-- ============================================================================\\r\\n\\r\\n-- 7.1. FISCALIZA\\u00c7\\u00d5ES EM ANDAMENTO - SITUA\\u00c7\\u00c3O CR\\u00cdTICA\\r\\n-- Objetivo: Identificar casos que precisam de aten\\u00e7\\u00e3o\\r\\nSELECT\\r\\n    '7.1. FISCALIZA\\u00c7\\u00d5ES CR\\u00cdTICAS EM ANDAMENTO' AS consulta,\\r\\n    \\r\\n    ROW_NUMBER() OVER (ORDER BY \\r\\n        CASE \\r\\n            WHEN fc.data_infracao < ADD_MONTHS(CURRENT_DATE(), -12) THEN 1\\r\\n            WHEN fc.valor_total_infracao >= 500000 AND fc.gerou_notificacao = 0 THEN 2\\r\\n            WHEN fc.data_infracao < ADD_MONTHS(CURRENT_DATE(), -6) THEN 3\\r\\n            ELSE 4\\r\\n        END,\\r\\n        fc.valor_total_infracao DESC\\r\\n    ) AS prioridade,\\r\\n    \\r\\n    fc.cnpj,\\r\\n    fc.nm_razao_social,\\r\\n    fc.municipio,\\r\\n    fc.gerfe,\\r\\n    \\r\\n    -- Fiscaliza\\u00e7\\u00e3o\\r\\n    fc.numero_infracao,\\r\\n    fc.data_infracao,\\r\\n    DATEDIFF(CURRENT_DATE(), fc.data_infracao) AS dias_desde_infracao,\\r\\n    \\r\\n    -- Valores\\r\\n    ROUND(fc.valor_total_infracao / 1000, 2) AS valor_infracao_milhares,\\r\\n    \\r\\n    -- Situa\\u00e7\\u00e3o\\r\\n    fc.situacao_final,\\r\\n    fc.gerou_notificacao,\\r\\n    \\r\\n    -- Alerta\\r\\n    CASE \\r\\n        WHEN fc.data_infracao < ADD_MONTHS(CURRENT_DATE(), -12) \\r\\n        THEN 'CR\\u00cdTICO: > 12 MESES SEM NOTIFICA\\u00c7\\u00c3O'\\r\\n        \\r\\n        WHEN fc.valor_total_infracao >= 500000 AND fc.gerou_notificacao = 0 \\r\\n        THEN 'CR\\u00cdTICO: ALTO VALOR SEM NOTIFICA\\u00c7\\u00c3O'\\r\\n        \\r\\n        WHEN fc.data_infracao < ADD_MONTHS(CURRENT_DATE(), -6) \\r\\n        THEN 'ALTO: > 6 MESES SEM NOTIFICA\\u00c7\\u00c3O'\\r\\n        \\r\\n        WHEN fc.data_infracao < ADD_MONTHS(CURRENT_DATE(), -3) \\r\\n        THEN 'M\\u00c9DIO: > 3 MESES SEM NOTIFICA\\u00c7\\u00c3O'\\r\\n        \\r\\n        ELSE 'MONITORAMENTO: < 3 MESES'\\r\\n    END AS tipo_alerta,\\r\\n    \\r\\n    -- A\\u00e7\\u00e3o Sugerida\\r\\n    CASE \\r\\n        WHEN fc.data_infracao < ADD_MONTHS(CURRENT_DATE(), -12) \\r\\n        THEN 'URGENTE: Verificar motivo da demora e priorizar emiss\\u00e3o'\\r\\n        \\r\\n        WHEN fc.valor_total_infracao >= 500000 AND fc.gerou_notificacao = 0 \\r\\n        THEN 'URGENTE: Priorizar por alto impacto financeiro'\\r\\n        \\r\\n        WHEN fc.data_infracao < ADD_MONTHS(CURRENT_DATE(), -6) \\r\\n        THEN 'Acelerar processo de notifica\\u00e7\\u00e3o'\\r\\n        \\r\\n        ELSE 'Acompanhar evolu\\u00e7\\u00e3o normal'\\r\\n    END AS acao_sugerida\\r\\n    \\r\\nFROM teste.fisca_fiscalizacoes_consolidadas fc\\r\\nWHERE fc.gerou_notificacao = 0\\r\\n    AND fc.data_infracao >= ADD_MONTHS(CURRENT_DATE(), -24)\\r\\nORDER BY prioridade, fc.valor_total_infracao DESC\\r\\nLIMIT 100;\", \"\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- 7.2. EMPRESAS COM PADR\\u00c3O DE ALTO RISCO\\r\\n-- Objetivo: Identificar contribuintes problem\\u00e1ticos\\r\\nSELECT\\r\\n    '7.2. EMPRESAS COM PADR\\u00c3O DE ALTO RISCO' AS consulta,\\r\\n    \\r\\n    fc.cnpj,\\r\\n    fc.nm_razao_social,\\r\\n    fc.municipio,\\r\\n    fc.regime_tributario,\\r\\n    fc.cnae_secao_descricao,\\r\\n    \\r\\n    COUNT(DISTINCT fc.id_documento) AS qtd_fiscalizacoes,\\r\\n    COUNT(DISTINCT fc.ano_infracao) AS qtd_anos_distintos,\\r\\n    \\r\\n    -- Valores\\r\\n    ROUND(SUM(fc.valor_total_infracao) / 1000, 2) AS total_infracoes_milhares,\\r\\n    ROUND(AVG(fc.valor_total_infracao), 2) AS media_por_fiscalizacao,\\r\\n    \\r\\n    -- Performance\\r\\n    ROUND(SUM(fc.gerou_notificacao) * 100.0 / COUNT(DISTINCT fc.id_documento), 2) AS taxa_conversao_pct,\\r\\n    \\r\\n    -- Tipos de infra\\u00e7\\u00f5es\\r\\n    COUNT(DISTINCT fc.tipo_infracao) AS tipos_infracoes_distintas,\\r\\n    \\r\\n    -- Temporalidade\\r\\n    MIN(fc.data_infracao) AS primeira_fiscalizacao,\\r\\n    MAX(fc.data_infracao) AS ultima_fiscalizacao,\\r\\n    DATEDIFF(MAX(fc.data_infracao), MIN(fc.data_infracao)) AS dias_entre_primeira_ultima,\\r\\n    \\r\\n    -- Score de Risco\\r\\n    CASE \\r\\n        WHEN COUNT(DISTINCT fc.id_documento) >= 5 AND \\r\\n             SUM(fc.valor_total_infracao) >= 1000000 AND\\r\\n             COUNT(DISTINCT fc.ano_infracao) >= 3 \\r\\n        THEN 'RISCO CR\\u00cdTICO'\\r\\n        \\r\\n        WHEN COUNT(DISTINCT fc.id_documento) >= 3 AND \\r\\n             SUM(fc.valor_total_infracao) >= 500000 \\r\\n        THEN 'RISCO ALTO'\\r\\n        \\r\\n        WHEN COUNT(DISTINCT fc.id_documento) >= 3 OR \\r\\n             SUM(fc.valor_total_infracao) >= 300000 \\r\\n        THEN 'RISCO MODERADO'\\r\\n        \\r\\n        ELSE 'RISCO BAIXO'\\r\\n    END AS classificacao_risco,\\r\\n    \\r\\n    -- Recomenda\\u00e7\\u00e3o\\r\\n    CASE \\r\\n        WHEN COUNT(DISTINCT fc.id_documento) >= 5 \\r\\n        THEN 'Indicar para Grupo Especial de Fiscaliza\\u00e7\\u00e3o'\\r\\n        \\r\\n        WHEN COUNT(DISTINCT fc.ano_infracao) >= 3 \\r\\n        THEN 'Acompanhamento Cont\\u00ednuo Obrigat\\u00f3rio'\\r\\n        \\r\\n        WHEN SUM(fc.valor_total_infracao) >= 1000000 \\r\\n        THEN 'Priorizar Fechamento dos Casos Pendentes'\\r\\n        \\r\\n        ELSE 'Monitoramento Regular'\\r\\n    END AS recomendacao\\r\\n    \\r\\nFROM teste.fisca_fiscalizacoes_consolidadas fc\\r\\nWHERE fc.ano_infracao >= YEAR(CURRENT_DATE()) - 5\\r\\nGROUP BY fc.cnpj, fc.nm_razao_social, fc.municipio, fc.regime_tributario, fc.cnae_secao_descricao\\r\\nHAVING COUNT(DISTINCT fc.id_documento) >= 3\\r\\n    OR SUM(fc.valor_total_infracao) >= 300000\\r\\nORDER BY \\r\\n    CASE \\r\\n        WHEN COUNT(DISTINCT fc.id_documento) >= 5 AND SUM(fc.valor_total_infracao) >= 1000000 THEN 1\\r\\n        WHEN COUNT(DISTINCT fc.id_documento) >= 3 AND SUM(fc.valor_total_infracao) >= 500000 THEN 2\\r\\n        ELSE 3\\r\\n    END,\\r\\n    SUM(fc.valor_total_infracao) DESC\\r\\nLIMIT 50;\", \"\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- ============================================================================\\r\\n-- SE\\u00c7\\u00c3O 8: DASHBOARD COMPARATIVO - BENCHMARKS\\r\\n-- ============================================================================\\r\\n\\r\\n-- 8.1. COMPARATIVO DE GER\\u00caNCIAS (RANKING)\\r\\n-- Objetivo: Benchmark entre ger\\u00eancias regionais\\r\\nWITH ranking_gerencias AS (\\r\\n    SELECT\\r\\n        gerfe,\\r\\n        ano_infracao,\\r\\n        COUNT(DISTINCT id_documento) AS qtd_fiscalizacoes,\\r\\n        SUM(gerou_notificacao) AS qtd_nfs,\\r\\n        ROUND(SUM(valor_total_nf) / 1000000, 2) AS total_lancado_milhoes,\\r\\n        ROUND(SUM(gerou_notificacao) * 100.0 / COUNT(DISTINCT id_documento), 2) AS taxa_conversao,\\r\\n        ROUND(AVG(dias_infracao_ate_nf), 0) AS media_dias\\r\\n    FROM teste.fisca_fiscalizacoes_consolidadas\\r\\n    WHERE gerfe IS NOT NULL\\r\\n        AND ano_infracao >= YEAR(CURRENT_DATE()) - 2\\r\\n    GROUP BY gerfe, ano_infracao\\r\\n),\\r\\nstats_gerais AS (\\r\\n    SELECT\\r\\n        ano_infracao,\\r\\n        AVG(taxa_conversao) AS media_geral_taxa,\\r\\n        AVG(media_dias) AS media_geral_dias,\\r\\n        AVG(total_lancado_milhoes) AS media_geral_valor\\r\\n    FROM ranking_gerencias\\r\\n    GROUP BY ano_infracao\\r\\n)\\r\\nSELECT\\r\\n    '8.1. RANKING E BENCHMARK DE GER\\u00caNCIAS' AS consulta,\\r\\n    \\r\\n    rg.gerfe,\\r\\n    rg.ano_infracao,\\r\\n    \\r\\n    -- Volumes\\r\\n    rg.qtd_fiscalizacoes,\\r\\n    rg.qtd_nfs,\\r\\n    rg.total_lancado_milhoes,\\r\\n    \\r\\n    -- Performance\\r\\n    rg.taxa_conversao AS taxa_conversao_pct,\\r\\n    ROUND(rg.taxa_conversao - sg.media_geral_taxa, 2) AS diferenca_vs_media_taxa,\\r\\n    \\r\\n    rg.media_dias,\\r\\n    ROUND(rg.media_dias - sg.media_geral_dias, 0) AS diferenca_vs_media_dias,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o\\r\\n    ROW_NUMBER() OVER (PARTITION BY rg.ano_infracao ORDER BY rg.total_lancado_milhoes DESC) AS ranking_valor,\\r\\n    ROW_NUMBER() OVER (PARTITION BY rg.ano_infracao ORDER BY rg.taxa_conversao DESC) AS ranking_conversao,\\r\\n    ROW_NUMBER() OVER (PARTITION BY rg.ano_infracao ORDER BY rg.media_dias ASC) AS ranking_tempestividade,\\r\\n    \\r\\n    -- M\\u00e9dias Gerais (para compara\\u00e7\\u00e3o)\\r\\n    sg.media_geral_taxa AS media_taxa_todas_gerencias,\\r\\n    sg.media_geral_dias AS media_dias_todas_gerencias,\\r\\n    sg.media_geral_valor AS media_valor_todas_gerencias\\r\\n    \\r\\nFROM ranking_gerencias rg\\r\\nINNER JOIN stats_gerais sg ON rg.ano_infracao = sg.ano_infracao\\r\\nORDER BY rg.ano_infracao DESC, rg.total_lancado_milhoes DESC;\"], \"aceSize\": 100, \"status\": \"failed\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Exemplo: SELECT * FROM tablename ou pressione CTRL + espa\\u00e7o\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- ============================================================================\\r\\n-- SE\\u00c7\\u00c3O 7: ALERTAS E PRIORIDADES\\r\\n-- ============================================================================\\r\\n\\r\\n-- 7.1. FISCALIZA\\u00c7\\u00d5ES EM ANDAMENTO - SITUA\\u00c7\\u00c3O CR\\u00cdTICA\\r\\n-- Objetivo: Identificar casos que precisam de aten\\u00e7\\u00e3o\\r\\nSELECT\\r\\n    '7.1. FISCALIZA\\u00c7\\u00d5ES CR\\u00cdTICAS EM ANDAMENTO' AS consulta,\\r\\n    \\r\\n    ROW_NUMBER() OVER (ORDER BY \\r\\n        CASE \\r\\n            WHEN fc.data_infracao < ADD_MONTHS(CURRENT_DATE(), -12) THEN 1\\r\\n            WHEN fc.valor_total_infracao >= 500000 AND fc.gerou_notificacao = 0 THEN 2\\r\\n            WHEN fc.data_infracao < ADD_MONTHS(CURRENT_DATE(), -6) THEN 3\\r\\n            ELSE 4\\r\\n        END,\\r\\n        fc.valor_total_infracao DESC\\r\\n    ) AS prioridade,\\r\\n    \\r\\n    fc.cnpj,\\r\\n    fc.nm_razao_social,\\r\\n    fc.municipio,\\r\\n    fc.gerfe,\\r\\n    \\r\\n    -- Fiscaliza\\u00e7\\u00e3o\\r\\n    fc.numero_infracao,\\r\\n    fc.data_infracao,\\r\\n    DATEDIFF(CURRENT_DATE(), fc.data_infracao) AS dias_desde_infracao,\\r\\n    \\r\\n    -- Valores\\r\\n    ROUND(fc.valor_total_infracao / 1000, 2) AS valor_infracao_milhares,\\r\\n    \\r\\n    -- Situa\\u00e7\\u00e3o\\r\\n    fc.situacao_final,\\r\\n    fc.gerou_notificacao,\\r\\n    \\r\\n    -- Alerta\\r\\n    CASE \\r\\n        WHEN fc.data_infracao < ADD_MONTHS(CURRENT_DATE(), -12) \\r\\n        THEN 'CR\\u00cdTICO: > 12 MESES SEM NOTIFICA\\u00c7\\u00c3O'\\r\\n        \\r\\n        WHEN fc.valor_total_infracao >= 500000 AND fc.gerou_notificacao = 0 \\r\\n        THEN 'CR\\u00cdTICO: ALTO VALOR SEM NOTIFICA\\u00c7\\u00c3O'\\r\\n        \\r\\n        WHEN fc.data_infracao < ADD_MONTHS(CURRENT_DATE(), -6) \\r\\n        THEN 'ALTO: > 6 MESES SEM NOTIFICA\\u00c7\\u00c3O'\\r\\n        \\r\\n        WHEN fc.data_infracao < ADD_MONTHS(CURRENT_DATE(), -3) \\r\\n        THEN 'M\\u00c9DIO: > 3 MESES SEM NOTIFICA\\u00c7\\u00c3O'\\r\\n        \\r\\n        ELSE 'MONITORAMENTO: < 3 MESES'\\r\\n    END AS tipo_alerta,\\r\\n    \\r\\n    -- A\\u00e7\\u00e3o Sugerida\\r\\n    CASE \\r\\n        WHEN fc.data_infracao < ADD_MONTHS(CURRENT_DATE(), -12) \\r\\n        THEN 'URGENTE: Verificar motivo da demora e priorizar emiss\\u00e3o'\\r\\n        \\r\\n        WHEN fc.valor_total_infracao >= 500000 AND fc.gerou_notificacao = 0 \\r\\n        THEN 'URGENTE: Priorizar por alto impacto financeiro'\\r\\n        \\r\\n        WHEN fc.data_infracao < ADD_MONTHS(CURRENT_DATE(), -6) \\r\\n        THEN 'Acelerar processo de notifica\\u00e7\\u00e3o'\\r\\n        \\r\\n        ELSE 'Acompanhar evolu\\u00e7\\u00e3o normal'\\r\\n    END AS acao_sugerida\\r\\n    \\r\\nFROM teste.fisca_fiscalizacoes_consolidadas fc\\r\\nWHERE fc.gerou_notificacao = 0\\r\\n    AND fc.data_infracao >= ADD_MONTHS(CURRENT_DATE(), -24)\\r\\nORDER BY prioridade, fc.valor_total_infracao DESC\\r\\nLIMIT 100;\", \"result\": {\"id\": \"908e3d90-faa8-09aa-24ca-1c9e7964f0fc\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"has_more_statements\": true, \"statement_id\": 10, \"statements_count\": 12, \"previous_statement_hash\": \"627d6f20f2cdbc601903e6864cbadd098b9cf5ec5b1faef6ad5c0c5e\"}, \"meta\": [], \"rows\": 48, \"hasMore\": false, \"statement_id\": 10, \"statement_range\": {\"start\": {\"row\": 0, \"column\": 0}, \"end\": {\"row\": 0, \"column\": 0}}, \"statements_count\": 12, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": -1, \"filteredMeta\": [], \"fetchedOnce\": false, \"startTime\": \"2025-10-30T17:07:13.928Z\", \"endTime\": \"2025-10-30T17:07:13.928Z\", \"executionTime\": 0, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 0, \"hasSomeResults\": false}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": 71143, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": null, \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": false, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": \"consulta\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [\"qtd_fiscalizacoes\"], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": null, \"getLogsTimeout\": null, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1761844033912, \"lastAceSelectionRowOffset\": 598, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"lastExecutedStatements\": \"-- 5.1. DOSSI\\u00ca COMPLETO DE EMPRESA\\r\\n-- Substitua 'CNPJ_AQUI' pelo CNPJ desejado\\r\\nSELECT\\r\\n    '5.1. DOSSI\\u00ca COMPLETO EMPRESA' AS consulta,\\r\\n    \\r\\n    -- Identifica\\u00e7\\u00e3o\\r\\n    fc.cnpj,\\r\\n    fc.nm_razao_social,\\r\\n    fc.nm_fantasia,\\r\\n    fc.municipio,\\r\\n    fc.uf,\\r\\n    fc.regime_tributario,\\r\\n    fc.nm_tipo_contribuinte,\\r\\n    fc.cnae_secao_descricao,\\r\\n    fc.cnae_divisao_descricao,\\r\\n    fc.cnae_descricao,\\r\\n    fc.gerfe,\\r\\n    fc.usefi,\\r\\n    \\r\\n    -- Fiscaliza\\u00e7\\u00e3o\\r\\n    fc.numero_infracao,\\r\\n    fc.data_infracao,\\r\\n    fc.tipo_infracao,\\r\\n    fc.ano_infracao,\\r\\n    \\r\\n    -- Valores Infra\\u00e7\\u00e3o\\r\\n    ROUND(fc.valor_total_infracao / 1000, 2) AS valor_infracao_milhares,\\r\\n    ROUND(fc.valor_imposto_infracao / 1000, 2) AS imposto_milhares,\\r\\n    ROUND(fc.valor_multa_infracao / 1000, 2) AS multa_milhares,\\r\\n    ROUND(fc.valor_juros_infracao / 1000, 2) AS juros_milhares,\\r\\n    \\r\\n    -- Notifica\\u00e7\\u00e3o\\r\\n    fc.numero_nf,\\r\\n    fc.data_nf,\\r\\n    fc.tipo_notificacao,\\r\\n    ROUND(fc.valor_total_nf / 1000, 2) AS valor_nf_milhares,\\r\\n    \\r\\n    -- Ci\\u00eancia\\r\\n    fc.data_ciencia_infracao,\\r\\n    fc.modo_ciencia_infracao,\\r\\n    fc.data_ciencia_nf,\\r\\n    \\r\\n    -- Defesa Pr\\u00e9via\\r\\n    fc.apresentou_dp_infracao,\\r\\n    fc.data_dp_infracao,\\r\\n    fc.pagou_dp_infracao,\\r\\n    \\r\\n    -- Encerramento\\r\\n    fc.numero_termo_encerramento,\\r\\n    fc.data_encerramento,\\r\\n    fc.teve_resultados,\\r\\n    fc.verificacoes_realizadas,\\r\\n    \\r\\n    -- Situa\\u00e7\\u00e3o\\r\\n    fc.situacao_final,\\r\\n    fc.gerou_notificacao,\\r\\n    fc.ciclo_completo,\\r\\n    \\r\\n    -- Tempos\\r\\n    fc.dias_infracao_ate_nf,\\r\\n    fc.dias_infracao_ate_encerramento,\\r\\n    \\r\\n    -- Score de Efetividade\\r\\n    se.score_efetividade_final,\\r\\n    se.classificacao_efetividade,\\r\\n    se.score_geracao_nf,\\r\\n    se.score_ciclo,\\r\\n    se.score_valor_notificado,\\r\\n    se.score_tempestividade\\r\\n    \\r\\nFROM teste.fisca_fiscalizacoes_consolidadas fc\\r\\nLEFT JOIN teste.fisca_scores_efetividade se\\r\\n    ON fc.id_documento = se.id_documento\\r\\nWHERE fc.cnpj = 'CNPJ_AQUI'  -- << MODIFICAR CNPJ AQUI\\r\\nORDER BY fc.data_infracao DESC;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- 5.2. AFREs QUE PARTICIPARAM DA FISCALIZA\\u00c7\\u00c3O\\r\\n-- Lista todos os auditores envolvidos\\r\\nSELECT\\r\\n    '5.2. AFREs DA FISCALIZA\\u00c7\\u00c3O' AS consulta,\\r\\n    \\r\\n    apd.matricula_afre,\\r\\n    apd.nome_afre,\\r\\n    apd.cargo,\\r\\n    apd.percentual_participacao,\\r\\n    apd.eh_coordenador,\\r\\n    \\r\\n    -- M\\u00e9tricas do AFRE (ano da fiscaliza\\u00e7\\u00e3o)\\r\\n    ma.qtd_infracoes AS total_infracoes_afre_ano,\\r\\n    ma.qtd_nfs AS total_nfs_afre_ano,\\r\\n    ROUND(ma.valor_total_lancado / 1000, 2) AS total_lancado_afre_milhares,\\r\\n    ROUND(ma.infracoes_por_mes, 2) AS produtividade_infracoes_mes,\\r\\n    ROUND(ma.nfs_por_mes, 2) AS produtividade_nfs_mes,\\r\\n    ROUND(ma.taxa_conversao_infracao_nf, 2) AS taxa_conversao_afre_pct\\r\\n    \\r\\nFROM teste.fisca_afres_por_documento apd\\r\\nINNER JOIN teste.fisca_fiscalizacoes_consolidadas fc\\r\\n    ON apd.id_documento = fc.id_documento\\r\\nLEFT JOIN teste.fisca_metricas_por_afre ma\\r\\n    ON apd.matricula_afre = ma.matricula_afre\\r\\n    AND fc.ano_infracao = ma.ano\\r\\nWHERE fc.cnpj = 'CNPJ_AQUI'  -- << MODIFICAR CNPJ AQUI\\r\\nORDER BY apd.percentual_participacao DESC;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- 5.3. HIST\\u00d3RICO COMPLETO DA EMPRESA\\r\\n-- Todas as fiscaliza\\u00e7\\u00f5es da empresa\\r\\nSELECT\\r\\n    '5.3. HIST\\u00d3RICO DE FISCALIZA\\u00c7\\u00d5ES DA EMPRESA' AS consulta,\\r\\n    \\r\\n    fc.data_infracao,\\r\\n    fc.numero_infracao,\\r\\n    fc.ano_infracao,\\r\\n    fc.tipo_infracao,\\r\\n    \\r\\n    -- Valores\\r\\n    ROUND(fc.valor_total_infracao / 1000, 2) AS valor_infracao_milhares,\\r\\n    ROUND(fc.valor_total_nf / 1000, 2) AS valor_nf_milhares,\\r\\n    \\r\\n    -- Situa\\u00e7\\u00e3o\\r\\n    fc.situacao_final,\\r\\n    fc.gerou_notificacao,\\r\\n    fc.ciclo_completo,\\r\\n    fc.dias_infracao_ate_nf,\\r\\n    \\r\\n    -- Notifica\\u00e7\\u00e3o\\r\\n    fc.numero_nf,\\r\\n    fc.data_nf,\\r\\n    \\r\\n    -- Score\\r\\n    ROUND(se.score_efetividade_final, 1) AS score_efetividade,\\r\\n    se.classificacao_efetividade\\r\\n    \\r\\nFROM teste.fisca_fiscalizacoes_consolidadas fc\\r\\nLEFT JOIN teste.fisca_scores_efetividade se\\r\\n    ON fc.id_documento = se.id_documento\\r\\nWHERE fc.cnpj = 'CNPJ_AQUI'  -- << MODIFICAR CNPJ AQUI\\r\\nORDER BY fc.data_infracao DESC;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- 5.4. EMPRESAS SIMILARES (MESMO CNAE E MUNIC\\u00cdPIO)\\r\\n-- Compara\\u00e7\\u00e3o com empresas do mesmo perfil\\r\\nSELECT\\r\\n    '5.4. EMPRESAS SIMILARES NO MESMO SETOR/REGI\\u00c3O' AS consulta,\\r\\n    \\r\\n    fc2.cnpj,\\r\\n    fc2.nm_razao_social,\\r\\n    fc2.municipio,\\r\\n    fc2.regime_tributario,\\r\\n    \\r\\n    COUNT(DISTINCT fc2.id_documento) AS qtd_fiscalizacoes,\\r\\n    SUM(fc2.gerou_notificacao) AS qtd_nfs,\\r\\n    \\r\\n    -- Valores Totais\\r\\n    ROUND(SUM(fc2.valor_total_infracao) / 1000, 2) AS total_infracoes_milhares,\\r\\n    ROUND(SUM(fc2.valor_total_nf) / 1000, 2) AS total_nfs_milhares,\\r\\n    \\r\\n    -- M\\u00e9dias\\r\\n    ROUND(AVG(fc2.valor_total_infracao), 2) AS media_infracao,\\r\\n    ROUND(AVG(fc2.dias_infracao_ate_nf), 0) AS media_dias_ate_nf,\\r\\n    \\r\\n    -- Taxa de Convers\\u00e3o\\r\\n    ROUND(SUM(fc2.gerou_notificacao) * 100.0 / COUNT(DISTINCT fc2.id_documento), 2) AS taxa_conversao_pct,\\r\\n    \\r\\n    -- Score M\\u00e9dio\\r\\n    ROUND(AVG(se2.score_efetividade_final), 1) AS score_medio_efetividade\\r\\n    \\r\\nFROM teste.fisca_fiscalizacoes_consolidadas fc1\\r\\nINNER JOIN teste.fisca_fiscalizacoes_consolidadas fc2\\r\\n    ON fc1.cnae_divisao = fc2.cnae_divisao\\r\\n    AND fc1.municipio = fc2.municipio\\r\\n    AND fc1.cnpj != fc2.cnpj\\r\\nLEFT JOIN teste.fisca_scores_efetividade se2\\r\\n    ON fc2.id_documento = se2.id_documento\\r\\nWHERE fc1.cnpj = 'CNPJ_AQUI'  -- << MODIFICAR CNPJ AQUI\\r\\nGROUP BY fc2.cnpj, fc2.nm_razao_social, fc2.municipio, fc2.regime_tributario\\r\\nORDER BY SUM(fc2.valor_total_nf) DESC\\r\\nLIMIT 20;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- ============================================================================\\r\\n-- SE\\u00c7\\u00c3O 6: AN\\u00c1LISES AVAN\\u00c7ADAS - PADR\\u00d5ES E TEND\\u00caNCIAS\\r\\n-- ============================================================================\\r\\n\\r\\n-- 6.1. EMPRESAS COM M\\u00daLTIPLAS FISCALIZA\\u00c7\\u00d5ES\\r\\n-- Objetivo: Identificar reincid\\u00eancias\\r\\nSELECT\\r\\n    '6.1. EMPRESAS COM M\\u00daLTIPLAS FISCALIZA\\u00c7\\u00d5ES' AS consulta,\\r\\n    \\r\\n    fc.cnpj,\\r\\n    fc.nm_razao_social,\\r\\n    fc.municipio,\\r\\n    fc.regime_tributario,\\r\\n    fc.cnae_secao_descricao,\\r\\n    \\r\\n    COUNT(DISTINCT fc.id_documento) AS qtd_fiscalizacoes,\\r\\n    COUNT(DISTINCT fc.ano_infracao) AS qtd_anos_fiscalizados,\\r\\n    \\r\\n    -- Primeira e \\u00faltima fiscaliza\\u00e7\\u00e3o\\r\\n    MIN(fc.data_infracao) AS primeira_fiscalizacao,\\r\\n    MAX(fc.data_infracao) AS ultima_fiscalizacao,\\r\\n    \\r\\n    -- Valores Totais\\r\\n    ROUND(SUM(fc.valor_total_infracao) / 1000, 2) AS total_infracoes_milhares,\\r\\n    ROUND(SUM(fc.valor_total_nf) / 1000, 2) AS total_nfs_milhares,\\r\\n    \\r\\n    -- Performance\\r\\n    SUM(fc.gerou_notificacao) AS qtd_nfs,\\r\\n    ROUND(SUM(fc.gerou_notificacao) * 100.0 / COUNT(DISTINCT fc.id_documento), 2) AS taxa_conversao_pct,\\r\\n    \\r\\n    -- Tipos de infra\\u00e7\\u00f5es distintas\\r\\n    COUNT(DISTINCT fc.tipo_infracao) AS tipos_infracoes_distintas,\\r\\n    \\r\\n    -- Score m\\u00e9dio\\r\\n    ROUND(AVG(se.score_efetividade_final), 1) AS score_medio_efetividade\\r\\n    \\r\\nFROM teste.fisca_fiscalizacoes_consolidadas fc\\r\\nLEFT JOIN teste.fisca_scores_efetividade se\\r\\n    ON fc.id_documento = se.id_documento\\r\\nGROUP BY fc.cnpj, fc.nm_razao_social, fc.municipio, fc.regime_tributario, fc.cnae_secao_descricao\\r\\nHAVING COUNT(DISTINCT fc.id_documento) >= 3  -- Pelo menos 3 fiscaliza\\u00e7\\u00f5es\\r\\nORDER BY COUNT(DISTINCT fc.id_documento) DESC, SUM(fc.valor_total_nf) DESC\\r\\nLIMIT 50;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- 6.2. AN\\u00c1LISE DE SAZONALIDADE\\r\\n-- Objetivo: Identificar padr\\u00f5es mensais de fiscaliza\\u00e7\\u00e3o\\r\\nSELECT\\r\\n    '6.2. AN\\u00c1LISE DE SAZONALIDADE' AS consulta,\\r\\n    \\r\\n    MONTH(data_infracao) AS mes,\\r\\n    CASE MONTH(data_infracao)\\r\\n        WHEN 1 THEN 'Janeiro'\\r\\n        WHEN 2 THEN 'Fevereiro'\\r\\n        WHEN 3 THEN 'Mar\\u00e7o'\\r\\n        WHEN 4 THEN 'Abril'\\r\\n        WHEN 5 THEN 'Maio'\\r\\n        WHEN 6 THEN 'Junho'\\r\\n        WHEN 7 THEN 'Julho'\\r\\n        WHEN 8 THEN 'Agosto'\\r\\n        WHEN 9 THEN 'Setembro'\\r\\n        WHEN 10 THEN 'Outubro'\\r\\n        WHEN 11 THEN 'Novembro'\\r\\n        WHEN 12 THEN 'Dezembro'\\r\\n    END AS nome_mes,\\r\\n    \\r\\n    COUNT(DISTINCT id_documento) AS qtd_fiscalizacoes,\\r\\n    COUNT(DISTINCT cnpj) AS qtd_empresas,\\r\\n    \\r\\n    -- Valores\\r\\n    ROUND(SUM(valor_total_infracao) / 1000000, 2) AS total_infracoes_milhoes,\\r\\n    ROUND(AVG(valor_total_infracao), 2) AS media_valor_infracao,\\r\\n    \\r\\n    -- Notifica\\u00e7\\u00f5es\\r\\n    SUM(gerou_notificacao) AS qtd_nfs,\\r\\n    ROUND(SUM(gerou_notificacao) * 100.0 / COUNT(DISTINCT id_documento), 2) AS taxa_conversao_pct,\\r\\n    \\r\\n    -- Tempo m\\u00e9dio\\r\\n    ROUND(AVG(dias_infracao_ate_nf), 0) AS media_dias_ate_nf\\r\\n    \\r\\nFROM teste.fisca_fiscalizacoes_consolidadas\\r\\nWHERE ano_infracao >= YEAR(CURRENT_DATE()) - 3\\r\\nGROUP BY MONTH(data_infracao)\\r\\nORDER BY mes;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- 6.3. EVOLU\\u00c7\\u00c3O MENSAL DOS \\u00daLTIMOS 24 MESES\\r\\n-- Objetivo: Tend\\u00eancia recente detalhada\\r\\nSELECT\\r\\n    '6.3. EVOLU\\u00c7\\u00c3O MENSAL \\u00daLTIMOS 24 MESES' AS consulta,\\r\\n    \\r\\n    YEAR(data_infracao) AS ano,\\r\\n    MONTH(data_infracao) AS mes,\\r\\n    CONCAT(CAST(YEAR(data_infracao) AS STRING), '-', \\r\\n           LPAD(CAST(MONTH(data_infracao) AS STRING), 2, '0')) AS ano_mes,\\r\\n    \\r\\n    COUNT(DISTINCT id_documento) AS qtd_fiscalizacoes,\\r\\n    COUNT(DISTINCT cnpj) AS qtd_empresas,\\r\\n    SUM(gerou_notificacao) AS qtd_nfs,\\r\\n    \\r\\n    -- Valores\\r\\n    ROUND(SUM(valor_total_infracao) / 1000000, 2) AS total_infracoes_milhoes,\\r\\n    ROUND(SUM(valor_total_nf) / 1000000, 2) AS total_nfs_milhoes,\\r\\n    \\r\\n    -- Taxas\\r\\n    ROUND(SUM(gerou_notificacao) * 100.0 / COUNT(DISTINCT id_documento), 2) AS taxa_conversao_pct,\\r\\n    \\r\\n    -- Tempos\\r\\n    ROUND(AVG(dias_infracao_ate_nf), 0) AS media_dias_ate_nf,\\r\\n    \\r\\n    -- Acumulado do ano\\r\\n    ROUND(SUM(SUM(valor_total_nf)) OVER (\\r\\n        PARTITION BY YEAR(data_infracao) \\r\\n        ORDER BY MONTH(data_infracao)\\r\\n        ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW\\r\\n    ) / 1000000, 2) AS acumulado_ano_milhoes\\r\\n    \\r\\nFROM teste.fisca_fiscalizacoes_consolidadas\\r\\nWHERE data_infracao >= ADD_MONTHS(CURRENT_DATE(), -24)\\r\\nGROUP BY YEAR(data_infracao), MONTH(data_infracao)\\r\\nORDER BY ano DESC, mes DESC;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- 6.4. AN\\u00c1LISE DE CORRELA\\u00c7\\u00c3O: SETOR vs EFETIVIDADE\\r\\n-- Objetivo: Identificar setores com melhor/pior efetividade\\r\\nSELECT\\r\\n    '6.4. EFETIVIDADE POR SETOR' AS consulta,\\r\\n    \\r\\n    fc.cnae_secao,\\r\\n    fc.cnae_secao_descricao,\\r\\n    \\r\\n    COUNT(DISTINCT fc.id_documento) AS qtd_fiscalizacoes,\\r\\n    COUNT(DISTINCT fc.cnpj) AS qtd_empresas,\\r\\n    \\r\\n    -- Valores\\r\\n    ROUND(SUM(fc.valor_total_infracao) / 1000000, 2) AS total_infracoes_milhoes,\\r\\n    ROUND(SUM(fc.valor_total_nf) / 1000000, 2) AS total_nfs_milhoes,\\r\\n    \\r\\n    -- Performance\\r\\n    ROUND(SUM(fc.gerou_notificacao) * 100.0 / COUNT(DISTINCT fc.id_documento), 2) AS taxa_conversao_pct,\\r\\n    ROUND(SUM(fc.ciclo_completo) * 100.0 / COUNT(DISTINCT fc.id_documento), 2) AS taxa_ciclo_completo_pct,\\r\\n    \\r\\n    -- Tempos\\r\\n    ROUND(AVG(fc.dias_infracao_ate_nf), 0) AS media_dias_ate_nf,\\r\\n    \\r\\n    -- Scores de Efetividade\\r\\n    ROUND(AVG(se.score_efetividade_final), 1) AS score_medio_efetividade,\\r\\n    ROUND(AVG(se.score_tempestividade), 1) AS score_medio_tempestividade,\\r\\n    ROUND(AVG(se.score_valor_notificado), 1) AS score_medio_valor,\\r\\n    \\r\\n    -- Distribui\\u00e7\\u00e3o de classifica\\u00e7\\u00e3o\\r\\n    COUNT(CASE WHEN se.classificacao_efetividade = 'MUITO EFETIVA' THEN 1 END) AS qtd_muito_efetiva,\\r\\n    COUNT(CASE WHEN se.classificacao_efetividade = 'EFETIVA' THEN 1 END) AS qtd_efetiva,\\r\\n    COUNT(CASE WHEN se.classificacao_efetividade = 'MODERADAMENTE EFETIVA' THEN 1 END) AS qtd_moderada,\\r\\n    COUNT(CASE WHEN se.classificacao_efetividade = 'POUCO EFETIVA' THEN 1 END) AS qtd_pouco_efetiva\\r\\n    \\r\\nFROM teste.fisca_fiscalizacoes_consolidadas fc\\r\\nLEFT JOIN teste.fisca_scores_efetividade se\\r\\n    ON fc.id_documento = se.id_documento\\r\\nWHERE fc.cnae_secao IS NOT NULL\\r\\n    AND fc.ano_infracao >= YEAR(CURRENT_DATE()) - 3\\r\\nGROUP BY fc.cnae_secao, fc.cnae_secao_descricao\\r\\nHAVING COUNT(DISTINCT fc.id_documento) >= 20  -- M\\u00ednimo 20 fiscaliza\\u00e7\\u00f5es\\r\\nORDER BY AVG(se.score_efetividade_final) DESC;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- ============================================================================\\r\\n-- SE\\u00c7\\u00c3O 7: ALERTAS E PRIORIDADES\\r\\n-- ============================================================================\\r\\n\\r\\n-- 7.1. FISCALIZA\\u00c7\\u00d5ES EM ANDAMENTO - SITUA\\u00c7\\u00c3O CR\\u00cdTICA\\r\\n-- Objetivo: Identificar casos que precisam de aten\\u00e7\\u00e3o\\r\\nSELECT\\r\\n    '7.1. FISCALIZA\\u00c7\\u00d5ES CR\\u00cdTICAS EM ANDAMENTO' AS consulta,\\r\\n    \\r\\n    ROW_NUMBER() OVER (ORDER BY \\r\\n        CASE \\r\\n            WHEN fc.data_infracao < ADD_MONTHS(CURRENT_DATE(), -12) THEN 1\\r\\n            WHEN fc.valor_total_infracao >= 500000 AND fc.gerou_notificacao = 0 THEN 2\\r\\n            WHEN fc.data_infracao < ADD_MONTHS(CURRENT_DATE(), -6) THEN 3\\r\\n            ELSE 4\\r\\n        END,\\r\\n        fc.valor_total_infracao DESC\\r\\n    ) AS prioridade,\\r\\n    \\r\\n    fc.cnpj,\\r\\n    fc.nm_razao_social,\\r\\n    fc.municipio,\\r\\n    fc.gerfe,\\r\\n    \\r\\n    -- Fiscaliza\\u00e7\\u00e3o\\r\\n    fc.numero_infracao,\\r\\n    fc.data_infracao,\\r\\n    DATEDIFF(CURRENT_DATE(), fc.data_infracao) AS dias_desde_infracao,\\r\\n    \\r\\n    -- Valores\\r\\n    ROUND(fc.valor_total_infracao / 1000, 2) AS valor_infracao_milhares,\\r\\n    \\r\\n    -- Situa\\u00e7\\u00e3o\\r\\n    fc.situacao_final,\\r\\n    fc.gerou_notificacao,\\r\\n    \\r\\n    -- Alerta\\r\\n    CASE \\r\\n        WHEN fc.data_infracao < ADD_MONTHS(CURRENT_DATE(), -12) \\r\\n        THEN 'CR\\u00cdTICO: > 12 MESES SEM NOTIFICA\\u00c7\\u00c3O'\\r\\n        \\r\\n        WHEN fc.valor_total_infracao >= 500000 AND fc.gerou_notificacao = 0 \\r\\n        THEN 'CR\\u00cdTICO: ALTO VALOR SEM NOTIFICA\\u00c7\\u00c3O'\\r\\n        \\r\\n        WHEN fc.data_infracao < ADD_MONTHS(CURRENT_DATE(), -6) \\r\\n        THEN 'ALTO: > 6 MESES SEM NOTIFICA\\u00c7\\u00c3O'\\r\\n        \\r\\n        WHEN fc.data_infracao < ADD_MONTHS(CURRENT_DATE(), -3) \\r\\n        THEN 'M\\u00c9DIO: > 3 MESES SEM NOTIFICA\\u00c7\\u00c3O'\\r\\n        \\r\\n        ELSE 'MONITORAMENTO: < 3 MESES'\\r\\n    END AS tipo_alerta,\\r\\n    \\r\\n    -- A\\u00e7\\u00e3o Sugerida\\r\\n    CASE \\r\\n        WHEN fc.data_infracao < ADD_MONTHS(CURRENT_DATE(), -12) \\r\\n        THEN 'URGENTE: Verificar motivo da demora e priorizar emiss\\u00e3o'\\r\\n        \\r\\n        WHEN fc.valor_total_infracao >= 500000 AND fc.gerou_notificacao = 0 \\r\\n        THEN 'URGENTE: Priorizar por alto impacto financeiro'\\r\\n        \\r\\n        WHEN fc.data_infracao < ADD_MONTHS(CURRENT_DATE(), -6) \\r\\n        THEN 'Acelerar processo de notifica\\u00e7\\u00e3o'\\r\\n        \\r\\n        ELSE 'Acompanhar evolu\\u00e7\\u00e3o normal'\\r\\n    END AS acao_sugerida\\r\\n    \\r\\nFROM teste.fisca_fiscalizacoes_consolidadas fc\\r\\nWHERE fc.gerou_notificacao = 0\\r\\n    AND fc.data_infracao >= ADD_MONTHS(CURRENT_DATE(), -24)\\r\\nORDER BY prioridade, fc.valor_total_infracao DESC\\r\\nLIMIT 100;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- 7.2. EMPRESAS COM PADR\\u00c3O DE ALTO RISCO\\r\\n-- Objetivo: Identificar contribuintes problem\\u00e1ticos\\r\\nSELECT\\r\\n    '7.2. EMPRESAS COM PADR\\u00c3O DE ALTO RISCO' AS consulta,\\r\\n    \\r\\n    fc.cnpj,\\r\\n    fc.nm_razao_social,\\r\\n    fc.municipio,\\r\\n    fc.regime_tributario,\\r\\n    fc.cnae_secao_descricao,\\r\\n    \\r\\n    COUNT(DISTINCT fc.id_documento) AS qtd_fiscalizacoes,\\r\\n    COUNT(DISTINCT fc.ano_infracao) AS qtd_anos_distintos,\\r\\n    \\r\\n    -- Valores\\r\\n    ROUND(SUM(fc.valor_total_infracao) / 1000, 2) AS total_infracoes_milhares,\\r\\n    ROUND(AVG(fc.valor_total_infracao), 2) AS media_por_fiscalizacao,\\r\\n    \\r\\n    -- Performance\\r\\n    ROUND(SUM(fc.gerou_notificacao) * 100.0 / COUNT(DISTINCT fc.id_documento), 2) AS taxa_conversao_pct,\\r\\n    \\r\\n    -- Tipos de infra\\u00e7\\u00f5es\\r\\n    COUNT(DISTINCT fc.tipo_infracao) AS tipos_infracoes_distintas,\\r\\n    \\r\\n    -- Temporalidade\\r\\n    MIN(fc.data_infracao) AS primeira_fiscalizacao,\\r\\n    MAX(fc.data_infracao) AS ultima_fiscalizacao,\\r\\n    DATEDIFF(MAX(fc.data_infracao), MIN(fc.data_infracao)) AS dias_entre_primeira_ultima,\\r\\n    \\r\\n    -- Score de Risco\\r\\n    CASE \\r\\n        WHEN COUNT(DISTINCT fc.id_documento) >= 5 AND \\r\\n             SUM(fc.valor_total_infracao) >= 1000000 AND\\r\\n             COUNT(DISTINCT fc.ano_infracao) >= 3 \\r\\n        THEN 'RISCO CR\\u00cdTICO'\\r\\n        \\r\\n        WHEN COUNT(DISTINCT fc.id_documento) >= 3 AND \\r\\n             SUM(fc.valor_total_infracao) >= 500000 \\r\\n        THEN 'RISCO ALTO'\\r\\n        \\r\\n        WHEN COUNT(DISTINCT fc.id_documento) >= 3 OR \\r\\n             SUM(fc.valor_total_infracao) >= 300000 \\r\\n        THEN 'RISCO MODERADO'\\r\\n        \\r\\n        ELSE 'RISCO BAIXO'\\r\\n    END AS classificacao_risco,\\r\\n    \\r\\n    -- Recomenda\\u00e7\\u00e3o\\r\\n    CASE \\r\\n        WHEN COUNT(DISTINCT fc.id_documento) >= 5 \\r\\n        THEN 'Indicar para Grupo Especial de Fiscaliza\\u00e7\\u00e3o'\\r\\n        \\r\\n        WHEN COUNT(DISTINCT fc.ano_infracao) >= 3 \\r\\n        THEN 'Acompanhamento Cont\\u00ednuo Obrigat\\u00f3rio'\\r\\n        \\r\\n        WHEN SUM(fc.valor_total_infracao) >= 1000000 \\r\\n        THEN 'Priorizar Fechamento dos Casos Pendentes'\\r\\n        \\r\\n        ELSE 'Monitoramento Regular'\\r\\n    END AS recomendacao\\r\\n    \\r\\nFROM teste.fisca_fiscalizacoes_consolidadas fc\\r\\nWHERE fc.ano_infracao >= YEAR(CURRENT_DATE()) - 5\\r\\nGROUP BY fc.cnpj, fc.nm_razao_social, fc.municipio, fc.regime_tributario, fc.cnae_secao_descricao\\r\\nHAVING COUNT(DISTINCT fc.id_documento) >= 3\\r\\n    OR SUM(fc.valor_total_infracao) >= 300000\\r\\nORDER BY \\r\\n    CASE \\r\\n        WHEN COUNT(DISTINCT fc.id_documento) >= 5 AND SUM(fc.valor_total_infracao) >= 1000000 THEN 1\\r\\n        WHEN COUNT(DISTINCT fc.id_documento) >= 3 AND SUM(fc.valor_total_infracao) >= 500000 THEN 2\\r\\n        ELSE 3\\r\\n    END,\\r\\n    SUM(fc.valor_total_infracao) DESC\\r\\nLIMIT 50;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- ============================================================================\\r\\n-- SE\\u00c7\\u00c3O 8: DASHBOARD COMPARATIVO - BENCHMARKS\\r\\n-- ============================================================================\\r\\n\\r\\n-- 8.1. COMPARATIVO DE GER\\u00caNCIAS (RANKING)\\r\\n-- Objetivo: Benchmark entre ger\\u00eancias regionais\\r\\nWITH ranking_gerencias AS (\\r\\n    SELECT\\r\\n        gerfe,\\r\\n        ano_infracao,\\r\\n        COUNT(DISTINCT id_documento) AS qtd_fiscalizacoes,\\r\\n        SUM(gerou_notificacao) AS qtd_nfs,\\r\\n        ROUND(SUM(valor_total_nf) / 1000000, 2) AS total_lancado_milhoes,\\r\\n        ROUND(SUM(gerou_notificacao) * 100.0 / COUNT(DISTINCT id_documento), 2) AS taxa_conversao,\\r\\n        ROUND(AVG(dias_infracao_ate_nf), 0) AS media_dias\\r\\n    FROM teste.fisca_fiscalizacoes_consolidadas\\r\\n    WHERE gerfe IS NOT NULL\\r\\n        AND ano_infracao >= YEAR(CURRENT_DATE()) - 2\\r\\n    GROUP BY gerfe, ano_infracao\\r\\n),\\r\\nstats_gerais AS (\\r\\n    SELECT\\r\\n        ano_infracao,\\r\\n        AVG(taxa_conversao) AS media_geral_taxa,\\r\\n        AVG(media_dias) AS media_geral_dias,\\r\\n        AVG(total_lancado_milhoes) AS media_geral_valor\\r\\n    FROM ranking_gerencias\\r\\n    GROUP BY ano_infracao\\r\\n)\\r\\nSELECT\\r\\n    '8.1. RANKING E BENCHMARK DE GER\\u00caNCIAS' AS consulta,\\r\\n    \\r\\n    rg.gerfe,\\r\\n    rg.ano_infracao,\\r\\n    \\r\\n    -- Volumes\\r\\n    rg.qtd_fiscalizacoes,\\r\\n    rg.qtd_nfs,\\r\\n    rg.total_lancado_milhoes,\\r\\n    \\r\\n    -- Performance\\r\\n    rg.taxa_conversao AS taxa_conversao_pct,\\r\\n    ROUND(rg.taxa_conversao - sg.media_geral_taxa, 2) AS diferenca_vs_media_taxa,\\r\\n    \\r\\n    rg.media_dias,\\r\\n    ROUND(rg.media_dias - sg.media_geral_dias, 0) AS diferenca_vs_media_dias,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o\\r\\n    ROW_NUMBER() OVER (PARTITION BY rg.ano_infracao ORDER BY rg.total_lancado_milhoes DESC) AS ranking_valor,\\r\\n    ROW_NUMBER() OVER (PARTITION BY rg.ano_infracao ORDER BY rg.taxa_conversao DESC) AS ranking_conversao,\\r\\n    ROW_NUMBER() OVER (PARTITION BY rg.ano_infracao ORDER BY rg.media_dias ASC) AS ranking_tempestividade,\\r\\n    \\r\\n    -- M\\u00e9dias Gerais (para compara\\u00e7\\u00e3o)\\r\\n    sg.media_geral_taxa AS media_taxa_todas_gerencias,\\r\\n    sg.media_geral_dias AS media_dias_todas_gerencias,\\r\\n    sg.media_geral_valor AS media_valor_todas_gerencias\\r\\n    \\r\\nFROM ranking_gerencias rg\\r\\nINNER JOIN stats_gerais sg ON rg.ano_infracao = sg.ano_infracao\\r\\nORDER BY rg.ano_infracao DESC, rg.total_lancado_milhoes DESC;\\r\\n\\r\\n-- ============================================================================\\r\\n-- FIM DAS CONSULTAS ANAL\\u00cdTICAS - PROJETO FISCA\\r\\n-- ============================================================================\", \"lastExecutedSelectionRange\": {\"start\": {\"row\": 598, \"column\": 0}, \"end\": {\"row\": 1168, \"column\": 79}}, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"lastCheckStatusRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"query_status\\\": {\\\"status\\\": \\\"available\\\"}}\", \"responseJSON\": {\"status\": 0, \"query_status\": {\"status\": \"available\"}}, \"status\": 200, \"statusText\": \"OK\"}, \"lastGetLogsRequest\": {\"readyState\": 0, \"status\": 0, \"statusText\": \"abort\"}}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 12020, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 173, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": null, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false}",
    "extra": "",
    "search": "-- ============================================================================\r\n-- SISTEMA DE CONSULTAS ANALÍTICAS - PROJETO FISCA\r\n-- Análise Completa de Fiscalizações da Receita Estadual de SC\r\n-- Database: teste.fisca_*\r\n-- VERSÃO CORRIGIDA - Tipos TINYINT ajustados\r\n-- ============================================================================\r\n\r\nSET REQUEST_POOL = 'medium';\r\nSET MEM_LIMIT = 8G;\r\n\r\n-- ============================================================================\r\n-- SEÇÃO 1: ESTATÍSTICAS GERAIS DO PROJETO (VISÃO EXECUTIVA)\r\n-- ============================================================================\r\n\r\n-- 1.1. PANORAMA GERAL DO PROJETO FISCA\r\n-- Objetivo: Visão executiva completa das fiscalizações\r\nSELECT\r\n    '1.1. PANORAMA GERAL FISCA' AS consulta,\r\n    \r\n    -- Período de Análise\r\n    MIN(ano_infracao) AS ano_inicial,\r\n    MAX(ano_infracao) AS ano_final,\r\n    \r\n    -- Métricas de Volume - Infrações (BASE)\r\n    COUNT(DISTINCT id_documento) AS total_infracoes_lavradas,\r\n    COUNT(DISTINCT cnpj) AS total_empresas_fiscalizadas,\r\n    COUNT(DISTINCT numero_infracao) AS total_numeros_infracao,\r\n    \r\n    -- Notificações Fiscais\r\n    SUM(gerou_notificacao) AS total_nfs_emitidas,\r\n    COUNT(DISTINCT CASE WHEN gerou_notificacao = 1 THEN cnpj END) AS empresas_notificadas,\r\n    \r\n    -- Encerramentos\r\n    SUM(teve_encerramento) AS total_encerramentos,\r\n    SUM(teve_resultados) AS encerramentos_com_resultado,\r\n    SUM(ciclo_completo) AS total_ciclos_completos,\r\n    \r\n    -- Métricas Financeiras - Infrações\r\n    ROUND(SUM(valor_total_infracao) / 1000000000, 2) AS valor_total_infracoes_bilhoes,\r\n    ROUND(SUM(valor_imposto_infracao) / 1000000000, 2) AS valor_imposto_bilhoes,\r\n    ROUND(SUM(valor_multa_infracao) / 1000000000, 2) AS valor_multa_bilhoes,\r\n    \r\n    -- Métricas Financeiras - NFs\r\n    ROUND(SUM(valor_total_nf) / 1000000000, 2) AS valor_total_nfs_bilhoes,\r\n    \r\n    -- Taxas de Conversão\r\n    ROUND(SUM(gerou_notificacao) * 100.0 / COUNT(DISTIN",
    "last_modified": "2025-10-30T14:07:25.366",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "a86f6c3d-3609-4f13-ab12-271973ad5b68",
      1,
      false
    ],
    "dependencies": []
  }
}
]
